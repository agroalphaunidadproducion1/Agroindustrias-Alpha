<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cuadro de Aplicaciones</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e5f3e9;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #2d563a;
    }
    form {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 1rem 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .field {
      margin-bottom: 1rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 0.3rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      background-color: #3f704d;
      color: white;
      padding: 0.7rem 2rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #2d563a;
    }
  </style>
</head>
<body>
  <h1>Cuadro de Aplicaciones</h1>
  <form id="form">
    <div class="field"><label>Fecha</label><input type="date" id="fecha" required></div>
    <div class="field"><label>Invernadero</label><input type="text" id="inv" required></div>
    <div class="field"><label>Cultivo</label>
      <select id="cultivo" required>
        <option value="">Seleccionar</option>
        <option value="Chile">Chile</option>
        <option value="Tomate">Tomate</option>
      </select>
    </div>
    <div class="field"><label>Producto</label>
      <select id="producto" required></select>
    </div>
    <div class="field"><label>Dosis Máxima (kg o lts/Ha)</label><input type="number" id="dosisMax" readonly></div>
    <div class="field"><label>Unidad</label>
      <select id="unidad" required>
        <option value="kg">kg</option>
        <option value="lt">lt</option>
      </select>
    </div>
    <div class="field"><label>Dosis/Litro (gr o ml)</label><input type="number" id="dosisLitro" readonly></div>
    <div class="field"><label>Días a Cosecha</label><input type="number" id="diasCosecha" required></div>
    <div class="field"><label>Tiempo de Reingreso</label><input type="text" id="tiempoReingreso"></div>
    <div class="field"><label>Cantidad Aplicada (kg o lts)</label><input type="number" id="cantidadAplicada"></div>
    <div class="field"><label>Área Aplicada (Ha)</label><input type="number" id="areaAplicada"></div>
    <div class="field"><label>Nº Capillas Aplicadas</label><input type="number" id="numCapillas"></div>
    <div class="field"><label>Capillas Aplicadas</label><input type="text" id="capillas"></div>
    <div class="field"><label>Volumen de Agua (lts)</label><input type="number" id="volumenAgua"></div>
    <div class="field"><label>Hora de Aplicación</label><input type="time" id="horaAplicacion" required></div>
    <div class="field"><label>Libre</label><input type="date" id="libre" readonly></div>
    <div class="field"><label>Observaciones</label><textarea id="observaciones"></textarea></div>
    <button type="submit">Guardar</button>
  </form>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Configuración de tu Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCuCuRAx8fMTPp3cNKhRYjUXn-UWmZXTlU",
      authDomain: "agro-productos.firebaseapp.com",
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com",
      projectId: "agro-productos",
      storageBucket: "agro-productos.appspot.com",
      messagingSenderId: "896964881925",
      appId: "1:896964881925:web:e24cb1f3038ef3f812f540"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const productoSelect = document.getElementById("producto");
    const dosisMaxInput = document.getElementById("dosisMax");
    const dosisLitroInput = document.getElementById("dosisLitro");

    // Cargar productos desde Firebase
    firebase.database().ref("productos").on("value", snapshot => {
      productoSelect.innerHTML = '<option value="">Seleccionar producto</option>';
      snapshot.forEach(child => {
        const nombre = child.val().nombre;
        const option = document.createElement("option");
        option.value = nombre;
        option.textContent = nombre;
        productoSelect.appendChild(option);
      });
    });

    // Llenar dosis automáticamente
    productoSelect.addEventListener("change", () => {
      const nombreProducto = productoSelect.value;
      firebase.database().ref("productos").orderByChild("nombre").equalTo(nombreProducto).once("value", snapshot => {
        snapshot.forEach(child => {
          const data = child.val();
          dosisMaxInput.value = data.dosisMaxima || "";
          dosisLitroInput.value = data.dosisLitro || "";
        });
      });
    });

    const fecha = document.getElementById("fecha");
    const diasCosecha = document.getElementById("diasCosecha");
    const horaAplicacion = document.getElementById("horaAplicacion");
    const libre = document.getElementById("libre");

    function calcularFechaLibre() {
      const fechaAplicacion = new Date(fecha.value);
      const dias = parseInt(diasCosecha.value || "0", 10);
      const hora = horaAplicacion.value;

      if (isNaN(fechaAplicacion.getTime())) return;

      let fechaLibre = new Date(fechaAplicacion);
      fechaLibre.setDate(fechaLibre.getDate() + dias);

      if (hora) {
        const [h] = hora.split(":").map(Number);
        if (h >= 12) {
          fechaLibre.setDate(fechaLibre.getDate() + 1);
        }
      }

      const yyyy = fechaLibre.getFullYear();
      const mm = String(fechaLibre.getMonth() + 1).padStart(2, "0");
      const dd = String(fechaLibre.getDate()).padStart(2, "0");
      libre.value = `${yyyy}-${mm}-${dd}`;
    }

    diasCosecha.addEventListener("input", calcularFechaLibre);
    horaAplicacion.addEventListener("change", calcularFechaLibre);
    fecha.addEventListener("change", calcularFechaLibre);

    // Guardar en Firebase
    document.getElementById("form").addEventListener("submit", (e) => {
      e.preventDefault();
      const datos = {
        fecha: fecha.value,
        inv: inv.value,
        cultivo: cultivo.value,
        producto: productoSelect.value,
        dosisMax: dosisMaxInput.value,
        unidad: unidad.value,
        dosisLitro: dosisLitroInput.value,
        diasCosecha: diasCosecha.value,
        tiempoReingreso: tiempoReingreso.value,
        cantidadAplicada: cantidadAplicada.value,
        areaAplicada: areaAplicada.value,
        numCapillas: numCapillas.value,
        capillas: capillas.value,
        volumenAgua: volumenAgua.value,
        horaAplicacion: horaAplicacion.value,
        libre: libre.value,
        observaciones: observaciones.value
      };
      db.ref("aplicaciones").push(datos);
      alert("Aplicación guardada correctamente");
      document.getElementById("form").reset();
    });
  </script>
</body>
</html>