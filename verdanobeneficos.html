<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluaci√≥n de Organismos Ben√©ficos</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --primary-color: #2e7d32;
      --primary-hover: #1b5e20;
      --light-bg: #e8f5e9;
      --light-border: #a5d6a7;
      --table-header: #c8e6c9;
      --white: #ffffff;
      --row-hover: #f1f8e9;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: var(--light-bg);
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    h2 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 20px;
      padding: 10px;
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .controls-container {
      background-color: var(--white);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .filtros-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    
    .filtro-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 150px;
    }
    
    .filtro-label {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--primary-color);
      font-size: 14px;
    }
    
    input, select {
      padding: 10px;
      border: 1px solid var(--light-border);
      border-radius: 5px;
      font-size: 14px;
      background-color: var(--white);
    }
    
    .acciones {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-top: 15px;
      gap: 10px;
    }
    
    button {
      padding: 10px 15px;
      background-color: var(--primary-color);
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    button:hover {
      background-color: var(--primary-hover);
    }
    
    .btn-leyenda {
      background-color: #5c6bc0;
    }
    
    .btn-leyenda:hover {
      background-color: #3f51b5;
    }
    
    .btn-descarga {
      background-color: #7b1fa2;
    }
    
    .btn-descarga:hover {
      background-color: #6a1b9a;
    }
    
    .table-container {
      width: 100%;
      overflow-x: auto;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    
    th {
      background-color: var(--table-header);
      color: var(--primary-hover);
      padding: 12px 8px;
      border: 1px solid var(--light-border);
      text-align: center;
      position: sticky;
      top: 0;
      font-size: 14px;
    }
    
    td {
      padding: 10px 8px;
      border: 1px solid var(--light-border);
      text-align: center;
      font-size: 14px;
    }
    
    tr:nth-child(even) {
      background-color: var(--row-hover);
    }
    
    tr:hover {
      background-color: #e8f5e9;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      font-style: italic;
      color: var(--primary-color);
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 0.9em;
      padding: 15px;
    }
    
    .no-data {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .modal-small {
      max-width: 400px;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    
    .modal-section {
      margin-bottom: 20px;
    }
    
    .modal-section h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      border-bottom: 1px solid var(--light-border);
      padding-bottom: 5px;
    }
    
    .modal-list {
      list-style-type: none;
    }
    
    .modal-list li {
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }
    
    .modal-list li:before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: var(--primary-color);
    }
    
    .abejorros-acciones {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .accion-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .descarga-opciones {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .descarga-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background-color: #f5f5f5;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .descarga-btn:hover {
      background-color: #e8f5e9;
    }
    
    .descarga-icono {
      font-size: 20px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .filtros-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filtro-group {
        min-width: 100%;
      }
      
      .acciones {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      button {
        flex: 1;
        min-width: 120px;
        justify-content: center;
      }
      
      th, td {
        padding: 8px 5px;
        font-size: 12px;
      }
      
      .header-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .header-buttons {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      .controls-container {
        padding: 10px;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 15px;
      }
      
      .header-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>

  <div class="header-container">
    <h2>üåø Evaluaci√≥n de Organismos Ben√©ficos</h2>
    <div class="header-buttons">
      <button class="btn-leyenda" onclick="mostrarLeyenda()"><span>üìñ</span> Leyenda</button>
      <button class="btn-descarga" onclick="mostrarModalDescargas()"><span>üì•</span> Descargar</button>
    </div>
  </div>

  <div class="controls-container">
    <div class="filtros-container">
      <div class="filtro-group">
        <label class="filtro-label" for="filtro-benefico">Organismo:</label>
        <select id="filtro-benefico">
          <option value="">Todos los organismos</option>
          <option value="swirskii">A. Swirskii</option>
          <option value="cucumeris">N. Cucumeris</option>
          <option value="crizopa">Crizopa</option>
          <option value="colemani">Aphidius Colemani</option>
          <option value="abejorros">Abejorros</option>
        </select>
      </div>
      
      <div class="filtro-group">
        <label class="filtro-label" for="filtro-categoria">Categor√≠a:</label>
        <select id="filtro-categoria">
          <option value="">Todas las categor√≠as</option>
          <option value="Fungicida">Fungicida</option>
          <option value="Insecticida">Insecticida</option>
          <option value="Herbicida">Herbicida</option>
          <option value="Acaricida">Acaricida</option>
          <option value="Bactericida">Bactericida</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      
      <div class="filtro-group">
        <label class="filtro-label" for="buscador">Buscar:</label>
        <input type="text" id="buscador" placeholder="Producto o ingrediente...">
      </div>
    </div>
  </div>

  <div class="table-container">
    <table id="tablaRegistros">
      <thead>
        <tr id="tabla-header">
          <th>Producto</th>
          <th>Ingrediente</th>
          <!-- Las columnas din√°micas se agregar√°n aqu√≠ -->
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="2" class="loading">Cargando datos...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    <p>Sistema Agroalpha ¬© 2025 | Unidad produccion 1</p>
    <p>Versi√≥n 2.0 - M√≥dulo completo</p>
  </div>

  <!-- Modal de Leyenda -->
  <div id="modalLeyenda" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarLeyenda()">&times;</span>
      <h2>Leyenda</h2>
      
      <div class="modal-section">
        <h3>Efectos</h3>
        <ul class="modal-list">
          <li><strong>1</strong> = inofensivo o ligeramente perjudicial &lt; 25% de reducci√≥n</li>
          <li><strong>2</strong> = moderadamente perjudicial reducci√≥n del 25% - 50%</li>
          <li><strong>3</strong> = reducci√≥n perjudicial del 50% - 75%</li>
          <li><strong>4</strong> = muy perjudicial &gt; 75% de reducci√≥n</li>
          <li><strong>5</strong> = efecto/persistencia desconocidos</li>
        </ul>
      </div>
      
      <div class="modal-section">
        <h3>Abejorros</h3>
        <div class="abejorros-acciones">
          <div class="accion-item">
            <input type="checkbox" disabled> 
            <span>Ninguna acci√≥n</span>
          </div>
          <div class="accion-item">
            <input type="checkbox" checked disabled> 
            <span>Cubrir colmena</span>
          </div>
          <div class="accion-item">
            <input type="checkbox" disabled> 
            <span>Retirar</span>
          </div>
          <div class="accion-item">
            <input type="checkbox" checked disabled> 
            <span>Incompatible</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal of Descargas -->
  <div id="modalDescargas" class="modal">
    <div class="modal-content modal-small">
      <span class="close" onclick="cerrarModalDescargas()">&times;</span>
      <h2>Opciones de Descarga</h2>
      
      <div class="descarga-opciones">
        <div class="descarga-btn" onclick="descargarCSV()">
          <span class="descarga-icono">üìä</span>
          <span>Descargar como CSV</span>
        </div>
        
        <div class="descarga-btn" onclick="descargarImagen()">
          <span class="descarga-icono">üñºÔ∏è</span>
          <span>Descargar como Imagen</span>
        </div>
        
        <div class="descarga-btn" onclick="window.print()">
          <span class="descarga-icono">üñ®Ô∏è</span>
          <span>Imprimir Tabla</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com/"
    };
    
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tablaBody = document.querySelector("#tablaRegistros tbody");
    const tablaHeader = document.getElementById("tabla-header");
    const buscador = document.getElementById("buscador");
    const filtroCategoria = document.getElementById("filtro-categoria");
    const filtroBenefico = document.getElementById("filtro-benefico");
    const modalLeyenda = document.getElementById("modalLeyenda");
    const modalDescargas = document.getElementById("modalDescargas");
    let registros = [];

    // Funci√≥n para mostrar el modal de leyenda
    function mostrarLeyenda() {
      modalLeyenda.style.display = "block";
    }

    // Funci√≥n para cerrar el modal de leyenda
    function cerrarLeyenda() {
      modalLeyenda.style.display = "none";
    }

    // Funci√≥n para mostrar el modal de descargas
    function mostrarModalDescargas() {
      modalDescargas.style.display = "block";
    }

    // Funci√≥n para cerrar el modal de descargas
    function cerrarModalDescargas() {
      modalDescargas.style.display = "none";
    }

    // Cerrar el modal al hacer clic fuera de √©l
    window.onclick = function(event) {
      if (event.target == modalLeyenda) {
        cerrarLeyenda();
      }
      if (event.target == modalDescargas) {
        cerrarModalDescargas();
      }
    }

    // Funci√≥n para cargar datos de Firebase
    function cargarDatos() {
      db.ref("da√±obeneficos").once("value")
        .then((snapshot) => {
          registros = [];
          snapshot.forEach((childSnapshot) => {
            const registro = childSnapshot.val();
            // Agregar el ID del registro como referencia
            registro.id = childSnapshot.key;
            registros.push(registro);
          });
          
          // Ordenar registros alfab√©ticamente por nombre de producto
          registros.sort((a, b) => {
            const nombreA = a.producto || '';
            const nombreB = b.producto || '';
            return nombreA.localeCompare(nombreB, 'es', { sensitivity: 'base' });
          });
          
          mostrarFiltrados();
        })
        .catch((error) => {
          console.error("Error al cargar datos:", error);
          tablaBody.innerHTML = `
            <tr>
              <td colspan="10" style="color: red; text-align: center;">
                Error al cargar datos. Por favor recarga la p√°gina.
              </td>
            </tr>
          `;
        });
    }

    // Escuchar cambios en los datos
    db.ref("da√±obeneficos").on("value", (snapshot) => {
      registros = [];
      snapshot.forEach((childSnapshot) => {
        const registro = childSnapshot.val();
        registro.id = childSnapshot.key;
        registros.push(registro);
      });
      
      // Ordenar registros alfab√©ticamente por nombre de producto
      registros.sort((a, b) => {
        const nombreA = a.producto || '';
        const nombreB = b.producto || '';
        return nombreA.localeCompare(nombreB, 'es', { sensitivity: 'base' });
      });
      
      mostrarFiltrados();
    });

    // Funci√≥n para verificar si un registro tiene datos relevantes (no solo "Sin efecto")
    function tieneDatosRelevantes(registro, beneficoFiltro) {
      if (!beneficoFiltro) {
        // Verificar todos los ben√©ficos
        return (
          (registro.swirskii_larva && registro.swirskii_larva !== "0") ||
          (registro.swirskii_adulto && registro.swirskii_adulto !== "0") ||
          (registro.swirskii_huevo && registro.swirskii_huevo !== "0") ||
          (registro.swirskii_ninfa && registro.swirskii_ninfa !== "0") ||
          (registro.cucumeris_larva && registro.cucumeris_larva !== "0") ||
          (registro.cucumeris_adulto && registro.cucumeris_adulto !== "0") ||
          (registro.cucumeris_huevo && registro.cucumeris_huevo !== "0") ||
          (registro.cucumeris_ninfa && registro.cucumeris_ninfa !== "0") ||
          (registro.crizopa_larva && registro.crizopa_larva !== "0") ||
          (registro.crizopa_adulto && registro.crizopa_adulto !== "0") ||
          (registro.crizopa_huevo && registro.crizopa_huevo !== "0") ||
          (registro.crizopa_ninfa && registro.crizopa_ninfa !== "0") ||
          (registro.colemani_larva && registro.colemani_larva !== "0") ||
          (registro.colemani_adulto && registro.colemani_adulto !== "0") ||
          (registro.colemani_huevo && registro.colemani_huevo !== "0") ||
          (registro.colemani_ninfa && registro.colemani_ninfa !== "0") ||
          (registro.abejorros_accion && registro.abejorros_accion !== "ninguna")
        );
      } else {
        // Verificar solo el ben√©fico seleccionado
        switch(beneficoFiltro) {
          case "swirskii":
            return (
              (registro.swirskii_larva && registro.swirskii_larva !== "0") ||
              (registro.swirskii_adulto && registro.swirskii_adulto !== "0") ||
              (registro.swirskii_huevo && registro.swirskii_huevo !== "0") ||
              (registro.swirskii_ninfa && registro.swirskii_ninfa !== "0")
            );
          case "cucumeris":
            return (
              (registro.cucumeris_larva && registro.cucumeris_larva !== "0") ||
              (registro.cucumeris_adulto && registro.cucumeris_adulto !== "0") ||
              (registro.cucumeris_huevo && registro.cucumeris_huevo !== "0") ||
              (registro.cucumeris_ninfa && registro.cucumeris_ninfa !== "0")
            );
          case "crizopa":
            return (
              (registro.crizopa_larva && registro.crizopa_larva !== "0") ||
              (registro.crizopa_adulto && registro.crizopa_adulto !== "0") ||
              (registro.crizopa_huevo && registro.crizopa_huevo !== "0") ||
              (registro.crizopa_ninfa && registro.crizopa_ninfa !== "0")
            );
          case "colemani":
            return (
              (registro.colemani_larva && registro.colemani_larva !== "0") ||
              (registro.colemani_adulto && registro.colemani_adulto !== "0") ||
              (registro.colemani_huevo && registro.colemani_huevo !== "0") ||
              (registro.colemani_ninfa && registro.colemani_ninfa !== "0")
            );
          case "abejorros":
            return (
              (registro.abejorros_accion && registro.abejorros_accion !== "ninguna")
            );
        }
      }
      return true;
    }

    // Filtrar registros seg√∫n b√∫squeda
    function mostrarFiltrados() {
      const textoFiltro = buscador.value.toLowerCase();
      const categoriaFiltro = filtroCategoria.value;
      const beneficoFiltro = filtroBenefico.value;
      
      if (registros.length === 0) {
        tablaBody.innerHTML = `
          <tr>
            <td colspan="10" class="no-data">
              No hay registros disponibles
            </td>
          </tr>
        `;
        return;
      }
      
      const registrosFiltrados = registros.filter(r => {
        // Filtrar por categor√≠a
        if (categoriaFiltro && r.categoria !== categoriaFiltro) {
          return false;
        }
        
        // Filtrar por texto (producto o ingrediente)
        if (textoFiltro) {
          const producto = r.producto?.toString().toLowerCase() || "";
          const ingrediente = r.ingrediente?.toString().toLowerCase() || "";
          if (!producto.includes(textoFiltro) && !ingrediente.includes(textoFiltro)) {
            return false;
          }
        }
        
        // Filtrar registros que solo tengan "Sin efecto"
        return tieneDatosRelevantes(r, beneficoFiltro);
      });
      
      if (registrosFiltrados.length === 0) {
        tablaBody.innerHTML = `
          <tr>
            <td colspan="10" class="no-data">
              No se encontraron registros con datos relevantes
            </td>
          </tr>
        `;
        return;
      }
      
      // Actualizar encabezados seg√∫n el filtro de ben√©fico
      actualizarEncabezados(beneficoFiltro);
      
      // Generar filas de la tabla
      tablaBody.innerHTML = "";
      registrosFiltrados.forEach(r => {
        const fila = document.createElement("tr");
        
        // Columnas fijas
        let contenidoFila = `
          <td>${r.producto || "-"}</td>
          <td>${r.ingrediente || "-"}</td>
        `;
        
        // Columnas din√°micas seg√∫n el ben√©fico seleccionado
        if (!beneficoFiltro) {
          // Mostrar todos los ben√©ficos
          contenidoFila += `
            <td>${formatearValor(r.swirskii_larva)}</td>
            <td>${formatearValor(r.swirskii_adulto)}</td>
            <td>${formatearValor(r.swirskii_huevo)}</td>
            <td>${formatearValor(r.swirskii_ninfa)}</td>
            <td>${r.swirskii_persistencia || "-"}</td>
            <td>${formatearValor(r.cucumeris_larva)}</td>
            <td>${formatearValor(r.cucumeris_adulto)}</td>
            <td>${formatearValor(r.cucumeris_huevo)}</td>
            <td>${formatearValor(r.cucumeris_ninfa)}</td>
            <td>${r.cucumeris_persistencia || "-"}</td>
            <td>${formatearValor(r.crizopa_larva)}</td>
            <td>${formatearValor(r.crizopa_adulto)}</td>
            <td>${formatearValor(r.crizopa_huevo)}</td>
            <td>${formatearValor(r.crizopa_ninfa)}</td>
            <td>${r.crizopa_persistencia || "-"}</td>
            <td>${formatearValor(r.colemani_larva)}</td>
            <td>${formatearValor(r.colemani_adulto)}</td>
            <td>${formatearValor(r.colemani_huevo)}</td>
            <td>${formatearValor(r.colemani_ninfa)}</td>
            <td>${r.colemani_persistencia || "-"}</td>
            <td>${r.abejorros_persistencia || "-"}</td>
            <td>${formatearAbejorrosAccion(r.abejorros_accion)}</td>
          `;
        } else {
          // Mostrar solo el ben√©fico seleccionado
          switch(beneficoFiltro) {
            case "swirskii":
              contenidoFila += `
                <td>${formatearValor(r.swirskii_larva)}</td>
                <td>${formatearValor(r.swirskii_adulto)}</td>
                <td>${formatearValor(r.swirskii_huevo)}</td>
                <td>${formatearValor(r.swirskii_ninfa)}</td>
                <td>${r.swirskii_persistencia || "-"}</td>
              `;
              break;
            case "cucumeris":
              contenidoFila += `
                <td>${formatearValor(r.cucumeris_larva)}</td>
                <td>${formatearValor(r.cucumeris_adulto)}</td>
                <td>${formatearValor(r.cucumeris_huevo)}</td>
                <td>${formatearValor(r.cucumeris_ninfa)}</td>
                <td>${r.cucumeris_persistencia || "-"}</td>
              `;
              break;
            case "crizopa":
              contenidoFila += `
                <td>${formatearValor(r.crizopa_larva)}</td>
                <td>${formatearValor(r.crizopa_adulto)}</td>
                <td>${formatearValor(r.crizopa_huevo)}</td>
                <td>${formatearValor(r.crizopa_ninfa)}</td>
                <td>${r.crizopa_persistencia || "-"}</td>
              `;
              break;
            case "colemani":
              contenidoFila += `
                <td>${formatearValor(r.colemani_larva)}</td>
                <td>${formatearValor(r.colemani_adulto)}</td>
                <td>${formatearValor(r.colemani_huevo)}</td>
                <td>${formatearValor(r.colemani_ninfa)}</td>
                <td>${r.colemani_persistencia || "-"}</td>
              `;
              break;
            case "abejorros":
              contenidoFila += `
                <td>${r.abejorros_persistencia || "-"}</td>
                <td>${formatearAbejorrosAccion(r.abejorros_accion)}</td>
              `;
              break;
          }
        }
        
        fila.innerHTML = contenidoFila;
        tablaBody.appendChild(fila);
      });
    }

    // Actualizar encabezados de la tabla seg√∫n el ben√©fico seleccionado
    function actualizarEncabezados(beneficoFiltro) {
      // Columnas fijas
      let encabezados = `
        <th>Producto</th>
        <th>Ingrediente</th>
      `;
      
      // Columnas din√°micas seg√∫n el ben√©fico
      if (!beneficoFiltro) {
        encabezados += `
          <th colspan="5">A. Swirskii</th>
          <th colspan="5">N. Cucumeris</th>
          <th colspan="5">Crizopa</th>
          <th colspan="5">Aphidius Colemani</th>
          <th colspan="2">Abejorros</th>
        `;
        
        // Agregar fila secundaria con los encabezados detallados
        const filaSecundaria = document.createElement("tr");
        let encabezadosSecundarios = `
          <th></th>
          <th></th>
        `;
        
        // Encabezados para cada organismo
        for (let i = 0; i < 4; i++) {
          encabezadosSecundarios += `
            <th>Larva</th>
            <th>Adulto</th>
            <th>Huevo</th>
            <th>Ninfa</th>
            <th>Persistencia</th>
          `;
        }
        
        // Encabezados para abejorros
        encabezadosSecundarios += `
          <th>Persistencia</th>
          <th>Acci√≥n</th>
        `;
        
        filaSecundaria.innerHTML = encabezadosSecundarios;
        
        // Limpiar encabezados existentes
        tablaHeader.innerHTML = encabezados;
        
        // Agregar la fila secundaria
        const thead = document.querySelector("#tablaRegistros thead");
        if (thead.children.length > 1) {
          thead.removeChild(thead.children[1]);
        }
        thead.appendChild(filaSecundaria);
        
        return;
      } else {
        // Para un organismo espec√≠fico, crear solo una fila de encabezados
        switch(beneficoFiltro) {
          case "swirskii":
            encabezados += `
              <th>Larva</th>
              <th>Adulto</th>
              <th>Huevo</th>
              <th>Ninfa</th>
              <th>Persistencia</th>
            `;
            break;
          case "cucumeris":
            encabezados += `
              <th>Larva</th>
              <th>Adulto</th>
              <th>Huevo</th>
              <th>Ninfa</th>
              <th>Persistencia</th>
            `;
            break;
          case "crizopa":
            encabezados += `
              <th>Larva</th>
              <th>Adulto</th>
              <th>Huevo</th>
              <th>Ninfa</th>
              <th>Persistencia</th>
            `;
            break;
          case "colemani":
            encabezados += `
              <th>Larva</th>
              <th>Adulto</th>
              <th>Huevo</th>
              <th>Ninfa</th>
              <th>Persistencia</th>
            `;
            break;
          case "abejorros":
            encabezados += `
              <th>Persistencia</th>
              <th>Acci√≥n</th>
            `;
            break;
        }
        
        // Limpiar encabezados existentes y eliminar fila secundaria si existe
        tablaHeader.innerHTML = encabezados;
        const thead = document.querySelector("#tablaRegistros thead");
        if (thead.children.length > 1) {
          thead.removeChild(thead.children[1]);
        }
      }
    }

    // Formatear valores num√©ricos
    function formatearValor(valor) {
      if (valor === undefined || valor === null || valor === "" || valor === "0") return "-";
      
      const strValor = valor.toString().trim();
      
      switch (strValor) {
        case "1": return "üü¢ N1 (<25%)";
        case "2": return "üü° N2 (25-50%)";
        case "3": return "üü† N3 (50-75%)";
        case "4": return "üî¥ N4 (>75%)";
        case "?": return "‚ö™ Desconocido";
        default: return strValor;
      }
    }

    // Formatear acci√≥n de abejorros
    function formatearAbejorrosAccion(valor) {
      if (valor === undefined || valor === null || valor === "ninguna") return "-";
      
      const strValor = valor.toString().trim().toLowerCase();
      
      switch (strValor) {
        case "cubrir": return "üüß Cubrir";
        case "retirar": return "‚ùå Retirar";
        case "incompatible": return "‚ö†Ô∏è Incompatible";
        default: return strValor;
      }
    }

    // Descargar datos como CSV
    function descargarCSV() {
      if (registros.length === 0) {
        alert("No hay datos para descargar");
        return;
      }
      
      const beneficoFiltro = filtroBenefico.value;
      const textoFiltro = buscador.value.toLowerCase();
      const categoriaFiltro = filtroCategoria.value;
      
      const registrosFiltrados = registros.filter(r => {
        // Filtrar por categor√≠a
        if (categoriaFiltro && r.categoria !== categoriaFiltro) {
          return false;
        }
        
        // Filtrar por texto (producto o ingrediente)
        if (textoFiltro) {
          const producto = r.producto?.toString().toLowerCase() || "";
          const ingrediente = r.ingrediente?.toString().toLowerCase() || "";
          if (!producto.includes(textoFiltro) && !ingrediente.includes(textoFiltro)) {
            return false;
          }
        }
        
        // Filtrar registros que solo tengan "Sin efecto"
        return tieneDatosRelevantes(r, beneficoFiltro);
      });
      
      if (registrosFiltrados.length === 0) {
        alert("No hay datos relevantes para exportar");
        return;
      }
      
      let csv = "";
      
      if (!beneficoFiltro) {
        // CSV para todos los ben√©ficos
        csv = "Producto,Ingrediente,A.Swirskii Larva,A.Swirskii Adulto,A.Swirskii Huevo,A.Swirskii Ninfa,A.Swirskii Persistencia," +
              "N.Cucumeris Larva,N.Cucumeris Adulto,N.Cucumeris Huevo,N.Cucumeris Ninfa,N.Cucumeris Persistencia," +
              "Crizopa Larva,Crizopa Adulto,Crizopa Huevo,Crizopa Ninfa,Crizopa Persistencia," +
              "A.Colemani Larva,A.Colemani Adulto,A.Colemani Huevo,A.Colemani Ninfa,A.Colemani Persistencia," +
              "Abejorros Persistencia,Abejorros Acci√≥n\n";
              
        registrosFiltrados.forEach(r => {
          csv += `"${r.producto || ""}","${r.ingrediente || ""}",` +
                 `"${formatearValor(r.swirskii_larva)}","${formatearValor(r.swirskii_adulto)}","${formatearValor(r.swirskii_huevo)}","${formatearValor(r.swirskii_ninfa)}","${r.swirskii_persistencia || ""}",` +
                 `"${formatearValor(r.cucumeris_larva)}","${formatearValor(r.cucumeris_adulto)}","${formatearValor(r.cucumeris_huevo)}","${formatearValor(r.cucumeris_ninfa)}","${r.cucumeris_persistencia || ""}",` +
                 `"${formatearValor(r.crizopa_larva)}","${formatearValor(r.crizopa_adulto)}","${formatearValor(r.crizopa_huevo)}","${formatearValor(r.crizopa_ninfa)}","${r.crizopa_persistencia || ""}",` +
                 `"${formatearValor(r.colemani_larva)}","${formatearValor(r.colemani_adulto)}","${formatearValor(r.colemani_huevo)}","${formatearValor(r.colemani_ninfa)}","${r.colemani_persistencia || ""}",` +
                 `"${r.abejorros_persistencia || ""}","${formatearAbejorrosAccion(r.abejorros_accion)}"\n`;
        });
      } else {
        // CSV para un ben√©fico espec√≠fico
        switch(beneficoFiltro) {
          case "swirskii":
            csv = "Producto,Ingrediente,Larva,Adulto,Huevo,Ninfa,Persistencia\n";
            registrosFiltrados.forEach(r => {
              csv += `"${r.producto || ""}","${r.ingrediente || ""}",` +
                     `"${formatearValor(r.swirskii_larva)}","${formatearValor(r.swirskii_adulto)}","${formatearValor(r.swirskii_huevo)}","${formatearValor(r.swirskii_ninfa)}","${r.swirskii_persistencia || ""}"\n`;
            });
            break;
          case "cucumeris":
            csv = "Producto,Ingrediente,Larva,Adulto,Huevo,Ninfa,Persistencia\n";
            registrosFiltrados.forEach(r => {
              csv += `"${r.producto || ""}","${r.ingrediente || ""}",` +
                     `"${formatearValor(r.cucumeris_larva)}","${formatearValor(r.cucumeris_adulto)}","${formatearValor(r.cucumeris_huevo)}","${formatearValor(r.cucumeris_ninfa)}","${r.cucumeris_persistencia || ""}"\n`;
            });
            break;
          case "crizopa":
            csv = "Producto,Ingrediente,Larva,Adulto,Huevo,Ninfa,Persistencia\n";
            registrosFiltrados.forEach(r => {
              csv += `"${r.producto || ""}","${r.ingrediente || ""}",` +
                     `"${formatearValor(r.crizopa_larva)}","${formatearValor(r.crizopa_adulto)}","${formatearValor(r.crizopa_huevo)}","${formatearValor(r.crizopa_ninfa)}","${r.crizopa_persistencia || ""}"\n`;
            });
            break;
          case "colemani":
            csv = "Producto,Ingrediente,Larva,Adulto,Huevo,Ninfa,Persistencia\n";
            registrosFiltrados.forEach(r => {
              csv += `"${r.producto || ""}","${r.ingrediente || ""}",` +
                     `"${formatearValor(r.colemani_larva)}","${formatearValor(r.colemani_adulto)}","${formatearValor(r.colemani_huevo)}","${formatearValor(r.colemani_ninfa)}","${r.colemani_persistencia || ""}"\n`;
            });
            break;
          case "abejorros":
            csv = "Producto,Ingrediente,Persistencia,Acci√≥n\n";
            registrosFiltrados.forEach(r => {
              csv += `"${r.producto || ""}","${r.ingrediente || ""}",` +
                     `"${r.abejorros_persistencia || ""}","${formatearAbejorrosAccion(r.abejorros_accion)}"\n`;
            });
            break;
        }
      }
      
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const fecha = new Date().toISOString().split('T')[0];
      
      link.href = URL.createObjectURL(blob);
      link.download = `evaluacion_beneficos_${fecha}.csv`;
      link.click();
      
      // Cerrar el modal despu√©s de descargar
      cerrarModalDescargas();
    }

    // Descargar tabla como imagen
    function descargarImagen() {
      html2canvas(document.querySelector(".table-container")).then(canvas => {
        const link = document.createElement("a");
        const fecha = new Date().toISOString().split('T')[0];
        
        link.href = canvas.toDataURL("image/png");
        link.download = `evaluacion_beneficos_${fecha}.png`;
        link.click();
        
        // Cerrar el modal despu√©s de descargar
        cerrarModalDescargas();
      });
    }

    // Event listeners
    buscador.addEventListener("input", mostrarFiltrados);
    filtroCategoria.addEventListener("change", mostrarFiltrados);
    filtroBenefico.addEventListener("change", mostrarFiltrados);
    document.addEventListener("DOMContentLoaded", cargarDatos);
  </script>
</body>
</html>
