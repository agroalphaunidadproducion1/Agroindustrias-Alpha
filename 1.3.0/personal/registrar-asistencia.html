<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - Agro Productos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../components.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --admin-color: #2196F3;
            --grower-junior-color: #FF9800;
            --digitador-color: #9C27B0;
            --tecnico-color: #607D8B;
            --supervisor-color: #FF5722;
            --invitado-color: #9E9E9E;
            --gerente-general-color: #E91E63;
            --gerente-produccion-color: #3F51B5;
            --jefe-vivero-color: #009688;
            --error-color: #f44336;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --dark-gray: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-space {
            height: 70px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        .container {
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .breadcrumb {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        .card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            border: none;
        }
        
        .card-header {
            border-radius: 8px 8px 0 0 !important;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
        }

        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 4px;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 4px;
        }

        .btn-danger {
            background-color: var(--error-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 4px;
        }

        .btn-info {
            background-color: var(--admin-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 4px;
        }

        .btn-warning {
            background-color: var(--grower-junior-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 4px;
        }

        .btn-action {
            padding: 5px 8px;
            font-size: 0.8rem;
            margin: 2px;
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .points-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .points-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .points-table tr:hover {
            background-color: #f9f9f9;
        }

        .current-date {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }
        
        .current-area {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        .temporary-employee {
            background-color: #fff3cd !important;
        }
        
        .search-container {
            position: relative;
        }
        
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        
        .caporal-badge {
            background-color: var(--grower-junior-color);
            color: #000;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .stats-card {
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }

        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer-space {
            height: 70px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .points-table th, .points-table td {
                padding: 8px 5px;
            }
            
            .btn-action {
                padding: 4px 6px;
                font-size: 0.7rem;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>

    <!-- Componentes -->
    <header-component></header-component>
    <sidebar-component></sidebar-component>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container">
            <div class="breadcrumb">
                <a href="dashboard.html">Inicio</a> >Registro Diario de Asistencia
            </div>
            
            <h1>Sistema de Asistencia</h1>
            <div class="current-date" id="current-date"></div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Registro de Asistencia Diaria</h5>
                        </div>
                        <div class="card-body">
                            <!-- Selección de área actual -->
                            <div class="current-area mb-4">
                                <h5 class="section-title"><i class="fas fa-map-marker-alt me-2"></i>Área de Trabajo</h5>
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <label class="form-label"><strong>Seleccione el invernadero/área:</strong></label>
                                        <select class="form-select" id="current-area-select">
                                            <option value="">Seleccione un área...</option>
                                            <!-- Opciones se cargarán dinámicamente -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="current-area-display">
                                            <strong>Área seleccionada:</strong> <span id="current-area-name" class="fw-bold text-primary">Ninguna</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selección de fecha -->
                            <div class="current-area mb-4">
                                <h5 class="section-title"><i class="fas fa-calendar-alt me-2"></i>Fecha de Asistencia</h5>
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <label class="form-label"><strong>Seleccione la fecha:</strong></label>
                                        <input type="date" class="form-control" id="attendance-date" value="">
                                    </div>
                                    <div class="col-md-6">
                                        <div id="selected-date-display">
                                            <strong>Fecha seleccionada:</strong> <span id="selected-date-name" class="fw-bold text-primary"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="search-container">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="search-employee" class="form-control" placeholder="Buscar personal por nombre o código...">
                                        </div>
                                        <div class="suggestions-container" id="search-suggestions"></div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-success me-2" id="mark-all-present">
                                        <i class="fas fa-check-circle me-2"></i>Marcar Todos Presentes
                                    </button>
                                    <button class="btn btn-primary" id="save-attendance">
                                        <i class="fas fa-save me-2"></i>Guardar Asistencia
                                    </button>
                                </div>
                            </div>

                            <div class="points-table-container">
                                <table class="points-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Puesto</th>
                                            <th class="text-center">Asistencia</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-list">
                                        <tr>
                                            <td colspan="5" class="no-data">Seleccione un área de trabajo para mostrar el personal</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Resumen de Asistencia</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body">
                                            <h6>Total Empleados</h6>
                                            <h3 id="total-employees">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body">
                                            <h6>Presentes</h6>
                                            <h3 id="present-count">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body">
                                            <h6>Ausentes</h6>
                                            <h3 id="absent-count">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instrucciones</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>Seleccione el área donde está tomando asistencia</li>
                                <li>Seleccione la fecha para la cual está registrando asistencia</li>
                                <li>Se mostrará automáticamente el personal de esa área</li>
                                <li>Busque empleados por nombre o código si es necesario</li>
                                <li>Seleccione "Presente" o "Ausente" para cada empleado</li>
                                <li>Use el botón "+" para agregar personal de otras áreas</li>
                                <li>Haga clic en "Guardar Asistencia" para guardar los registros</li>
                                <li>Cada invernadero/área guarda su asistencia por separado</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Espacio reservado para el footer -->
    <div class="footer-space"></div>

    <!-- Modal para mover empleado -->
    <div class="modal fade" id="moveEmployeeModal" tabindex="-1" aria-labelledby="moveEmployeeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moveEmployeeModalLabel">Mover Empleado</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea mover al empleado <strong id="employeeName"></strong>?</p>
                    
                    <div class="alert alert-info" id="move-restrictions-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="restrictions-text"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="currentAreaDisplay" class="form-label">Área actual:</label>
                        <input type="text" class="form-control" id="currentAreaDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="newAreaSelect" class="form-label">Seleccionar nuevo invernadero/área:</label>
                        <select class="form-select" id="newAreaSelect">
                            <option value="">Seleccione un área...</option>
                            <!-- Opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmMove">Mover Empleado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para eliminar empleado -->
    <div class="modal fade" id="deleteEmployeeModal" tabindex="-1" aria-labelledby="deleteEmployeeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteEmployeeModalLabel">Eliminar Empleado</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar al empleado <strong id="deleteEmployeeName"></strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Esta acción no se puede deshacer. El empleado será eliminado completamente del sistema.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Eliminar Empleado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
      
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            databaseURL: "https://agro-productos-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        console.log('Firebase inicializado:', app.name);

        // Referencias a las tablas
        const personalRef = database.ref('personal');
        const attendanceRef = database.ref('asistencia');

        // Variables globales
        let allEmployees = [];
        let filteredEmployees = [];
        let temporalEmployees = [];
        let savedAttendance = {};
        let currentArea = '';
        let allAreas = new Set();
        let currentEmployeeForAction = null;
        let selectedDate = '';
        let dateId = '';

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando aplicación...');
            
            // Establecer fecha actual como predeterminada
            const today = new Date();
            dateId = today.toISOString().split('T')[0];
            selectedDate = dateId;
            
            // Formatear fecha para mostrar
            const formattedDate = today.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('current-date').textContent = formattedDate;
            
            // Configurar selector de fecha
            const dateInput = document.getElementById('attendance-date');
            dateInput.value = dateId;
            updateSelectedDateDisplay(dateId);
            
            // Cargar empleados y configurar eventos
            loadEmployees();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Selección de área actual
            document.getElementById('current-area-select').addEventListener('change', function() {
                currentArea = this.value;
                const areaName = this.options[this.selectedIndex].text;
                document.getElementById('current-area-name').textContent = areaName;
                console.log('Área seleccionada:', currentArea);
                loadAttendanceForArea(currentArea);
            });

            // Selección de fecha
            document.getElementById('attendance-date').addEventListener('change', function() {
                selectedDate = this.value;
                dateId = selectedDate;
                updateSelectedDateDisplay(selectedDate);
                console.log('Fecha seleccionada:', dateId);
                
                // Recargar asistencia si hay un área seleccionada
                if (currentArea) {
                    loadAttendanceForArea(currentArea);
                }
            });

            // Búsqueda con sugerencias
            const searchInput = document.getElementById('search-employee');
            searchInput.addEventListener('input', function() {
                showSuggestions(this.value);
            });
            
            searchInput.addEventListener('focus', function() {
                if (this.value) {
                    showSuggestions(this.value);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSuggestions();
                }
            });

            // Botones de acción
            document.getElementById('mark-all-present').addEventListener('click', markAllPresent);
            document.getElementById('save-attendance').addEventListener('click', saveAttendance);
            
            // Event listeners para modales
            document.getElementById('confirmMove').addEventListener('click', moveEmployee);
            document.getElementById('confirmDelete').addEventListener('click', deleteEmployee);
        }

        // Actualizar la visualización de la fecha seleccionada
        function updateSelectedDateDisplay(dateString) {
            const date = new Date(dateString);
            const formattedDate = date.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('selected-date-name').textContent = formattedDate;
        }

        // Cargar empleados desde Firebase
        function loadEmployees() {
            console.log('Cargando empleados desde Firebase...');
            
            personalRef.once('value').then((snapshot) => {
                allEmployees = [];
                allAreas.clear();
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const employee = childSnapshot.val();
                        employee.id = childSnapshot.key;
                        employee.temporal = false;
                        allEmployees.push(employee);
                        
                        console.log('Empleado cargado:', employee.nombre, employee.invernaderos);
                        
                        // Recopilar todas las áreas únicas
                        if (employee.invernaderos && Array.isArray(employee.invernaderos)) {
                            employee.invernaderos.forEach(area => {
                                allAreas.add(area);
                                console.log('Área agregada:', area);
                            });
                        }
                    });
                    
                    console.log('Total empleados cargados:', allEmployees.length);
                    console.log('Áreas encontradas:', Array.from(allAreas));
                    
                    // Cargar selector de áreas
                    loadAreaSelector();
                } else {
                    console.log('No hay empleados en la base de datos');
                    document.getElementById('attendance-list').innerHTML = 
                        '<tr><td colspan="5" class="no-data">No hay empleados registrados en el sistema</td></tr>';
                }
            }).catch((error) => {
                console.error('Error al cargar empleados:', error);
                document.getElementById('attendance-list').innerHTML = 
                    '<tr><td colspan="5" class="no-data">Error al cargar los empleados: ' + error.message + '</td></tr>';
            });
        }

        // Cargar selector de áreas
        function loadAreaSelector() {
            const areaSelect = document.getElementById('current-area-select');
            areaSelect.innerHTML = '<option value="">Seleccione un área...</option>';
            
            // Definir áreas predefinidas
            const predefinedAreas = [
                '9', '10', '11', '12', '13', '14', '15', '16', 
                '33', '35', '37', '39',
                'Fitosanidad', 'Riego', 'Acopio', 'Áreas Verdes'
            ];
            
            // Combinar áreas predefinidas con las encontradas
            const combinedAreas = new Set([...predefinedAreas, ...allAreas]);
            console.log('Áreas combinadas para selector:', Array.from(combinedAreas));
            
            // Ordenar áreas
            const sortedAreas = Array.from(combinedAreas).sort((a, b) => {
                const isSpecialA = isNaN(a);
                const isSpecialB = isNaN(b);
                
                if (isSpecialA && !isSpecialB) return -1;
                if (!isSpecialA && isSpecialB) return 1;
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            sortedAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                
                // Mostrar nombre apropiado
                if (area === 'Fitosanidad' || area === 'Riego' || area === 'Acopio' || area === 'Áreas Verdes') {
                    option.textContent = area;
                } else {
                    option.textContent = 'Invernadero ' + area;
                }
                
                areaSelect.appendChild(option);
            });
            
            console.log('Selector de áreas cargado con:', sortedAreas.length, 'áreas');
            
            // También cargar selector de áreas para mover empleados
            loadMoveAreaSelector();
        }
        
        // Cargar selector de áreas para mover empleados
        function loadMoveAreaSelector() {
            const moveAreaSelect = document.getElementById('newAreaSelect');
            moveAreaSelect.innerHTML = '<option value="">Seleccione un área...</option>';
            
            // Usar las mismas áreas predefinidas
            const predefinedAreas = [
                '9', '10', '11', '12', '13', '14', '15', '16', 
                '33', '35', '37', '39',
                'Fitosanidad', 'Riego', 'Acopio', 'Áreas Verdes'
            ];
            
            const combinedAreas = new Set([...predefinedAreas, ...allAreas]);
            const sortedAreas = Array.from(combinedAreas).sort((a, b) => {
                const isSpecialA = isNaN(a);
                const isSpecialB = isNaN(b);
                
                if (isSpecialA && !isSpecialB) return -1;
                if (!isSpecialA && isSpecialB) return 1;
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            });
            
            sortedAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                
                if (area === 'Fitosanidad' || area === 'Riego' || area === 'Acopio' || area === 'Áreas Verdes') {
                    option.textContent = area;
                } else {
                    option.textContent = 'Invernadero ' + area;
                }
                
                moveAreaSelect.appendChild(option);
            });
        }

        // Cargar asistencia para un área específica
        function loadAttendanceForArea(area) {
            if (!area) return;
            
            console.log('Cargando asistencia para área:', area, 'fecha:', dateId);
            
            attendanceRef.child(dateId).child(area).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    savedAttendance = snapshot.val();
                    console.log('Asistencia cargada:', savedAttendance);
                } else {
                    savedAttendance = {};
                    console.log('No hay asistencia previa para esta área y fecha');
                }
                filterEmployeesByArea(area);
            }).catch((error) => {
                console.error('Error al cargar asistencia:', error);
                savedAttendance = {};
                filterEmployeesByArea(area);
            });
        }

        // Filtrar empleados por área seleccionada
        function filterEmployeesByArea(area) {
            console.log('Filtrando empleados para área:', area);
            
            // Mostrar empleados del área seleccionada
            const areaEmployees = allEmployees.filter(employee => 
                employee.invernaderos && employee.invernaderos.includes(area)
            );
            
            console.log('Empleados del área:', areaEmployees.length);
            
            // Combinar con empleados temporales
            filteredEmployees = [...areaEmployees, ...temporalEmployees];
            
            console.log('Total empleados a mostrar:', filteredEmployees.length);
            
            // Actualizar la lista de asistencia
            renderAttendanceList();
            updateCounters();
        }

        // Mostrar sugerencias de búsqueda
        function showSuggestions(query) {
            const suggestionsContainer = document.getElementById('search-suggestions');
            suggestionsContainer.innerHTML = '';
            
            if (!query) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const suggestions = allEmployees.filter(employee => {
                const nombreMatch = employee.nombre && employee.nombre.toLowerCase().includes(query.toLowerCase());
                const codigoMatch = employee.codigo && employee.codigo.toLowerCase().includes(query.toLowerCase());
                return nombreMatch || codigoMatch;
            }).slice(0, 5);
            
            if (suggestions.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestions.forEach(employee => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                
                const mainArea = getMainArea(employee);
                suggestionItem.textContent = `${employee.nombre} (${employee.codigo}) - ${mainArea}`;
                suggestionItem.addEventListener('click', () => {
                    document.getElementById('search-employee').value = '';
                    hideSuggestions();
                    
                    // Si el empleado no está en el área actual, agregarlo como temporal
                    if (currentArea && employee.invernaderos && !employee.invernaderos.includes(currentArea)) {
                        addTemporalEmployee(employee);
                    }
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        // Obtener el área principal de un empleado
        function getMainArea(employee) {
            if (!employee.invernaderos || employee.invernaderos.length === 0) return 'Sin área';
            
            const specialAreas = ['Fitosanidad', 'Riego', 'Acopio', 'Áreas Verdes'];
            const specialArea = employee.invernaderos.find(area => specialAreas.includes(area));
            
            if (specialArea) return specialArea;
            
            return 'Invernadero ' + employee.invernaderos[0];
        }
        
        // Ocultar sugerencias
        function hideSuggestions() {
            document.getElementById('search-suggestions').style.display = 'none';
        }

        // Agregar empleado temporal
        function addTemporalEmployee(employee) {
            const alreadyExists = temporalEmployees.some(e => e.id === employee.id);
            if (alreadyExists) return;
            
            const temporalEmployee = {
                ...employee,
                temporal: true,
                originalArea: getMainArea(employee)
            };
            
            temporalEmployees.push(temporalEmployee);
            filterEmployeesByArea(currentArea);
        }

        // Renderizar lista de asistencia
        function renderAttendanceList() {
            const attendanceList = document.getElementById('attendance-list');
            
            if (!currentArea) {
                attendanceList.innerHTML = '<tr><td colspan="5" class="no-data">Seleccione un área de trabajo para comenzar</td></tr>';
                return;
            }
            
            if (filteredEmployees.length === 0) {
                attendanceList.innerHTML = '<tr><td colspan="5" class="no-data">No hay empleados en esta área</td></tr>';
                return;
            }
            
            attendanceList.innerHTML = '';
            
            filteredEmployees.forEach(employee => {
                const isPresent = savedAttendance[employee.id] === true;
                const isCaporal = employee.puesto && employee.puesto.toLowerCase().includes('caporal');
                const row = document.createElement('tr');
                
                if (employee.temporal) {
                    row.classList.add('temporary-employee');
                }
                
                row.innerHTML = `
                    <td>
                        ${employee.nombre || 'Sin nombre'}
                        ${isCaporal ? '<span class="caporal-badge">Caporal</span>' : ''}
                    </td>
                    <td>${employee.codigo || 'Sin código'}</td>
                    <td>${employee.puesto || 'Sin puesto'}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm ${isPresent ? 'btn-success' : 'btn-outline-success'} attendance-btn present-btn" data-employee-id="${employee.id}" data-status="true">
                                <i class="fas fa-check"></i> Presente
                            </button>
                            <button type="button" class="btn btn-sm ${!isPresent ? 'btn-danger' : 'btn-outline-danger'} attendance-btn absent-btn" data-employee-id="${employee.id}" data-status="false">
                                <i class="fas fa-times"></i> Ausente
                            </button>
                        </div>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary btn-action move-employee-btn" data-employee-id="${employee.id}">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action delete-employee-btn" data-employee-id="${employee.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${employee.temporal ? 
                            `<button class="btn btn-sm btn-warning btn-action remove-temporal-btn" data-employee-id="${employee.id}">
                                <i class="fas fa-times"></i>
                            </button>` : 
                            (employee.invernaderos && employee.invernaderos.includes(currentArea) ? '' :
                            `<button class="btn btn-sm btn-info btn-action add-temporal-btn" data-employee-id="${employee.id}">
                                <i class="fas fa-plus"></i>
                            </button>`)
                        }
                    </td>
                `;
                
                attendanceList.appendChild(row);
            });
            
            // Añadir event listeners
            setupAttendanceEventListeners();
            
            // Actualizar contadores
            updateCounters();
        }

        // Configurar event listeners para la tabla de asistencia
        function setupAttendanceEventListeners() {
            // Botones de asistencia
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.dataset.employeeId;
                    const status = this.dataset.status === 'true';
                    
                    savedAttendance[employeeId] = status;
                    updateAttendanceUI(employeeId, status);
                    updateCounters();
                });
            });
            
            // Botones de mover empleado
            document.querySelectorAll('.move-employee-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.dataset.employeeId;
                    const employee = allEmployees.find(e => e.id === employeeId);
                    if (employee) showMoveModal(employee);
                });
            });
            
            // Botones de eliminar empleado
            document.querySelectorAll('.delete-employee-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.dataset.employeeId;
                    const employee = allEmployees.find(e => e.id === employeeId);
                    if (employee) showDeleteModal(employee);
                });
            });
            
            // Botones de personal temporal
            document.querySelectorAll('.add-temporal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.dataset.employeeId;
                    const employee = allEmployees.find(e => e.id === employeeId);
                    if (employee) addTemporalEmployee(employee);
                });
            });
            
            document.querySelectorAll('.remove-temporal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.dataset.employeeId;
                    temporalEmployees = temporalEmployees.filter(e => e.id !== employeeId);
                    if (savedAttendance[employeeId]) delete savedAttendance[employeeId];
                    filterEmployeesByArea(currentArea);
                });
            });
        }

        // Actualizar la interfaz de asistencia
        function updateAttendanceUI(employeeId, status) {
            const presentBtn = document.querySelector(`.present-btn[data-employee-id="${employeeId}"]`);
            const absentBtn = document.querySelector(`.absent-btn[data-employee-id="${employeeId}"]`);
            
            if (presentBtn && absentBtn) {
                if (status) {
                    presentBtn.classList.remove('btn-outline-success');
                    presentBtn.classList.add('btn-success');
                    absentBtn.classList.remove('btn-danger');
                    absentBtn.classList.add('btn-outline-danger');
                } else {
                    presentBtn.classList.remove('btn-success');
                    presentBtn.classList.add('btn-outline-success');
                    absentBtn.classList.remove('btn-outline-danger');
                    absentBtn.classList.add('btn-danger');
                }
            }
        }

        // Mostrar modal para mover empleado
        function showMoveModal(employee) {
            currentEmployeeForAction = employee;
            
            document.getElementById('employeeName').textContent = `${employee.nombre} (${employee.codigo})`;
            
            const isCaporal = employee.puesto && employee.puesto.toLowerCase().includes('caporal');
            const restrictionsInfo = document.getElementById('restrictions-text');
            
            if (isCaporal) {
                restrictionsInfo.textContent = 'Este empleado es Caporal y puede tener múltiples invernaderos asignados. Al agregar uno nuevo, se mantendrán los existentes.';
            } else {
                restrictionsInfo.textContent = 'Este empleado solo puede tener un invernadero asignado. Al seleccionar uno nuevo, se eliminará automáticamente del anterior.';
            }
            
            const currentAreaDisplay = document.getElementById('currentAreaDisplay');
            if (employee.invernaderos && employee.invernaderos.length > 0) {
                currentAreaDisplay.value = employee.invernaderos.map(area => {
                    if (area === 'Fitosanidad' || area === 'Riego' || area === 'Acopio' || area === 'Áreas Verdes') {
                        return area;
                    } else {
                        return 'Invernadero ' + area;
                    }
                }).join(', ');
            } else {
                currentAreaDisplay.value = 'Sin área asignada';
            }
            
            document.getElementById('newAreaSelect').value = '';
            
            const moveModal = new bootstrap.Modal(document.getElementById('moveEmployeeModal'));
            moveModal.show();
        }

        // Mostrar modal para eliminar empleado
        function showDeleteModal(employee) {
            currentEmployeeForAction = employee;
            document.getElementById('deleteEmployeeName').textContent = `${employee.nombre} (${employee.codigo})`;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteEmployeeModal'));
            deleteModal.show();
        }

        // Mover empleado a otro invernadero/área
        function moveEmployee() {
            const newArea = document.getElementById('newAreaSelect').value;
            
            if (!newArea) {
                alert('Por favor seleccione un área destino');
                return;
            }
            
            if (!currentEmployeeForAction) return;
            
            if (currentEmployeeForAction.invernaderos && currentEmployeeForAction.invernaderos.includes(newArea)) {
                alert('El empleado ya está asignado a esta área');
                return;
            }
            
            const isCaporal = currentEmployeeForAction.puesto && 
                              currentEmployeeForAction.puesto.toLowerCase().includes('caporal');
            
            const currentAreas = currentEmployeeForAction.invernaderos || [];
            let updatedAreas;
            
            if (isCaporal) {
                updatedAreas = [...currentAreas, newArea];
            } else {
                updatedAreas = [newArea];
            }
            
            const employeeRef = personalRef.child(currentEmployeeForAction.id);
            
            employeeRef.update({ invernaderos: updatedAreas })
                .then(() => {
                    alert(`Empleado ${isCaporal ? 'agregado a nueva área' : 'movido'} exitosamente`);
                    
                    const employeeIndex = allEmployees.findIndex(e => e.id === currentEmployeeForAction.id);
                    if (employeeIndex !== -1) {
                        allEmployees[employeeIndex].invernaderos = updatedAreas;
                    }
                    
                    if (currentArea) {
                        filterEmployeesByArea(currentArea);
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('moveEmployeeModal')).hide();
                })
                .catch((error) => {
                    console.error('Error al mover empleado:', error);
                    alert('Error al mover empleado. Por favor, intente nuevamente.');
                });
        }

        // Eliminar empleado
        function deleteEmployee() {
            if (!currentEmployeeForAction) return;
            
            if (!confirm('¿Está completamente seguro de que desea eliminar permanentemente a este empleado?')) {
                return;
            }
            
            personalRef.child(currentEmployeeForAction.id).remove()
                .then(() => {
                    alert('Empleado eliminado exitosamente');
                    allEmployees = allEmployees.filter(e => e.id !== currentEmployeeForAction.id);
                    
                    if (currentArea) {
                        filterEmployeesByArea(currentArea);
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('deleteEmployeeModal')).hide();
                })
                .catch((error) => {
                    console.error('Error al eliminar empleado:', error);
                    alert('Error al eliminar empleado. Por favor, intente nuevamente.');
                });
        }

        // Marcar todos como presentes
        function markAllPresent() {
            filteredEmployees.forEach(employee => {
                savedAttendance[employee.id] = true;
                updateAttendanceUI(employee.id, true);
            });
            updateCounters();
        }

        // Actualizar contadores
        function updateCounters() {
            const total = filteredEmployees.length;
            const present = Object.values(savedAttendance).filter(status => status === true).length;
            const absent = total - present;
            
            document.getElementById('total-employees').textContent = total;
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
        }

        // Guardar asistencia en Firebase
        function saveAttendance() {
            if (!currentArea) {
                alert('Por favor seleccione un área primero');
                return;
            }
            
            if (!dateId) {
                alert('Por favor seleccione una fecha válida');
                return;
            }
            
            if (Object.keys(savedAttendance).length === 0) {
                alert('No hay registros de asistencia para guardar');
                return;
            }
            
            console.log('Guardando asistencia para:', currentArea, 'fecha:', dateId, 'datos:', savedAttendance);
            
            attendanceRef.child(dateId).child(currentArea).set(savedAttendance)
                .then(() => {
                    const areaName = document.getElementById('current-area-select').options[document.getElementById('current-area-select').selectedIndex].text;
                    const dateName = document.getElementById('selected-date-name').textContent;
                    alert(`Asistencia guardada correctamente para ${areaName} en la fecha ${dateName}`);
                    console.log('Asistencia guardada exitosamente en Firebase');
                })
                .catch((error) => {
                    console.error('Error al guardar la asistencia:', error);
                    alert('Error al guardar la asistencia. Por favor, intente nuevamente.');
                });
        }
    </script>
      <!-- Scripts -->
    <script src="../header-component.js"></script>
    <script src="../sidebar-component.js"></script>
    <script src="../footer.js"></script>
</body>
</html>
