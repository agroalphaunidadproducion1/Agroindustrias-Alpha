<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Plagas - Invernaderos</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --admin-color: #2196F3;
            --grower-junior-color: #FF9800;
            --digitador-color: #9C27B0;
            --tecnico-color: #607D8B;
            --supervisor-color: #FF5722;
            --invitado-color: #9E9E9E;
            --gerente-general-color: #E91E63;
            --gerente-produccion-color: #3F51B5;
            --jefe-vivero-color: #009688;
            --error-color: #f44336;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --dark-gray: #000000;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --sidebar-active: #3498db;
            
            /* Colores para plagas */
            --mosca-blanca-color: #FFEB3B;
            --acaro-rojo-color: #f44336;
            --acaro-blanco-color: #9E9E9E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-space {
            height: 70px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        .container {
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
        }

        .breadcrumb {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 14px;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            color: var(--dark-gray);
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .legend-mosca {
            background-color: var(--mosca-blanca-color);
        }

        .legend-acaro-rojo {
            background-color: var(--acaro-rojo-color);
        }

        .legend-acaro-blanco {
            background-color: var(--acaro-blanco-color);
        }

        .greenhouse-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            min-height: 800px;
        }

        .capillas-izquierda {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .capillas-derecha {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pasillo-central {
            width: 40px;
            background: #5d4037;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #d7ccc8;
            font-weight: bold;
            font-size: 1rem;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            border-left: 2px dashed #8d6e63;
            border-right: 2px dashed #8d6e63;
        }

        .capilla {
            flex: 1;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .capilla-header {
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            color: #495057;
            padding: 4px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .camas-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }

        .cama {
            flex: 1;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 3px;
            display: flex;
            gap: 2px;
        }

        /* Para el lado izquierdo, los módulos empiezan desde la derecha (cerca del pasillo) */
        .capillas-izquierda .cama {
            flex-direction: row-reverse;
        }

        /* Para el lado derecho, los módulos empiezan desde la izquierda (cerca del pasillo) */
        .capillas-derecha .cama {
            flex-direction: row;
        }

        .modulo {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 12px;
        }

        .modulo:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .modulo:hover::after {
            content: attr(data-info);
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 1000;
            pointer-events: none;
            text-align: center;
            line-height: 1.4;
            min-width: 150px;
        }

        .modulo.mosca-blanca {
            background-color: var(--mosca-blanca-color);
            border-color: #FBC02D;
        }

        .modulo.acaro-rojo {
            background-color: var(--acaro-rojo-color);
            border-color: #D32F2F;
        }

        .modulo.acaro-blanco {
            background-color: var(--acaro-blanco-color);
            border-color: #757575;
        }

        .modulo.con-plaga {
            animation: pulse 2s infinite;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #666;
        }

        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .footer-space {
            height: 70px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .greenhouse-container {
                flex-direction: column;
                min-height: auto;
            }
            
            .pasillo-central {
                width: 100%;
                height: 40px;
                writing-mode: horizontal-tb;
                margin: 10px 0;
            }
            
            .capillas-izquierda,
            .capillas-derecha {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .capilla {
                min-width: 200px;
                min-height: 150px;
            }

            /* En móvil, mantener dirección normal */
            .capillas-izquierda .cama,
            .capillas-derecha .cama {
                flex-direction: row;
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
            }
            
            .legend {
                flex-direction: column;
                align-items: center;
            }
            
            .capilla {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Espacio reservado para el header -->
    <div class="header-space"></div>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container">
            <div class="breadcrumb">
                <a href="#">Inicio</a> > <a href="#">Monitoreo</a> > Mapa de Plagas
            </div>
            
            <h1>Mapa de Plagas por Invernadero</h1>
            
            <!-- Controles -->
            <div class="controls">
                <div class="form-group">
                    <label for="invernadero">Seleccionar Invernadero:</label>
                    <select id="invernadero">
                        <option value="9">Invernadero 9</option>
                        <option value="10">Invernadero 10</option>
                        <option value="11">Invernadero 11</option>
                        <option value="12">Invernadero 12</option>
                        <option value="13">Invernadero 13</option>
                        <option value="14">Invernadero 14</option>
                        <option value="15">Invernadero 15</option>
                        <option value="16">Invernadero 16</option>
                        <option value="33">Invernadero 33</option>
                        <option value="35">Invernadero 35</option>
                        <option value="37">Invernadero 37</option>
                        <option value="39">Invernadero 39</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="plaga">Filtrar por Plaga:</label>
                    <select id="plaga">
                        <option value="todas">Todas las Plagas</option>
                        <option value="mosca-blanca">Mosca Blanca</option>
                        <option value="acaro-rojo">Ácaro Rojo</option>
                        <option value="acaro-blanco">Ácaro Blanco</option>
                    </select>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-mosca"></div>
                    <span>Mosca Blanca</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-acaro-rojo"></div>
                    <span>Ácaro Rojo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-acaro-blanco"></div>
                    <span>Ácaro Blanco</span>
                </div>
                <div class="legend-item">
                    <div style="width: 14px; height: 14px; border: 2px solid #4CAF50; background: transparent; animation: pulse 2s infinite;"></div>
                    <span>Módulo con plaga</span>
                </div>
            </div>

            <!-- Mapa del invernadero -->
            <div id="invernaderoMap" class="invernadero-map">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando mapa del invernadero...</p>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="stats">
                <div class="stat-card">
                    <h3>Total de Módulos Afectados</h3>
                    <div class="number" id="totalModulos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Mosca Blanca</h3>
                    <div class="number" id="totalMosca">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ácaro Rojo</h3>
                    <div class="number" id="totalAcaroRojo">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ácaro Blanco</h3>
                    <div class="number" id="totalAcaroBlanco">0</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Espacio reservado para el footer -->
    <div class="footer-space"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <!-- Scripts de componentes externos -->
    <script src="/header-component.js"></script>
    <script src="/sidebar-component.js"></script>
    <script src="../footer.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://agro-productos-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM elements
        const invernaderoSelect = document.getElementById('invernadero');
        const plagaSelect = document.getElementById('plaga');
        const invernaderoMap = document.getElementById('invernaderoMap');
        const totalModulos = document.getElementById('totalModulos');
        const totalMosca = document.getElementById('totalMosca');
        const totalAcaroRojo = document.getElementById('totalAcaroRojo');
        const totalAcaroBlanco = document.getElementById('totalAcaroBlanco');

        // Datos de ejemplo (serán reemplazados por Firebase)
        let plagueData = {};

        // Función para obtener el estado (por defecto "activo" si no existe)
        function getEstado(point) {
            return point.estado || 'activo';
        }

        // Generar estructura del mapa del invernadero
        function generateInvernaderoMap() {
            const selectedInvernadero = invernaderoSelect.value;
            const selectedPlaga = plagaSelect.value;
            
            // Filtrar datos para el invernadero seleccionado - SOLO PUNTOS ACTIVOS
            const filteredData = (plagueData[selectedInvernadero] || []).filter(point => 
                getEstado(point) === 'activo'
            );
            
            let html = `
                <div class="greenhouse-container">
                    <div class="capillas-izquierda">
                        ${generateCapillas('norte', filteredData, selectedPlaga)}
                    </div>
                    
                    <div class="pasillo-central">PASILLO</div>
                    
                    <div class="capillas-derecha">
                        ${generateCapillas('sur', filteredData, selectedPlaga)}
                    </div>
                </div>
            `;
            
            invernaderoMap.innerHTML = html;
            updateStatistics(filteredData, selectedPlaga);
        }

        // Generar todas las capillas de un lado
        function generateCapillas(lado, data, plagaFiltro) {
            let html = '';
            
            // 18 capillas por lado
            for (let capilla = 1; capilla <= 18; capilla++) {
                html += generateCapilla(lado, capilla, data, plagaFiltro);
            }
            
            return html;
        }

        // Generar una capilla individual
        function generateCapilla(lado, numero, data, plagaFiltro) {
            const nombreCapilla = lado === 'norte' ? `${numero} NORTE` : `${numero} SUR`;
            
            return `
                <div class="capilla">
                    <div class="capilla-header">${nombreCapilla}</div>
                    <div class="camas-container">
                        ${generateCamas(lado, numero, data, plagaFiltro)}
                    </div>
                </div>
            `;
        }

        // Generar las 8 camas para una capilla
        function generateCamas(lado, capilla, data, plagaFiltro) {
            let html = '';
            
            // 8 camas por capilla
            for (let cama = 1; cama <= 8; cama++) {
                html += `
                    <div class="cama">
                        ${generateModulos(lado, capilla, cama, data, plagaFiltro)}
                    </div>
                `;
            }
            
            return html;
        }

        // Generar los 10 módulos para una cama
        function generateModulos(lado, capilla, cama, data, plagaFiltro) {
            let html = '';
            const ubicacion = `${lado}-${capilla}`;
            
            // 10 módulos por cama - IMPORTANTE: Los módulos se generan en orden normal
            // La dirección se controla con CSS (flex-direction)
            for (let modulo = 1; modulo <= 10; modulo++) {
                const moduloData = findPlagueData(data, ubicacion, cama, modulo);
                html += generateModulo(lado, capilla, cama, modulo, moduloData, plagaFiltro);
            }
            
            return html;
        }

        // Generar un módulo individual
        function generateModulo(lado, capilla, cama, modulo, moduloData, plagaFiltro) {
            let clase = 'modulo';
            let info = `Módulo ${modulo}`;
            let showModule = true;
            
            if (moduloData) {
                // Verificar si coincide con el filtro de plaga
                if (plagaFiltro !== 'todas' && moduloData.plaga !== plagaFiltro) {
                    showModule = false;
                } else {
                    clase += ` ${moduloData.plaga} con-plaga`;
                    const nombreUbicacion = lado === 'norte' ? `${capilla} NORTE` : `${capilla} SUR`;
                    info = `${getPlagaName(moduloData.plaga)}\nCantidad: ${moduloData.cantidad}\nFecha: ${formatDate(moduloData.fecha)}\nUbicación: ${nombreUbicacion} - C${cama} - M${modulo}\nEstado: ${getEstado(moduloData).toUpperCase()}`;
                }
            }
            
            if (!showModule) {
                return `<div class="modulo" style="opacity: 0.3; cursor: default;"></div>`;
            }
            
            return `<div class="${clase}" data-info="${info}"></div>`;
        }

        // Buscar datos de plaga para una ubicación específica
        function findPlagueData(data, ubicacion, cama, modulo) {
            return data.find(point => 
                point.ubicacion === ubicacion && 
                parseInt(point.cama) === cama && 
                parseInt(point.modulo) === modulo &&
                getEstado(point) === 'activo'  // Solo puntos activos
            );
        }

        // Actualizar estadísticas - SOLO PUNTOS ACTIVOS
        function updateStatistics(data, plagaFiltro) {
            let total = 0;
            let mosca = 0;
            let acaroRojo = 0;
            let acaroBlanco = 0;
            
            data.forEach(point => {
                // Solo contar puntos activos
                if (getEstado(point) === 'activo') {
                    if (plagaFiltro === 'todas' || point.plaga === plagaFiltro) {
                        total++;
                        if (point.plaga === 'mosca-blanca') mosca++;
                        else if (point.plaga === 'acaro-rojo') acaroRojo++;
                        else if (point.plaga === 'acaro-blanco') acaroBlanco++;
                    }
                }
            });
            
            totalModulos.textContent = total;
            totalMosca.textContent = mosca;
            totalAcaroRojo.textContent = acaroRojo;
            totalAcaroBlanco.textContent = acaroBlanco;
        }

        // Helper functions
        function getPlagaName(plaga) {
            const names = {
                'mosca-blanca': 'Mosca Blanca',
                'acaro-rojo': 'Ácaro Rojo',
                'acaro-blanco': 'Ácaro Blanco'
            };
            return names[plaga] || plaga;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        // Cargar datos desde Firebase
        function loadDataFromFirebase() {
            const plaguePointsRef = database.ref('plague-points');
            
            plaguePointsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const organizedData = {};

                if (data) {
                    // Organizar datos por invernadero
                    Object.keys(data).forEach(key => {
                        const point = data[key];
                        if (point && point.invernadero) {
                            if (!organizedData[point.invernadero]) {
                                organizedData[point.invernadero] = [];
                            }
                            organizedData[point.invernadero].push(point);
                        }
                    });

                    plagueData = organizedData;
                    generateInvernaderoMap();
                } else {
                    invernaderoMap.innerHTML = `
                        <div class="no-data">
                            <h3>No hay datos disponibles</h3>
                            <p>No se encontraron registros de plagas en la base de datos</p>
                        </div>
                    `;
                }
            }, (error) => {
                console.error('Error loading data:', error);
                invernaderoMap.innerHTML = `
                    <div class="no-data">
                        <h3>Error al cargar datos</h3>
                        <p>No se pudieron cargar los datos desde Firebase</p>
                    </div>
                `;
            });
        }

        // Inicializar
        function init() {
            // Event listeners
            invernaderoSelect.addEventListener('change', generateInvernaderoMap);
            plagaSelect.addEventListener('change', generateInvernaderoMap);
            
            // Cargar datos iniciales
            loadDataFromFirebase();
        }

        // Iniciar la aplicación
        init();
    </script>
</body>
</html>