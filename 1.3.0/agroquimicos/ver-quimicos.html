<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabla de Productos</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #45a049;
      --admin-color: #2196F3;
      --grower-junior-color: #FF9800;
      --digitador-color: #9C27B0;
      --tecnico-color: #607D8B;
      --supervisor-color: #FF5722;
      --invitado-color: #9E9E9E;
      --gerente-general-color: #E91E63;
      --gerente-produccion-color: #3F51B5;
      --jefe-vivero-color: #009688;
      --error-color: #f44336;
      --light-gray: #f5f5f5;
      --white: #ffffff;
      --dark-gray: #000000;
      --sidebar-bg: #2c3e50;
      --sidebar-hover: #34495e;
      --sidebar-active: #3498db;
      
      /* Colores para niveles de severidad */
      --bajo-color: #4CAF50;
      --medio-color: #FF9800;
      --alto-color: #f44336;
      
      /* Colores para estados */
      --activo-color: #4CAF50;
      --liberado-color: #9E9E9E;
      
      /* Colores específicos para reportes */
      --light-bg: #f1f8e9;
      --table-header: #c8e6c9;
      --light-border: #a5d6a7;
      --row-hover: #f1f8e9;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light-bg);
      color: var(--dark-gray);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      min-height: calc(100vh - 140px);
    }

    .container {
      background-color: var(--white);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .breadcrumb {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 15px;
    }

    .breadcrumb a {
      color: #3498db;
      text-decoration: none;
    }

    h1 {
      color: var(--primary-color);
      margin-bottom: 30px;
      text-align: center;
      font-size: 24px;
    }

    .card {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      border-radius: 8px;
      border: none;
    }
    
    .card-header {
      border-radius: 8px 8px 0 0 !important;
      font-weight: 600;
      color: white;
      padding: 15px 20px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--secondary-color);
    }

    .btn-secondary {
      background-color: var(--invitado-color);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
    }

    .btn-danger {
      background-color: var(--error-color);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
    }

    .controls-container {
      background-color: var(--white);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
    }

    .filtros-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .filtro-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 150px;
    }

    .filtro-label {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--dark-gray);
      font-size: 14px;
    }

    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    select:focus, input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1100px;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 8px;
      border: 1px solid #ddd;
      text-align: center;
      position: sticky;
      top: 0;
      font-size: 14px;
    }

    td {
      padding: 10px 8px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }

    tr:nth-child(even) {
      background-color: var(--light-gray);
    }

    tr:hover {
      background-color: var(--row-hover);
    }

    .loading {
      text-align: center;
      padding: 30px;
      font-style: italic;
      color: var(--primary-color);
    }

    .no-data {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .modal-small {
      max-width: 400px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      border-bottom: 1px solid var(--light-border);
      padding-bottom: 5px;
    }

    .modal-list {
      list-style-type: none;
    }

    .modal-list li {
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }

    .modal-list li:before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--primary-color);
    }

    .descarga-opciones {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .descarga-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background-color: #f5f5f5;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .descarga-btn:hover {
      background-color: #e8f5e9;
    }

    .descarga-icono {
      font-size: 20px;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-bottom: 20px;
    }

    .btn-leyenda {
      background-color: var(--admin-color);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
    }
    
    .btn-leyenda:hover {
      background-color: #1976d2;
    }

    .btn-descarga {
      background-color: var(--digitador-color);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
    }
    
    .btn-descarga:hover {
      background-color: #7b1fa2;
    }

    .btn-epa {
      background-color: var(--gerente-produccion-color);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 4px;
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-epa:hover {
      background-color: #303f9f;
      color: white;
    }

    .banda-color {
      display: inline-block;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      margin: 0 auto;
      border: 1px solid #ddd;
    }

    /* Estilos para enlaces EPA */
    .epa-link {
      color: var(--admin-color);
      text-decoration: none;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .epa-link:hover {
      color: #1976d2;
      text-decoration: underline;
    }

    .epa-link::after {
      content: "↗";
      font-size: 0.9em;
    }

    .no-link {
      color: #666;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .filtros-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filtro-group {
        min-width: 100%;
      }
      
      .header-buttons {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      button {
        flex: 1;
        min-width: 120px;
        justify-content: center;
      }
      
      th, td {
        padding: 8px 5px;
        font-size: 12px;
      }
    }

    @media (max-width: 576px) {
      .header-buttons {
        flex-wrap: wrap;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Contenido principal -->
  <main class="main-content">
    <div class="container">
      <div class="breadcrumb">
        <a href="index.html">Inicio</a> > <a href="productos.html">Productos</a> > Químicos Registrados
      </div>
      
      <h1><i class="fas fa-flask me-2"></i>Productos Químicos Registrados</h1>

      <div class="header-buttons">
        <a href="https://www.ecfr.gov/current/title-40/chapter-I/subchapter-E/part-180/subpart-B/section-180.41" target="_blank" class="btn-epa">
          <i class="fas fa-file-alt me-1"></i> Normativa EPA
        </a>
        <button class="btn-leyenda" onclick="mostrarLeyenda()">
          <i class="fas fa-book me-1"></i> Leyenda
        </button>
        <button class="btn-descarga" onclick="mostrarModalDescargas()">
          <i class="fas fa-download me-1"></i> Descargar
        </button>
      </div>

      <div class="controls-container">
        <div class="filtros-container">
          <div class="filtro-group">
            <label class="filtro-label" for="filtro-categoria">Categoría:</label>
            <select id="filtro-categoria">
              <option value="">Todas las categorías</option>
              <option value="Insecticida">Insecticida</option>
              <option value="Fungicida">Fungicida</option>
              <option value="Aminoácido">Aminoácido</option>
              <option value="Herbicida">Herbicida</option>
              <option value="Bactericida">Bactericida</option>
            </select>
          </div>
          <div class="filtro-group">
            <label class="filtro-label" for="filtro-grupo">Grupo Químico:</label>
            <select id="filtro-grupo">
              <option value="">Todos los grupos</option>
              <!-- Se llenará dinámicamente con JavaScript -->
            </select>
          </div>
          <div class="filtro-group">
            <label class="filtro-label" for="filtro-cultivo">Cultivo:</label>
            <select id="filtro-cultivo">
              <option value="">Todos los cultivos</option>
              <option value="mini">MINI</option>
              <option value="tomate">TOMATE</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header" style="background-color: var(--primary-color);">
          <h5 class="mb-0"><i class="fas fa-table me-2"></i>Lista de Productos</h5>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table id="tabla-productos-completa">
              <thead>
                <tr>
                  <th>Nombre Comercial</th>
                  <th>Grupo Químico</th>
                  <th>Familia Química</th>
                  <th>Ingrediente Activo</th>
                  <th>Dosis/Litro</th>
                  <th>Días a Cosecha</th>
                  <th>Periodo de Reingreso</th>
                  <th>Dosis Máxima</th>
                  <th>Plagas</th>
                  <th>Registro EPA</th>
                  <th>Registro Senasa</th>
                  <th>Banda</th>
                </tr>
              </thead>
              <tbody id="tabla-productos">
                <tr>
                  <td colspan="12" class="loading">
                    <div class="spinner-border text-success" role="status"></div>
                    Cargando datos...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Leyenda -->
  <div id="modalLeyenda" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarLeyenda()">&times;</span>
      <h2>Leyenda de Bandas</h2>
      
      <div class="modal-section">
        <h3>Colores de Bandas</h3>
        <ul class="modal-list">
          <li><div class="banda-color" style="background-color: #4CAF50"></div> Verde - Baja toxicidad</li>
          <li><div class="banda-color" style="background-color: #2196F3"></div> Azul - Toxicidad moderada</li>
          <li><div class="banda-color" style="background-color: #FFEB3B"></div> Amarilla - Alta toxicidad</li>
          <li><div class="banda-color" style="background-color: #F44336"></div> Roja - Muy alta toxicidad</li>
          <li><div class="banda-color" style="background-color: #9E9E9E"></div> Gris - Sin clasificación</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal de Descargas -->
  <div id="modalDescargas" class="modal">
    <div class="modal-content modal-small">
      <span class="close" onclick="cerrarModalDescargas()">&times;</span>
      <h2>Opciones de Descarga</h2>
      
      <div class="descarga-opciones">
        <div class="descarga-btn" onclick="exportarExcel()">
          <span class="descarga-icono"><i class="fas fa-file-excel"></i></span>
          <span>Descargar como Excel</span>
        </div>
        
        <div class="descarga-btn" onclick="capturarTabla()">
          <span class="descarga-icono"><i class="fas fa-file-image"></i></span>
          <span>Descargar como Imagen</span>
        </div>
        
        <div class="descarga-btn" onclick="window.print()">
          <span class="descarga-icono"><i class="fas fa-print"></i></span>
          <span>Imprimir Tabla</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <!-- html2canvas para capturar la tabla como imagen -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDN0rsDAaXoZ9ERSQF2WdDB4IIevYAyp1k",
      authDomain: "agro-productos.firebaseapp.com",
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com",
      projectId: "agro-productos",
      storageBucket: "agro-productos.appspot.com",
      messagingSenderId: "196774282512",
      appId: "1:196774282512:web:92697209153eac8acb1195"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tabla = document.getElementById("tabla-productos");
    const filtroCategoria = document.getElementById("filtro-categoria");
    const filtroGrupo = document.getElementById("filtro-grupo");
    const filtroCultivo = document.getElementById("filtro-cultivo");
    const modalLeyenda = document.getElementById("modalLeyenda");
    const modalDescargas = document.getElementById("modalDescargas");
    
    let productos = [];
    let gruposQuimicos = new Set();

    // Función para mostrar el modal de leyenda
    function mostrarLeyenda() {
      modalLeyenda.style.display = "block";
    }

    // Función para cerrar el modal de leyenda
    function cerrarLeyenda() {
      modalLeyenda.style.display = "none";
    }

    // Función para mostrar el modal de descargas
    function mostrarModalDescargas() {
      modalDescargas.style.display = "block";
    }

    // Función para cerrar el modal de descargas
    function cerrarModalDescargas() {
      modalDescargas.style.display = "none";
    }

    // Cerrar el modal al hacer clic fuera de él
    window.onclick = function(event) {
      if (event.target == modalLeyenda) {
        cerrarLeyenda();
      }
      if (event.target == modalDescargas) {
        cerrarModalDescargas();
      }
    }

    // Cargar datos
    db.ref("productos").on("value", snapshot => {
      productos = [];
      gruposQuimicos.clear();
      snapshot.forEach(child => {
        const producto = child.val();
        producto.id = child.key;
        productos.push(producto);
        
        // Recopilar grupos químicos únicos
        if (producto.grupo_quimico) {
          gruposQuimicos.add(producto.grupo_quimico);
        }
      });
      
      // Ordenar productos por nombre comercial (alfabéticamente)
      productos.sort((a, b) => {
        const nombreA = a.nombre || '';
        const nombreB = b.nombre || '';
        return nombreA.localeCompare(nombreB, 'es', { sensitivity: 'base' });
      });
      
      // Actualizar filtro de grupos químicos
      actualizarFiltroGrupos();
      mostrarProductos(productos);
    });

    // Actualizar el filtro de grupos químicos
    function actualizarFiltroGrupos() {
      // Limpiar opciones actuales excepto la primera
      while (filtroGrupo.options.length > 1) {
        filtroGrupo.remove(1);
      }
      
      // Agregar grupos químicos únicos
      gruposQuimicos.forEach(grupo => {
        const option = document.createElement("option");
        option.value = grupo;
        option.textContent = grupo;
        filtroGrupo.appendChild(option);
      });
    }

    // Filtrar productos
    function filtrarProductos() {
      const categoria = filtroCategoria.value;
      const grupo = filtroGrupo.value;
      const cultivo = filtroCultivo.value;
      
      const resultados = productos.filter(p => {
        const coincideCategoria = !categoria || p.categoria === categoria;
        const coincideGrupo = !grupo || p.grupo_quimico === grupo;
        
        // Filtro por cultivo
        let coincideCultivo = true;
        if (cultivo === "mini") {
          coincideCultivo = p.dias_mini || p.reingreso_mini || p.plagas_mini;
        } else if (cultivo === "tomate") {
          coincideCultivo = p.dias_tomate || p.reingreso_tomate || p.plagas_tomate;
        }
        
        return coincideCategoria && coincideGrupo && coincideCultivo;
      });
      
      mostrarProductos(resultados);
    }

    // Función para obtener color según la banda (compatible con español e inglés)
    function obtenerColorBanda(banda) {
      if (!banda) return '#9E9E9E'; // Gris para bandas desconocidas
      
      const bandaLower = banda.toLowerCase();
      
      // Verde / Green
      if (bandaLower.includes('verde') || bandaLower.includes('green')) return '#4CAF50';
      
      // Azul / Blue
      if (bandaLower.includes('azul') || bandaLower.includes('blue')) return '#2196F3';
      
      // Amarilla / Yellow
      if (bandaLower.includes('amarill') || bandaLower.includes('yellow')) return '#FFEB3B';
      
      // Roja / Red
      if (bandaLower.includes('roja') || bandaLower.includes('rojo') || 
          bandaLower.includes('red')) return '#F44336';
      
      return '#9E9E9E'; // Gris por defecto
    }

    // Función para crear enlaces EPA (compatible con formato antiguo y nuevo)
    function crearEnlacesEPA(producto) {
      // Formato nuevo: array de registros EPA
      if (producto.registros_epa && Array.isArray(producto.registros_epa) && producto.registros_epa.length > 0) {
        let enlacesHTML = '';
        
        producto.registros_epa.forEach((registro, index) => {
          if (registro.registro) {
            if (registro.enlace) {
              // Verificar si el enlace ya tiene protocolo, si no, agregar https://
              let url = registro.enlace;
              if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
              }
              
              enlacesHTML += `<a href="${url}" target="_blank" class="epa-link" title="Abrir enlace EPA">${registro.registro}</a>`;
            } else {
              enlacesHTML += `<span title="Sin enlace EPA">${registro.registro}</span>`;
            }
            
            // Agregar separador si hay más registros
            if (index < producto.registros_epa.length - 1) {
              enlacesHTML += ', ';
            }
          }
        });
        
        return enlacesHTML || '<span class="no-link">-</span>';
      }
      // Formato antiguo: campos individuales
      else if (producto.epa) {
        if (producto.enlace_epa) {
          // Verificar si el enlace ya tiene protocolo, si no, agregar https://
          let url = producto.enlace_epa;
          if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
          }
          
          return `<a href="${url}" target="_blank" class="epa-link" title="Abrir enlace EPA">${producto.epa}</a>`;
        }
        
        return `<span title="Sin enlace EPA">${producto.epa}</span>`;
      }
      
      return '<span class="no-link">-</span>';
    }

    // Mostrar productos en tabla
    function mostrarProductos(lista) {
      // Asegurar que la lista esté ordenada por nombre comercial
      lista.sort((a, b) => {
        const nombreA = a.nombre || '';
        const nombreB = b.nombre || '';
        return nombreA.localeCompare(nombreB, 'es', { sensitivity: 'base' });
      });
      
      tabla.innerHTML = lista.map(p => {
        // Determinar qué datos mostrar según el filtro de cultivo
        const cultivoFiltro = filtroCultivo.value;
        let dias, reingreso, plagas, dosisMaxima, dosisLitro;
        
        if (cultivoFiltro === "mini" || (!cultivoFiltro && p.dias_mini)) {
          dias = p.dias_mini;
          reingreso = p.reingreso_mini;
          plagas = p.plagas_mini;
          dosisMaxima = p.dosis_maxima_mini;
          dosisLitro = p.dosis_litro_mini;
        } else if (cultivoFiltro === "tomate" || (!cultivoFiltro && p.dias_tomate && !p.dias_mini)) {
          dias = p.dias_tomate;
          reingreso = p.reingreso_tomate;
          plagas = p.plagas_tomate;
          dosisMaxima = p.dosis_maxima_tomate;
          dosisLitro = p.dosis_litro_tomate;
        } else {
          // Si no hay filtro y hay datos para ambos cultivos, mostrar MINI por defecto
          dias = p.dias_mini || p.dias_tomate;
          reingreso = p.reingreso_mini || p.reingreso_tomate;
          plagas = p.plagas_mini || p.plagas_tomate;
          dosisMaxima = p.dosis_maxima_mini || p.dosis_maxima_tomate;
          dosisLitro = p.dosis_litro_mini || p.dosis_litro_tomate;
        }
        
        // Obtener color para la banda
        const colorBanda = obtenerColorBanda(p.banda);
        
        // Crear enlaces EPA (compatible con formato antiguo y nuevo)
        const enlacesEPA = crearEnlacesEPA(p);
        
        return `
          <tr>
            <td>${p.nombre || '-'}</td>
            <td>${p.grupo_quimico || '-'}</td>
            <td>${p.familia_quimica || '-'}</td>
            <td>${p.ingredientes || '-'}</td>
            <td>${dosisLitro || '-'}</td>
            <td>${dias || '-'}</td>
            <td>${reingreso || '-'}</td>
            <td>${dosisMaxima || '-'}</td>
            <td>${plagas || '-'}</td>
            <td>${enlacesEPA}</td>
            <td>${p.senasa || '-'}</td>
            <td><div class="banda-color" style="background-color: ${colorBanda}" title="${p.banda || 'Sin banda'}"></div></td>
          </tr>
        `;
      }).join('');
    }

    // Exportar a Excel (simulado)
    function exportarExcel() {
      const cultivoFiltro = filtroCultivo.value;
      
      // Crear tabla HTML para exportar
      let tablaHTML = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
        <head>
          <meta charset="UTF-8">
          <style>
            td { mso-number-format:"\\@"; }
          </style>
        </head>
        <body>
          <table>
            <thead>
              <tr>
                <th>Nombre Comercial</th>
                <th>Grupo Químico</th>
                <th>Familia Química</th>
                <th>Ingrediente Activo</th>
                <th>Dosis/Litro</th>
                <th>Días a Cosecha</th>
                <th>Periodo de Reingreso</th>
                <th>Dosis Máxima</th>
                <th>Plagas</th>
                <th>Registro EPA</th>
                <th>Registro Senasa</th>
                <th>Banda</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      // Ordenar productos para exportación
      const productosOrdenados = [...productos].sort((a, b) => {
        const nombreA = a.nombre || '';
        const nombreB = b.nombre || '';
        return nombreA.localeCompare(nombreB, 'es', { sensitivity: 'base' });
      });
      
      productosOrdenados.forEach(p => {
        // Para exportar, incluimos ambos cultivos si no hay filtro
        if (!cultivoFiltro) {
          if (p.dias_mini) {
            // Formatear registros EPA para exportación (compatible con ambos formatos)
            let epaText = '';
            if (p.registros_epa && Array.isArray(p.registros_epa)) {
              epaText = p.registros_epa.map(r => r.registro).filter(r => r).join(', ');
            } else if (p.epa) {
              epaText = p.epa;
            }
            
            tablaHTML += `
              <tr>
                <td>${p.nombre || ''}</td>
                <td>${p.grupo_quimico || ''}</td>
                <td>${p.familia_quimica || ''}</td>
                <td>${p.ingredientes || ''}</td>
                <td>${p.dosis_litro_mini || ''}</td>
                <td>${p.dias_mini || ''}</td>
                <td>${p.reingreso_mini || ''}</td>
                <td>${p.dosis_maxima_mini || ''}</td>
                <td>${p.plagas_mini || ''}</td>
                <td>${epaText || ''}</td>
                <td>${p.senasa || ''}</td>
                <td>${p.banda || ''}</td>
              </tr>
            `;
          }
          if (p.dias_tomate) {
            // Formatear registros EPA para exportación (compatible con ambos formatos)
            let epaText = '';
            if (p.registros_epa && Array.isArray(p.registros_epa)) {
              epaText = p.registros_epa.map(r => r.registro).filter(r => r).join(', ');
            } else if (p.epa) {
              epaText = p.epa;
            }
            
            tablaHTML += `
              <tr>
                <td>${p.nombre || ''}</td>
                <td>${p.grupo_quimico || ''}</td>
                <td>${p.familia_quimica || ''}</td>
                <td>${p.ingredientes || ''}</td>
                <td>${p.dosis_litro_tomate || ''}</td>
                <td>${p.dias_tomate || ''}</td>
                <td>${p.reingreso_tomate || ''}</td>
                <td>${p.dosis_maxima_tomate || ''}</td>
                <td>${p.plagas_tomate || ''}</td>
                <td>${epaText || ''}</td>
                <td>${p.senasa || ''}</td>
                <td>${p.banda || ''}</td>
              </tr>
            `;
          }
        } else {
          // Si hay filtro, exportar solo el cultivo seleccionado
          const datos = cultivoFiltro === "mini" ? 
            {dias: p.dias_mini, reingreso: p.reingreso_mini, plagas: p.plagas_mini, 
             dosisMaxima: p.dosis_maxima_mini, dosisLitro: p.dosis_litro_mini, cultivo: "MINI"} :
            {dias: p.dias_tomate, reingreso: p.reingreso_tomate, plagas: p.plagas_tomate, 
             dosisMaxima: p.dosis_maxima_tomate, dosisLitro: p.dosis_litro_tomate, cultivo: "TOMATE"};
          
          if (datos.dias || datos.reingreso || datos.plagas) {
            // Formatear registros EPA para exportación (compatible con ambos formatos)
            let epaText = '';
            if (p.registros_epa && Array.isArray(p.registros_epa)) {
              epaText = p.registros_epa.map(r => r.registro).filter(r => r).join(', ');
            } else if (p.epa) {
              epaText = p.epa;
            }
            
            tablaHTML += `
              <tr>
                <td>${p.nombre || ''}</td>
                <td>${p.grupo_quimico || ''}</td>
                <td>${p.familia_quimica || ''}</td>
                <td>${p.ingredientes || ''}</td>
                <td>${datos.dosisLitro || ''}</td>
                <td>${datos.dias || ''}</td>
                <td>${datos.reingreso || ''}</td>
                <td>${datos.dosisMaxima || ''}</td>
                <td>${datos.plagas || ''}</td>
                <td>${epaText || ''}</td>
                <td>${p.senasa || ''}</td>
                <td>${p.banda || ''}</td>
              </tr>
            `;
          }
        }
      });
      
      tablaHTML += `
            </tbody>
          </table>
        </body>
        </html>
      `;
      
      const blob = new Blob([tablaHTML], { type: "application/vnd.ms-excel" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      
      link.setAttribute("href", url);
      link.setAttribute("download", "productos_quimicos.xls");
      link.style.visibility = "hidden";
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Cerrar el modal después de la acción
      cerrarModalDescargas();
    }

    // Capturar tabla como imagen
    function capturarTabla() {
      html2canvas(document.getElementById("tabla-productos-completa")).then(canvas => {
        const link = document.createElement("a");
        link.download = "tabla_productos.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
      
      // Cerrar el modal después de la acción
      cerrarModalDescargas();
    }

    // Eventos
    filtroCategoria.addEventListener("change", filtrarProductos);
    filtroGrupo.addEventListener("change", filtrarProductos);
    filtroCultivo.addEventListener("change", filtrarProductos);
  </script>
</body>
</html>