<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Productos Químicos</title>
  <style>
    :root {
      --primary-color: #2e7d32;
      --primary-hover: #1b5e20;
      --light-bg: #f1fdf3;
      --light-border: #c8e6c9;
      --white: #ffffff;
      --shadow: rgba(0,0,0,0.1);
      --danger: #f44336;
      --warning: #ff9800;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: var(--light-bg);
      margin: 0;
      padding: 20px;
      color: var(--primary-color);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2 {
      text-align: center;
      color: var(--primary-color);
    }
    
    .search-section {
      background: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--shadow);
      margin-bottom: 20px;
    }
    
    .search-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }
    
    .search-group {
      flex: 1;
      min-width: 200px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--light-border);
      border-radius: 5px;
      font-size: 16px;
    }
    
    button {
      padding: 10px 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    button:hover {
      background: var(--primary-hover);
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-danger:hover {
      background-color: #d32f2f;
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-warning:hover {
      background-color: #f57c00;
    }
    
    .results-section {
      background: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--shadow);
      margin-bottom: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--light-border);
    }
    
    th {
      background-color: var(--light-bg);
      color: var(--primary-color);
    }
    
    tr:hover {
      background-color: #e8f5e9;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .edit-form {
      background: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--shadow);
      margin-bottom: 20px;
      display: none;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .form-row .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .cultivo-section {
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
    }
    
    .cultivo-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    
    .quimica-section {
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
    }
    
    .footer {
      text-align: center;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 5px;
      margin-top: 20px;
    }
    
    .success {
      color: green;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .form-row, .search-form {
        flex-direction: column;
        gap: 10px;
      }
      
      .form-group, .search-group {
        min-width: 100%;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editar Productos Químicos</h1>
    
    <!-- Búsqueda de registros -->
    <div class="search-section">
      <h2>Buscar Productos</h2>
      <div class="search-form">
        <div class="search-group">
          <label for="search-nombre">Nombre del producto:</label>
          <input type="text" id="search-nombre" placeholder="Ej: Insecticida X">
        </div>
        
        <div class="search-group">
          <label for="search-ingredientes">Ingredientes activos:</label>
          <input type="text" id="search-ingredientes" placeholder="Ej: Abamectina">
        </div>
        
        <div class="search-group">
          <label for="search-categoria">Categoría:</label>
          <select id="search-categoria">
            <option value="">Todas las categorías</option>
            <option value="Insecticida">Insecticida</option>
            <option value="Fungicida">Fungicida</option>
            <option value="Aminoácido">Aminoácido</option>
            <option value="Estimulador">Estimulador</option>
            <option value="Herbicida">Herbicida</option>
            <option value="Bactericida">Bactericida</option>
          </select>
        </div>
        
        <div class="search-group">
          <button id="search-button">Buscar</button>
        </div>
      </div>
    </div>
    
    <!-- Resultados de búsqueda -->
    <div class="results-section">
      <h2>Resultados</h2>
      <div id="search-results">
        <p>Realice una búsqueda para ver los productos.</p>
      </div>
    </div>
    
    <!-- Formulario de edición (inicialmente oculto) -->
    <div class="edit-form" id="edit-form">
      <h2>Editar Producto</h2>
      <form id="edit-producto-form">
        <input type="hidden" id="edit-key">
        
        <div class="form-group">
          <input type="text" id="edit-nombre" placeholder="Nombre comercial" required />
        </div>
        
        <div class="form-group">
          <input type="text" id="edit-ingredientes" placeholder="Ingredientes activos" required />
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <input type="text" id="edit-senasa" placeholder="Registro Senasa" required />
          </div>
          
          <div class="form-group">
            <input type="text" id="edit-epa" placeholder="Registro EPA" />
          </div>
        </div>
        
        <!-- Nuevo campo: Enlace EPA -->
        <div class="form-group">
          <input type="url" id="edit-enlace_epa" placeholder="Enlace EPA (URL)" pattern="https?://.+" title="Ingrese una URL válida que comience con http:// o https://" />
        </div>
        
        <div class="form-group">
          <label for="edit-categoria">Categoría:</label>
          <select id="edit-categoria" required>
            <option value="" disabled selected>Seleccione una categoría</option>
            <option value="Insecticida">Insecticida</option>
            <option value="Fungicida">Fungicida</option>
            <option value="Aminoácido">Aminoácido</option>
            <option value="Estimulador">Estimulador</option>
            <option value="Herbicida">Herbicida</option>
            <option value="Bactericida">Bactericida</option>
          </select>
        </div>
        
        <!-- Nueva sección para Grupo Químico y Familia Química -->
        <div class="quimica-section">
          <div class="cultivo-title">INFORMACIÓN QUÍMICA</div>
          
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="edit-grupo_quimico" placeholder="Grupo químico" required />
            </div>
            
            <div class="form-group">
              <input type="text" id="edit-familia_quimica" placeholder="Familia química" required />
            </div>
          </div>
        </div>
        
        <!-- Sección para MINI PEPINO -->
        <div class="cultivo-section">
          <div class="cultivo-title">MINI</div>
          
          <div class="form-row">
            <div class="form-group">
              <input type="number" id="edit-dias_mini" placeholder="Días a cosecha (Mini)" required />
            </div>
            
            <div class="form-group">
              <input type="text" id="edit-reingreso_mini" placeholder="Periodo de reingreso (Mini)" required />
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit-plagas_mini">Plagas a controlar (Mini):</label>
            <div class="plagas-container">
              <input type="text" id="edit-plagas_mini" list="plagas-sugerencias" placeholder="Escriba o seleccione una plaga" required />
              <datalist id="plagas-sugerencias"></datalist>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="edit-dosis_maxima_mini" placeholder="Dosis máxima (Mini)" />
            </div>
            
            <div class="form-group">
              <input type="text" id="edit-dosis_litro_mini" placeholder="Dosis por litro de agua (Mini)" />
            </div>
          </div>
        </div>
        
        <!-- Sección para TOMATE -->
        <div class="cultivo-section">
          <div class="cultivo-title">TOMATE</div>
          
          <div class="form-row">
            <div class="form-group">
              <input type="number" id="edit-dias_tomate" placeholder="Días a cosecha (Tomate)" required />
            </div>
            
            <div class="form-group">
              <input type="text" id="edit-reingreso_tomate" placeholder="Periodo de reingreso (Tomate)" required />
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit-plagas_tomate">Plagas a controlar (Tomate):</label>
            <div class="plagas-container">
              <input type="text" id="edit-plagas_tomate" list="plagas-sugerencias" placeholder="Escriba o seleccione una plaga" required />
              <datalist id="plagas-sugerencias"></datalist>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="edit-dosis_maxima_tomate" placeholder="Dosis máxima (Tomate)" />
            </div>
            
            <div class="form-group">
              <input type="text" id="edit-dosis_litro_tomate" placeholder="Dosis por litro de agua (Tomate)" />
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="edit-banda">Banda:</label>
          <select id="edit-banda" required>
            <option value="" disabled selected>Seleccione un color</option>
            <option value="red">Rojo</option>
            <option value="yellow">Amarillo</option>
            <option value="blue">Azul</option>
            <option value="green">Verde</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <button type="submit" class="btn-warning">Actualizar Producto</button>
            <button type="button" id="cancel-edit" class="btn-danger">Cancelar</button>
          </div>
        </div>
        
        <div class="success" id="edit-mensaje"></div>
      </form>
    </div>
    
    <div class="footer">
      <p>Sistema Agroalpha © 2025 | Unidad produccion 1</p>
      <p>Versión 2.0 - Módulo de edición</p>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDN0rsDAaXoZ9ERSQF2WdDB4IIevYAyp1k",
      authDomain: "agro-productos.firebaseapp.com",
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com",
      projectId: "agro-productos",
      storageBucket: "agro-productos.appspot.com",
      messagingSenderId: "196774282512",
      appId: "1:196774282512:web:92697209153eac8acb1195"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Referencia a la base de datos
    const productosRef = db.ref("productos");
    const plagasRef = db.ref("plagas");
    
    // Elementos DOM
    const searchButton = document.getElementById("search-button");
    const searchResults = document.getElementById("search-results");
    const editForm = document.getElementById("edit-form");
    const editProductoForm = document.getElementById("edit-producto-form");
    const cancelEdit = document.getElementById("cancel-edit");
    
    // Cargar sugerencias de plagas desde Firebase
    let plagasSugerencias = [];
    
    plagasRef.on("value", (snapshot) => {
      const data = snapshot.val();
      plagasSugerencias = data ? Object.values(data) : [];
      
      // Actualizar datalist
      const datalist = document.getElementById("plagas-sugerencias");
      datalist.innerHTML = '';
      
      plagasSugerencias.forEach(plaga => {
        const option = document.createElement('option');
        option.value = plaga;
        datalist.appendChild(option);
      });
    });
    
    // Buscar registros
    searchButton.addEventListener("click", searchProducts);
    
    function searchProducts() {
      const nombreSearch = document.getElementById("search-nombre").value.toLowerCase();
      const ingredientesSearch = document.getElementById("search-ingredientes").value.toLowerCase();
      const categoriaSearch = document.getElementById("search-categoria").value;
      
      productosRef.once("value")
        .then((snapshot) => {
          let resultsHTML = "";
          let hasResults = false;
          
          snapshot.forEach((childSnapshot) => {
            const key = childSnapshot.key;
            const data = childSnapshot.val();
            
            // Aplicar filtros
            if (
              (nombreSearch === "" || data.nombre.toLowerCase().includes(nombreSearch)) &&
              (ingredientesSearch === "" || data.ingredientes.toLowerCase().includes(ingredientesSearch)) &&
              (categoriaSearch === "" || data.categoria === categoriaSearch)
            ) {
              hasResults = true;
              resultsHTML += `
                <tr>
                  <td>${data.nombre}</td>
                  <td>${data.ingredientes}</td>
                  <td>${data.categoria}</td>
                  <td>${data.senasa}</td>
                  <td class="action-buttons">
                    <button class="edit-product" data-key="${key}">Editar</button>
                    <button class="delete-product" data-key="${key}">Eliminar</button>
                  </td>
                </tr>
              `;
            }
          });
          
          if (hasResults) {
            searchResults.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Ingredientes</th>
                    <th>Categoría</th>
                    <th>Registro Senasa</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  ${resultsHTML}
                </tbody>
              </table>
            `;
            
            // Agregar event listeners a los botones de editar y eliminar
            document.querySelectorAll(".edit-product").forEach(button => {
              button.addEventListener("click", function() {
                const key = this.getAttribute("data-key");
                loadProductForEditing(key);
              });
            });
            
            document.querySelectorAll(".delete-product").forEach(button => {
              button.addEventListener("click", function() {
                const key = this.getAttribute("data-key");
                if (confirm("¿Está seguro de que desea eliminar este producto?")) {
                  deleteProduct(key);
                }
              });
            });
            
          } else {
            searchResults.innerHTML = "<p>No se encontraron productos que coincidan con los criterios de búsqueda.</p>";
          }
        })
        .catch((error) => {
          console.error("Error al buscar productos:", error);
          searchResults.innerHTML = "<p>Ocurrió un error al buscar los productos.</p>";
        });
    }
    
    // Cargar producto para edición
    function loadProductForEditing(key) {
      productosRef.child(key).once("value")
        .then((snapshot) => {
          const data = snapshot.val();
          
          // Guardar la clave del producto
          document.getElementById("edit-key").value = key;
          
          // Llenar el formulario con los datos existentes
          document.getElementById("edit-nombre").value = data.nombre || "";
          document.getElementById("edit-ingredientes").value = data.ingredientes || "";
          document.getElementById("edit-senasa").value = data.senasa || "";
          document.getElementById("edit-epa").value = data.epa || "";
          document.getElementById("edit-enlace_epa").value = data.enlace_epa || "";
          document.getElementById("edit-categoria").value = data.categoria || "";
          document.getElementById("edit-grupo_quimico").value = data.grupo_quimico || "";
          document.getElementById("edit-familia_quimica").value = data.familia_quimica || "";
          
          // Datos para MINI PEPINO
          document.getElementById("edit-dias_mini").value = data.dias_mini || "";
          document.getElementById("edit-reingreso_mini").value = data.reingreso_mini || "";
          document.getElementById("edit-plagas_mini").value = data.plagas_mini || "";
          document.getElementById("edit-dosis_maxima_mini").value = data.dosis_maxima_mini || "";
          document.getElementById("edit-dosis_litro_mini").value = data.dosis_litro_mini || "";
          
          // Datos para TOMATE
          document.getElementById("edit-dias_tomate").value = data.dias_tomate || "";
          document.getElementById("edit-reingreso_tomate").value = data.reingreso_tomate || "";
          document.getElementById("edit-plagas_tomate").value = data.plagas_tomate || "";
          document.getElementById("edit-dosis_maxima_tomate").value = data.dosis_maxima_tomate || "";
          document.getElementById("edit-dosis_litro_tomate").value = data.dosis_litro_tomate || "";
          
          document.getElementById("edit-banda").value = data.banda || "";
          
          // Mostrar el formulario de edición
          editForm.style.display = "block";
          
          // Desplazarse al formulario de edición
          editForm.scrollIntoView({ behavior: 'smooth' });
        })
        .catch((error) => {
          console.error("Error al cargar el producto:", error);
          alert("Ocurrió un error al cargar el producto para edición.");
        });
    }
    
    // Actualizar producto
    editProductoForm.addEventListener("submit", function(e) {
      e.preventDefault();
      
      const key = document.getElementById("edit-key").value;
      
      const plagaMiniInput = document.getElementById("edit-plagas_mini").value.trim();
      const plagaTomateInput = document.getElementById("edit-plagas_tomate").value.trim();
      
      // Guardar las nuevas plagas si no existen en las sugerencias
      if (plagaMiniInput && !plagasSugerencias.includes(plagaMiniInput)) {
        db.ref("plagas").push(plagaMiniInput);
      }
      
      if (plagaTomateInput && !plagasSugerencias.includes(plagaTomateInput)) {
        db.ref("plagas").push(plagaTomateInput);
      }
      
      const producto = {
        nombre: document.getElementById("edit-nombre").value,
        ingredientes: document.getElementById("edit-ingredientes").value,
        senasa: document.getElementById("edit-senasa").value,
        epa: document.getElementById("edit-epa").value,
        enlace_epa: document.getElementById("edit-enlace_epa").value,
        categoria: document.getElementById("edit-categoria").value,
        grupo_quimico: document.getElementById("edit-grupo_quimico").value,
        familia_quimica: document.getElementById("edit-familia_quimica").value,
        // Datos para MINI PEPINO
        dias_mini: document.getElementById("edit-dias_mini").value,
        reingreso_mini: document.getElementById("edit-reingreso_mini").value,
        plagas_mini: plagaMiniInput,
        dosis_maxima_mini: document.getElementById("edit-dosis_maxima_mini").value,
        dosis_litro_mini: document.getElementById("edit-dosis_litro_mini").value,
        // Datos para TOMATE
        dias_tomate: document.getElementById("edit-dias_tomate").value,
        reingreso_tomate: document.getElementById("edit-reingreso_tomate").value,
        plagas_tomate: plagaTomateInput,
        dosis_maxima_tomate: document.getElementById("edit-dosis_maxima_tomate").value,
        dosis_litro_tomate: document.getElementById("edit-dosis_litro_tomate").value,
        banda: document.getElementById("edit-banda").value
      };
      
      // Actualizar en Firebase
      productosRef.child(key).update(producto)
        .then(() => {
          const mensaje = document.getElementById("edit-mensaje");
          mensaje.textContent = "✅ Producto actualizado correctamente.";
          mensaje.style.color = "green";
          
          // Ocultar mensaje después de 3 segundos
          setTimeout(() => {
            mensaje.textContent = "";
          }, 3000);
          
          // Actualizar la lista de resultados
          searchProducts();
        })
        .catch((error) => {
          console.error("Error al actualizar:", error);
          const mensaje = document.getElementById("edit-mensaje");
          mensaje.textContent = "❌ Error al actualizar el producto.";
          mensaje.style.color = "red";
        });
    });
    
    // Cancelar edición
    cancelEdit.addEventListener("click", function() {
      editForm.style.display = "none";
    });
    
    // Eliminar producto
    function deleteProduct(key) {
      productosRef.child(key).remove()
        .then(() => {
          alert("✅ Producto eliminado correctamente.");
          searchProducts(); // Actualizar la lista de resultados
        })
        .catch((error) => {
          console.error("Error al eliminar:", error);
          alert("Ocurrió un error al eliminar el producto.");
        });
    }
    
    // Al cargar la página, buscar todos los productos
    window.addEventListener("load", searchProducts);
  </script>
</body>
</html>
