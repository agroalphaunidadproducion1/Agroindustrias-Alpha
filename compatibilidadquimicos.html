<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recomendación de Grupos Químicos</title>
  <style>
    :root {
      --primary-color: #2e7d32;
      --primary-hover: #1b5e20;
      --light-bg: #f1fdf3;
      --light-border: #c8e6c9;
      --white: #ffffff;
      --shadow: rgba(0,0,0,0.1);
      --red: #f44336;
      --yellow: #ffeb3b;
      --blue: #2196f3;
      --green: #4caf50;
      --nervous-system: #e3f2fd; /* Celeste para sistema nervioso */
      --growth-development: #f3e5f5; /* Lila para crecimiento y desarrollo */
      --respiration: #ffebee; /* Rojo claro para respiración */
      --digestive-system: #fff3e0; /* Naranja claro para sistema digestivo */
      --unknown-action: #f5f5f5; /* Gris claro para modo desconocido */
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: var(--light-bg);
      margin: 0;
      padding: 20px;
      color: var(--primary-color);
      min-height: 100vh;
    }
    
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-top: 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .card {
      background: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--shadow);
      position: relative;
    }
    
    .info-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
    
    .info-button:hover {
      background: var(--primary-hover);
    }
    
    .search-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .search-group {
      flex: 1;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--light-border);
      border-radius: 5px;
      font-size: 16px;
    }
    
    .main-content {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .selected-section {
      flex: 1;
      min-width: 300px;
    }
    
    .recommendations-section {
      flex: 2;
      min-width: 300px;
    }
    
    .selected-product {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      margin-bottom: 20px;
    }
    
    .nervous-system {
      background-color: var(--nervous-system);
      border-left: 4px solid #2196f3;
    }
    
    .growth-development {
      background-color: var(--growth-development);
      border-left: 4px solid #9c27b0;
    }
    
    .respiration {
      background-color: var(--respiration);
      border-left: 4px solid #f44336;
    }
    
    .digestive-system {
      background-color: var(--digestive-system);
      border-left: 4px solid #ff9800;
    }
    
    .unknown-action {
      background-color: var(--unknown-action);
      border-left: 4px solid #9e9e9e;
    }
    
    .product-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--light-border);
      border-radius: 5px;
      padding: 10px;
    }
    
    .product-item {
      padding: 10px;
      border-bottom: 1px solid var(--light-border);
      cursor: pointer;
    }
    
    .product-item:hover {
      background-color: #f1f8e9;
    }
    
    .product-item.selected {
      background-color: #ffebee;
    }
    
    .product-item.nervous-system {
      background-color: var(--nervous-system);
    }
    
    .product-item.growth-development {
      background-color: var(--growth-development);
    }
    
    .product-item.respiration {
      background-color: var(--respiration);
    }
    
    .product-item.digestive-system {
      background-color: var(--digestive-system);
    }
    
    .product-item.unknown-action {
      background-color: var(--unknown-action);
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .banda-indicator {
      display: inline-block;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .banda-red { background-color: var(--red); }
    .banda-yellow { background-color: var(--yellow); }
    .banda-blue { background-color: var(--blue); }
    .banda-green { background-color: var(--green); }
    
    .recommendation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .recommendation-item {
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px var(--shadow);
      border-left: 4px solid var(--primary-color);
    }
    
    .recommendation-item.nervous-system {
      background-color: var(--nervous-system);
      border-left: 4px solid #2196f3;
    }
    
    .recommendation-item.growth-development {
      background-color: var(--growth-development);
      border-left: 4px solid #9c27b0;
    }
    
    .recommendation-item.respiration {
      background-color: var(--respiration);
      border-left: 4px solid #f44336;
    }
    
    .recommendation-item.digestive-system {
      background-color: var(--digestive-system);
      border-left: 4px solid #ff9800;
    }
    
    .recommendation-item.unknown-action {
      background-color: var(--unknown-action);
      border-left: 4px solid #9e9e9e;
    }
    
    .product-info {
      margin-bottom: 10px;
    }
    
    .product-info div {
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .mode-of-action {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      background-color: #e8f5e9;
      color: var(--primary-color);
      margin-left: 8px;
    }
    
    .nervous-system-mode {
      background-color: #bbdefb;
      color: #0d47a1;
    }
    
    .growth-development-mode {
      background-color: #e1bee7;
      color: #4a148c;
    }
    
    .respiration-mode {
      background-color: #ffcdd2;
      color: #b71c1c;
    }
    
    .digestive-system-mode {
      background-color: #ffe0b2;
      color: #e65100;
    }
    
    .unknown-action-mode {
      background-color: #e0e0e0;
      color: #424242;
    }
    
    .select-btn {
      padding: 8px 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    
    .select-btn:hover {
      background: var(--primary-hover);
    }
    
    .footer {
      text-align: center;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 5px;
      margin-top: 20px;
    }
    
    .footer p {
      margin: 5px 0;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: slideIn 0.3s;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 15px;
    }
    
    .close-button:hover {
      color: #000;
    }
    
    .modal-title {
      color: var(--primary-color);
      margin-top: 0;
      padding-right: 30px;
    }
    
    .action-section {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .nervous-system-section {
      background-color: var(--nervous-system);
      border-left: 4px solid #2196f3;
    }
    
    .growth-development-section {
      background-color: var(--growth-development);
      border-left: 4px solid #9c27b0;
    }
    
    .respiration-section {
      background-color: var(--respiration);
      border-left: 4px solid #f44336;
    }
    
    .digestive-system-section {
      background-color: var(--digestive-system);
      border-left: 4px solid #ff9800;
    }
    
    .unknown-action-section {
      background-color: var(--unknown-action);
      border-left: 4px solid #9e9e9e;
    }
    
    .modal-note {
      font-style: italic;
      margin: 15px 0;
      padding: 10px;
      background-color: #fff9c4;
      border-radius: 5px;
    }
    
    .mode-list {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .mode-list li {
      margin-bottom: 5px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .recommendation-grid {
        grid-template-columns: 1fr;
      }
      
      .search-section {
        flex-direction: column;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Recomendación de Grupos Químicos</h2>
    
    <div class="card">
      <div class="info-button" id="info-button">i</div>
      
      <div class="search-section">
        <div class="search-group">
          <label for="filter-cultivo">Cultivo:</label>
          <select id="filter-cultivo">
            <option value="todos">Todos los cultivos</option>
            <option value="mini">Mini Pepino</option>
            <option value="tomate">Tomate</option>
          </select>
        </div>
        
        <div class="search-group">
          <label for="filter-categoria">Categoría:</label>
          <select id="filter-categoria">
            <option value="todos">Todas las categorías</option>
            <option value="Insecticida">Insecticida</option>
            <option value="Fungicida">Fungicida</option>
            <option value="Aminoácido">Aminoácido</option>
            <option value="Estimulador">Estimulador</option>
            <option value="Herbicida">Herbicida</option>
            <option value="Bactericida">Bactericida</option>
          </select>
        </div>
        
        <div class="search-group">
          <label for="filter-plaga">Plaga:</label>
          <input type="text" id="filter-plaga" list="plagas-list" placeholder="Buscar por plaga">
          <datalist id="plagas-list"></datalist>
        </div>
      </div>
      
      <div class="main-content">
        <div class="selected-section">
          <h3>Producto Seleccionado</h3>
          <div id="selected-product" class="selected-product">
            <p>No hay producto seleccionado. Busque y seleccione un producto de la lista.</p>
          </div>
          
          <h3>Lista de Productos</h3>
          <div class="product-list" id="productos-container">
            <!-- Los productos se cargarán aquí dinámicamente -->
          </div>
        </div>
        
        <div class="recommendations-section">
          <h3>Recomendaciones (Misma Categoría - Modo de Acción Diferente)</h3>
          <div class="recommendation-grid" id="recommendations-container">
            <!-- Las recomendaciones se mostrarán aquí -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Sistema Agroalpha © 2025 | Unidad produccion 1</p>
    <p>Versión 2.0 - Módulo de recomendación</p>
  </div>

  <!-- Modal de Información -->
  <div id="info-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2 class="modal-title">Modos de Acción de Insecticidas</h2>
      
      <div class="action-section nervous-system-section">
        <h3>Acción sobre el sistema nervioso o muscular</h3>
        <p>La mayoría de los insecticidas actúan sobre el sistema nervioso o muscular. Generalmente suelen ser de acción rápida.</p>
        <p><strong>Grupos que actúan en el sistema nervioso:</strong></p>
        <ul class="mode-list">
          <li>Grupo 1: Inhibidores de acetilcolinesterasa (AChE)</li>
          <li>Grupo 3: Moduladores de canales de sodio</li>
          <li>Grupo 4: Moduladores de receptores nicotínicos de acetilcolina (nAChR)</li>
          <li>Grupo 5: Moduladores de receptores de glutamato</li>
          <li>Grupo 6: Activadores de canales de cloro</li>
          <li>Grupo 22: Inhibidores de canales de voltaje de calcio</li>
          <li>Grupo 28: Moduladores de canales de iones Ryanodina</li>
          <li>Grupo 29: Compuestos con efecto desconocido o no clasificado</li>
        </ul>
        <p>Los productos marcados con <span class="mode-of-action nervous-system-mode">Sistema Nervioso</span> y fondo celeste pertenecen a estos grupos.</p>
      </div>
      
      <div class="action-section growth-development-section">
        <h3>Acción sobre el crecimiento y desarrollo</h3>
        <p>El desarrollo de los insectos está controlado por el equilibrio de dos hormonas principales: la hormona juvenil y la ecdisona. Los reguladores del crecimiento de los insectos actúan imitando una de estas hormonas o perturbando directamente la formación/deposición de la cutícula o la biosíntesis de lípidos.</p>
        <p>Los insecticidas que actúan sobre los distintos objetivos de este sistema, son generalmente de acción lenta a moderadamente lenta.</p>
        <p><strong>Grupos que actúan en el crecimiento y desarrollo:</strong></p>
        <ul class="mode-list">
          <li>Grupo 7: Análogos de la hormona juvenil (JH)</li>
          <li>Grupo 10: Inhibidores de la biosíntesis de quitina</li>
          <li>Grupo 16: Inhibidores de la síntesis de lípidos</li>
          <li>Grupo 18: Ecdisona agonistas/disruptores de la muda</li>
          <li>Grupo 23: Inhibidores de la síntesis de ATP mitocondrial</li>
        </ul>
        <p>Los productos marcados con <span class="mode-of-action growth-development-mode">Crecimiento y Desarrollo</span> y fondo lila pertenecen a estos grupos.</p>
      </div>
      
      <div class="action-section respiration-section">
        <h3>Acción sobre la respiración</h3>
        <p>La respiración mitocondrial produce ATP, la molécula que da energía a todos los procesos celulares vitales. En las mitocondrias, una cadena de transporte de electrones almacena la energía generada por la oxidación en forma de un gradiente de protones, lo que genera la síntesis de ATP.</p>
        <p>Varios insecticidas son conocidos por interferir en la respiración mitocondrial mediante la inhibición del transporte de electrones y/o la fosforilación oxidativa. Los insecticidas que actúan sobre los distintos puntos de este sistema son generalmente de acción rápida a moderadamente rápida.</p>
        <p><strong>Grupos que actúan en la respiración:</strong></p>
        <ul class="mode-list">
          <li>Grupo 20: Inhibidores del transporte de electrones mitocondrial (Complexo I)</li>
          <li>Grupo 21: Inhibidores del transporte de electrones mitocondrial (Complexo III)</li>
          <li>Grupo 24: Inhibidores del transporte de electrones mitocondrial (Complexo IV)</li>
          <li>Grupo 25: Desacopladores de la fosforilación oxidativa</li>
        </ul>
        <p>Los productos marcados con <span class="mode-of-action respiration-mode">Respiración</span> y fondo rojo claro pertenecen a estos grupos.</p>
      </div>
      
      <div class="action-section digestive-system-section">
        <h3>Acción sobre el sistema digestivo</h3>
        <p>Toxinas microbianas específicas de lepidópteros (aplicadas mediante pulverización o expresadas en variedades de cultivos transgénicos) y baculovirus.</p>
        <p><strong>Grupos que actúan en el sistema digestivo:</strong></p>
        <ul class="mode-list">
          <li>Grupo 11: Toxinas microbianas disruptoras de la membrana</li>
          <li>Grupo 31: Toxinas de Bacillus thuringiensis (Bt) y otros bioinsecticidas</li>
        </ul>
        <p>Los productos marcados con <span class="mode-of-action digestive-system-mode">Sistema Digestivo</span> y fondo naranja claro pertenecen a estos grupos.</p>
      </div>
      
      <div class="action-section unknown-action-section">
        <h3>Modo de acción desconocido o incierto</h3>
        <p>Varios insecticidas que afectan a funciones o puntos de acción de un modo menos conocido, o actúan inespecíficamente sobre varios puntos.</p>
        <p><strong>Grupos con modo de acción desconocido o incierto:</strong></p>
        <ul class="mode-list">
          <li>Grupo 8: Compuestos varios (modo de acción no clasificado)</li>
          <li>Grupo UN: Compuestos de modo de acción desconocido</li>
          <li>Grupo UNE: Compuestos de modo de acción desconocido (efectos en enzimas)</li>
          <li>Grupo UNF: Compuestos de modo de acción desconocido (efectos en funciones)</li>
          <li>Grupo UNM: Compuestos de modo de acción desconocido (efectos múltiples)</li>
        </ul>
        <p>Los productos marcados con <span class="mode-of-action unknown-action-mode">Modo Desconocido</span> y fondo gris claro pertenecen a estos grupos.</p>
      </div>
      
      <div class="modal-note">
        <p><strong>Nota importante:</strong> El esquema de color empleado asocia modos de acción con categorías generales basadas en las funciones fisiológicas afectadas, como una ayuda para la comprensión de la sintomatología, la rapidez de acción y otras propiedades de los insecticidas, y no para cualquier propósito de manejo de la resistencia.</p>
        <p><strong>Las rotaciones para el manejo de la resistencia deben basarse únicamente en los grupos numerados de modo de acción.</strong></p>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDN0rsDAaXoZ9ERSQF2WdDB4IIevYAyp1k",
      authDomain: "agro-productos.firebaseapp.com",
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com",
      projectId: "agro-productos",
      storageBucket: "agro-productos.appspot.com",
      messagingSenderId: "196774282512",
      appId: "1:196774282512:web:92697209153eac8acb1195"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Grupos químicos por modo de acción
    const NERVOUS_SYSTEM_GROUPS = ['1', '3', '4', '5', '6', '22', '28', '29'];
    const GROWTH_DEVELOPMENT_GROUPS = ['7', '10', '16', '18', '23'];
    const RESPIRATION_GROUPS = ['20', '21', '24', '25'];
    const DIGESTIVE_SYSTEM_GROUPS = ['11', '31'];
    const UNKNOWN_ACTION_GROUPS = ['8', 'UN', 'UNE', 'UNF', 'UNM'];
    
    // Variables globales
    let allProducts = [];
    let selectedProduct = null;
    let allPlagas = [];

    // Funcionalidad del modal
    const modal = document.getElementById("info-modal");
    const infoButton = document.getElementById("info-button");
    const closeButton = document.querySelector(".close-button");

    infoButton.addEventListener("click", () => {
      modal.style.display = "block";
    });

    closeButton.addEventListener("click", () => {
      modal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

    // Determinar el modo de acción de un producto
    function getProductMode(product) {
      if (!product.grupo_quimico) return 'other';
      
      // Convertir a string y limpiar
      const grupo = String(product.grupo_quimico).trim().toUpperCase();
      
      // Verificar grupos específicos primero
      if (UNKNOWN_ACTION_GROUPS.includes(grupo)) return 'unknown-action';
      
      // Extraer números del grupo químico
      const groupMatch = grupo.match(/^(\d+)/);
      if (groupMatch && groupMatch[1]) {
        const groupNumber = groupMatch[1];
        
        if (NERVOUS_SYSTEM_GROUPS.includes(groupNumber)) return 'nervous-system';
        if (GROWTH_DEVELOPMENT_GROUPS.includes(groupNumber)) return 'growth-development';
        if (RESPIRATION_GROUPS.includes(groupNumber)) return 'respiration';
        if (DIGESTIVE_SYSTEM_GROUPS.includes(groupNumber)) return 'digestive-system';
      }
      
      return 'other';
    }

    // Cargar productos y plagas desde Firebase
    function loadData() {
      // Cargar productos
      db.ref("productos").on("value", (snapshot) => {
        const data = snapshot.val();
        allProducts = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
        renderProducts();
      });
      
      // Cargar plagas para el datalist
      db.ref("plagas").on("value", (snapshot) => {
        const data = snapshot.val();
        allPlagas = data ? Object.values(data) : [];
        
        // Actualizar datalist
        const datalist = document.getElementById("plagas-list");
        datalist.innerHTML = '';
        
        allPlagas.forEach(plaga => {
          const option = document.createElement('option');
          option.value = plaga;
          datalist.appendChild(option);
        });
      });
    }

    // Renderizar productos según los filtros
    function renderProducts() {
      const container = document.getElementById("productos-container");
      const cultivoFilter = document.getElementById("filter-cultivo").value;
      const categoriaFilter = document.getElementById("filter-categoria").value;
      const plagaFilter = document.getElementById("filter-plaga").value.toLowerCase();
      
      container.innerHTML = '';
      
      const filteredProducts = allProducts.filter(product => {
        // Filtrar por cultivo
        if (cultivoFilter !== 'todos') {
          if (cultivoFilter === 'mini' && !product.plagas_mini) return false;
          if (cultivoFilter === 'tomate' && !product.plagas_tomate) return false;
        }
        
        // Filtrar por categoría
        if (categoriaFilter !== 'todos' && product.categoria !== categoriaFilter) {
          return false;
        }
        
        // Filtrar por plaga
        if (plagaFilter) {
          const plagasMini = product.plagas_mini ? product.plagas_mini.toLowerCase() : '';
          const plagasTomate = product.plagas_tomate ? product.plagas_tomate.toLowerCase() : '';
          
          if (!plagasMini.includes(plagaFilter) && !plagasTomate.includes(plagaFilter)) {
            return false;
          }
        }
        
        return true;
      });
      
      if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="product-item">No se encontraron productos con los filtros seleccionados.</div>';
        return;
      }
      
      filteredProducts.forEach(product => {
        const isSelected = selectedProduct && selectedProduct.id === product.id;
        const productMode = getProductMode(product);
        
        const productItem = document.createElement('div');
        productItem.className = isSelected ? 'product-item selected' : 'product-item';
        if (productMode !== 'other') productItem.classList.add(productMode);
        productItem.dataset.id = product.id;
        
        let modeBadge = '';
        if (productMode === 'nervous-system') {
          modeBadge = '<span class="mode-of-action nervous-system-mode">Sistema Nervioso</span>';
        } else if (productMode === 'growth-development') {
          modeBadge = '<span class="mode-of-action growth-development-mode">Crecimiento y Desarrollo</span>';
        } else if (productMode === 'respiration') {
          modeBadge = '<span class="mode-of-action respiration-mode">Respiración</span>';
        } else if (productMode === 'digestive-system') {
          modeBadge = '<span class="mode-of-action digestive-system-mode">Sistema Digestivo</span>';
        } else if (productMode === 'unknown-action') {
          modeBadge = '<span class="mode-of-action unknown-action-mode">Modo Desconocido</span>';
        }
        
        productItem.innerHTML = `
          <strong>${product.nombre}</strong> ${modeBadge}<br>
          <span style="font-size: 12px; color: #666;">${product.categoria} - ${product.grupo_quimico}</span>
        `;
        
        productItem.addEventListener('click', () => selectProduct(product.id));
        container.appendChild(productItem);
      });
    }

    // Seleccionar un producto
    function selectProduct(productId) {
      selectedProduct = allProducts.find(p => p.id === productId);
      updateSelectedProduct();
      renderProducts(); // Para actualizar el estado visual de selección
      
      // Generar recomendaciones
      generateRecommendations();
    }

    // Actualizar la información del producto seleccionado
    function updateSelectedProduct() {
      const container = document.getElementById('selected-product');
      
      if (!selectedProduct) {
        container.innerHTML = '<p>No hay producto seleccionado. Busque y seleccione un producto de la lista.</p>';
        return;
      }
      
      // Determinar color de banda
      let bandaColor = 'green';
      if (selectedProduct.banda === 'red') bandaColor = 'red';
      else if (selectedProduct.banda === 'yellow') bandaColor = 'yellow';
      else if (selectedProduct.banda === 'blue') bandaColor = 'blue';
      
      const productMode = getProductMode(selectedProduct);
      container.className = 'selected-product';
      if (productMode !== 'other') container.classList.add(productMode);
      
      let modeBadge = '';
      if (productMode === 'nervous-system') {
        modeBadge = '<span class="mode-of-action nervous-system-mode">Sistema Nervioso</span>';
      } else if (productMode === 'growth-development') {
        modeBadge = '<span class="mode-of-action growth-development-mode">Crecimiento y Desarrollo</span>';
      } else if (productMode === 'respiration') {
        modeBadge = '<span class="mode-of-action respiration-mode">Respiración</span>';
      } else if (productMode === 'digestive-system') {
        modeBadge = '<span class="mode-of-action digestive-system-mode">Sistema Digestivo</span>';
      } else if (productMode === 'unknown-action') {
        modeBadge = '<span class="mode-of-action unknown-action-mode">Modo Desconocido</span>';
      }
      
      container.innerHTML = `
        <div style="margin-bottom: 15px;">
          <h3 style="margin-top: 0;">${selectedProduct.nombre} ${modeBadge}</h3>
          <div><strong>Ingredientes Activos:</strong> ${selectedProduct.ingredientes}</div>
          <div><strong>Categoría:</strong> ${selectedProduct.categoria}</div>
          <div><strong>Grupo Químico:</strong> ${selectedProduct.grupo_quimico}</div>
          <div><strong>Familia Química:</strong> ${selectedProduct.familia_quimica}</div>
          <div><strong>Banda Toxicológica:</strong> <span class="banda-indicator banda-${bandaColor}"></span> ${selectedProduct.banda}</div>
        </div>
        <div>
          ${selectedProduct.plagas_mini ? `<div><strong>Plagas (Mini):</strong> ${selectedProduct.plagas_mini}</div>` : ''}
          ${selectedProduct.plagas_tomate ? `<div><strong>Plagas (Tomate):</strong> ${selectedProduct.plagas_tomate}</div>` : ''}
        </div>
      `;
    }

    // Generar recomendaciones basadas en el producto seleccionado
    function generateRecommendations() {
      const container = document.getElementById('recommendations-container');
      
      if (!selectedProduct) {
        container.innerHTML = '<div class="recommendation-item">Seleccione un producto para obtener recomendaciones.</div>';
        return;
      }
      
      // Obtener grupo, familia y categoría del producto seleccionado
      const selectedGroup = selectedProduct.grupo_quimico;
      const selectedFamily = selectedProduct.familia_quimica;
      const selectedCategory = selectedProduct.categoria;
      const selectedMode = getProductMode(selectedProduct);
      
      // Filtrar productos de la MISMA categoría pero con modo de acción DIFERENTE
      const recommendedProducts = allProducts.filter(product => {
        // Excluir producto seleccionado
        if (product.id === selectedProduct.id) return false;
        
        // Incluir solo productos de la MISMA categoría
        if (product.categoria !== selectedCategory) return false;
        
        // Si el producto seleccionado tiene un modo de acción específico,
        // excluir todos los que tengan el mismo modo de acción
        if (selectedMode !== 'other' && getProductMode(product) === selectedMode) {
          return false;
        }
        
        // Incluir solo productos de grupos químicos DIFERENTES
        return product.grupo_quimico !== selectedGroup && 
               product.familia_quimica !== selectedFamily;
      });
      
      if (recommendedProducts.length === 0) {
        container.innerHTML = `
          <div class="recommendation-item">
            <div class="recommendation-header">No se encontraron productos de la misma categoría con modo de acción diferente</div>
            <p>Intente modificar los filtros de búsqueda.</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      recommendedProducts.forEach(product => {
        // Determinar color de banda
        let bandaColor = 'green';
        if (product.banda === 'red') bandaColor = 'red';
        else if (product.banda === 'yellow') bandaColor = 'yellow';
        else if (product.banda === 'blue') bandaColor = 'blue';
        
        const productMode = getProductMode(product);
        const itemClass = productMode !== 'other' ? `recommendation-item ${productMode}` : 'recommendation-item';
        
        let modeBadge = '';
        if (productMode === 'nervous-system') {
          modeBadge = '<span class="mode-of-action nervous-system-mode">Sistema Nervioso</span>';
        } else if (productMode === 'growth-development') {
          modeBadge = '<span class="mode-of-action growth-development-mode">Crecimiento y Desarrollo</span>';
        } else if (productMode === 'respiration') {
          modeBadge = '<span class="mode-of-action respiration-mode">Respiración</span>';
        } else if (productMode === 'digestive-system') {
          modeBadge = '<span class="mode-of-action digestive-system-mode">Sistema Digestivo</span>';
        } else if (productMode === 'unknown-action') {
          modeBadge = '<span class="mode-of-action unknown-action-mode">Modo Desconocido</span>';
        }
        
        html += `
          <div class="${itemClass}">
            <div class="product-name">
              <span class="banda-indicator banda-${bandaColor}"></span>
              <strong>${product.nombre}</strong> ${modeBadge}
            </div>
            <div class="product-info">
              <div><strong>Ingredientes:</strong> ${product.ingredientes}</div>
              <div><strong>Grupo:</strong> ${product.grupo_quimico}</div>
              <div><strong>Familia:</strong> ${product.familia_quimica}</div>
              ${product.plagas_mini ? `<div><strong>Plagas (Mini):</strong> ${product.plagas_mini}</div>` : ''}
              ${product.plagas_tomate ? `<div><strong>Plagas (Tomate):</strong> ${product.plagas_tomate}</div>` : ''}
            </div>
            <button class="select-btn" onclick="selectProduct('${product.id}')">Seleccionar este</button>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      
      // Configurar event listeners para los filtros
      document.getElementById('filter-cultivo').addEventListener('change', renderProducts);
      document.getElementById('filter-categoria').addEventListener('change', renderProducts);
      document.getElementById('filter-plaga').addEventListener('input', renderProducts);
    });

    // Hacer funciones disponibles globalmente para los event handlers HTML
    window.selectProduct = selectProduct;
  </script>
</body>
</html>
