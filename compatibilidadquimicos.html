<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recomendación de Grupos Químicos</title>
  <style>
    :root {
      --primary-color: #2e7d32;
      --primary-hover: #1b5e20;
      --light-bg: #f1fdf3;
      --light-border: #c8e6c9;
      --white: #ffffff;
      --shadow: rgba(0,0,0,0.1);
      --red: #f44336;
      --yellow: #ffeb3b;
      --blue: #2196f3;
      --green: #4caf50;
      --nervous-system: #e3f2fd; /* Celeste para sistema nervioso */
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: var(--light-bg);
      margin: 0;
      padding: 20px;
      color: var(--primary-color);
      min-height: 100vh;
    }
    
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-top: 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .card {
      background: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px var(--shadow);
    }
    
    .search-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .search-group {
      flex: 1;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--light-border);
      border-radius: 5px;
      font-size: 16px;
    }
    
    .main-content {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .selected-section {
      flex: 1;
      min-width: 300px;
    }
    
    .recommendations-section {
      flex: 2;
      min-width: 300px;
    }
    
    .selected-product {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      margin-bottom: 20px;
    }
    
    .nervous-system {
      background-color: var(--nervous-system);
      border-left: 4px solid #2196f3;
    }
    
    .product-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--light-border);
      border-radius: 5px;
      padding: 10px;
    }
    
    .product-item {
      padding: 10px;
      border-bottom: 1px solid var(--light-border);
      cursor: pointer;
    }
    
    .product-item:hover {
      background-color: #f1f8e9;
    }
    
    .product-item.selected {
      background-color: #ffebee;
    }
    
    .product-item.nervous-system {
      background-color: var(--nervous-system);
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .banda-indicator {
      display: inline-block;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .banda-red { background-color: var(--red); }
    .banda-yellow { background-color: var(--yellow); }
    .banda-blue { background-color: var(--blue); }
    .banda-green { background-color: var(--green); }
    
    .recommendation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .recommendation-item {
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px var(--shadow);
      border-left: 4px solid var(--primary-color);
    }
    
    .recommendation-item.nervous-system {
      background-color: var(--nervous-system);
      border-left: 4px solid #2196f3;
    }
    
    .product-info {
      margin-bottom: 10px;
    }
    
    .product-info div {
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .mode-of-action {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      background-color: #e8f5e9;
      color: var(--primary-color);
      margin-left: 8px;
    }
    
    .nervous-system-mode {
      background-color: #bbdefb;
      color: #0d47a1;
    }
    
    .select-btn {
      padding: 8px 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    
    .select-btn:hover {
      background: var(--primary-hover);
    }
    
    .footer {
      text-align: center;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 5px;
      margin-top: 20px;
    }
    
    .footer p {
      margin: 5px 0;
    }
    
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .recommendation-grid {
        grid-template-columns: 1fr;
      }
      
      .search-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Recomendación de Grupos Químicos</h2>
    
    <div class="card">
      <div class="search-section">
        <div class="search-group">
          <label for="filter-cultivo">Cultivo:</label>
          <select id="filter-cultivo">
            <option value="todos">Todos los cultivos</option>
            <option value="mini">Mini Pepino</option>
            <option value="tomate">Tomate</option>
          </select>
        </div>
        
        <div class="search-group">
          <label for="filter-categoria">Categoría:</label>
          <select id="filter-categoria">
            <option value="todos">Todas las categorías</option>
            <option value="Insecticida">Insecticida</option>
            <option value="Fungicida">Fungicida</option>
            <option value="Aminoácido">Aminoácido</option>
            <option value="Estimulador">Estimulador</option>
            <option value="Herbicida">Herbicida</option>
            <option value="Bactericida">Bactericida</option>
          </select>
        </div>
        
        <div class="search-group">
          <label for="filter-plaga">Plaga:</label>
          <input type="text" id="filter-plaga" list="plagas-list" placeholder="Buscar por plaga">
          <datalist id="plagas-list"></datalist>
        </div>
      </div>
      
      <div class="main-content">
        <div class="selected-section">
          <h3>Producto Seleccionado</h3>
          <div id="selected-product" class="selected-product">
            <p>No hay producto seleccionado. Busque y seleccione un producto de la lista.</p>
          </div>
          
          <h3>Lista de Productos</h3>
          <div class="product-list" id="productos-container">
            <!-- Los productos se cargarán aquí dinámicamente -->
          </div>
        </div>
        
        <div class="recommendations-section">
          <h3>Recomendaciones (Misma Categoría - Modo de Acción Diferente)</h3>
          <div class="recommendation-grid" id="recommendations-container">
            <!-- Las recomendaciones se mostrarán aquí -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Sistema Agroalpha © 2025 | Unidad produccion 1</p>
    <p>Versión 2.0 - Módulo de recomendación</p>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDN0rsDAaXoZ9ERSQF2WdDB4IIevYAyp1k",
      authDomain: "agro-productos.firebaseapp.com",
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com",
      projectId: "agro-productos",
      storageBucket: "agro-productos.appspot.com",
      messagingSenderId: "196774282512",
      appId: "1:196774282512:web:92697209153eac8acb1195"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Grupos químicos que actúan en el sistema nervioso
    const NERVOUS_SYSTEM_GROUPS = ['1', '3', '4', '5', '6', '22', '28', '29'];
    
    // Variables globales
    let allProducts = [];
    let selectedProduct = null;
    let allPlagas = [];

    // Determinar si un producto actúa en el sistema nervioso
    function isNervousSystemProduct(product) {
      // Extraer números del grupo químico (asumiendo que el número está al inicio)
      const groupMatch = product.grupo_quimico ? product.grupo_quimico.match(/^(\d+)/) : null;
      if (groupMatch && groupMatch[1]) {
        return NERVOUS_SYSTEM_GROUPS.includes(groupMatch[1]);
      }
      return false;
    }

    // Cargar productos y plagas desde Firebase
    function loadData() {
      // Cargar productos
      db.ref("productos").on("value", (snapshot) => {
        const data = snapshot.val();
        allProducts = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
        renderProducts();
      });
      
      // Cargar plagas para el datalist
      db.ref("plagas").on("value", (snapshot) => {
        const data = snapshot.val();
        allPlagas = data ? Object.values(data) : [];
        
        // Actualizar datalist
        const datalist = document.getElementById("plagas-list");
        datalist.innerHTML = '';
        
        allPlagas.forEach(plaga => {
          const option = document.createElement('option');
          option.value = plaga;
          datalist.appendChild(option);
        });
      });
    }

    // Renderizar productos según los filtros
    function renderProducts() {
      const container = document.getElementById("productos-container");
      const cultivoFilter = document.getElementById("filter-cultivo").value;
      const categoriaFilter = document.getElementById("filter-categoria").value;
      const plagaFilter = document.getElementById("filter-plaga").value.toLowerCase();
      
      container.innerHTML = '';
      
      const filteredProducts = allProducts.filter(product => {
        // Filtrar por cultivo
        if (cultivoFilter !== 'todos') {
          if (cultivoFilter === 'mini' && !product.plagas_mini) return false;
          if (cultivoFilter === 'tomate' && !product.plagas_tomate) return false;
        }
        
        // Filtrar por categoría
        if (categoriaFilter !== 'todos' && product.categoria !== categoriaFilter) {
          return false;
        }
        
        // Filtrar por plaga
        if (plagaFilter) {
          const plagasMini = product.plagas_mini ? product.plagas_mini.toLowerCase() : '';
          const plagasTomate = product.plagas_tomate ? product.plagas_tomate.toLowerCase() : '';
          
          if (!plagasMini.includes(plagaFilter) && !plagasTomate.includes(plagaFilter)) {
            return false;
          }
        }
        
        return true;
      });
      
      if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="product-item">No se encontraron productos con los filtros seleccionados.</div>';
        return;
      }
      
      filteredProducts.forEach(product => {
        const isSelected = selectedProduct && selectedProduct.id === product.id;
        const isNervousSystem = isNervousSystemProduct(product);
        
        const productItem = document.createElement('div');
        productItem.className = isSelected ? 'product-item selected' : 'product-item';
        if (isNervousSystem) productItem.classList.add('nervous-system');
        productItem.dataset.id = product.id;
        
        let modeBadge = '';
        if (isNervousSystem) {
          modeBadge = '<span class="mode-of-action nervous-system-mode">Sistema Nervioso</span>';
        }
        
        productItem.innerHTML = `
          <strong>${product.nombre}</strong> ${modeBadge}<br>
          <span style="font-size: 12px; color: #666;">${product.categoria} - ${product.grupo_quimico}</span>
        `;
        
        productItem.addEventListener('click', () => selectProduct(product.id));
        container.appendChild(productItem);
      });
    }

    // Seleccionar un producto
    function selectProduct(productId) {
      selectedProduct = allProducts.find(p => p.id === productId);
      updateSelectedProduct();
      renderProducts(); // Para actualizar el estado visual de selección
      
      // Generar recomendaciones
      generateRecommendations();
    }

    // Actualizar la información del producto seleccionado
    function updateSelectedProduct() {
      const container = document.getElementById('selected-product');
      
      if (!selectedProduct) {
        container.innerHTML = '<p>No hay producto seleccionado. Busque y seleccione un producto de la lista.</p>';
        return;
      }
      
      // Determinar color de banda
      let bandaColor = 'green';
      if (selectedProduct.banda === 'red') bandaColor = 'red';
      else if (selectedProduct.banda === 'yellow') bandaColor = 'yellow';
      else if (selectedProduct.banda === 'blue') bandaColor = 'blue';
      
      const isNervousSystem = isNervousSystemProduct(selectedProduct);
      if (isNervousSystem) {
        container.classList.add('nervous-system');
      } else {
        container.classList.remove('nervous-system');
      }
      
      let modeBadge = '';
      if (isNervousSystem) {
        modeBadge = '<span class="mode-of-action nervous-system-mode">Sistema Nervioso</span>';
      }
      
      container.innerHTML = `
        <div style="margin-bottom: 15px;">
          <h3 style="margin-top: 0;">${selectedProduct.nombre} ${modeBadge}</h3>
          <div><strong>Ingredientes Activos:</strong> ${selectedProduct.ingredientes}</div>
          <div><strong>Categoría:</strong> ${selectedProduct.categoria}</div>
          <div><strong>Grupo Químico:</strong> ${selectedProduct.grupo_quimico}</div>
          <div><strong>Familia Química:</strong> ${selectedProduct.familia_quimica}</div>
          <div><strong>Banda Toxicológica:</strong> <span class="banda-indicator banda-${bandaColor}"></span> ${selectedProduct.banda}</div>
        </div>
        <div>
          ${selectedProduct.plagas_mini ? `<div><strong>Plagas (Mini):</strong> ${selectedProduct.plagas_mini}</div>` : ''}
          ${selectedProduct.plagas_tomate ? `<div><strong>Plagas (Tomate):</strong> ${selectedProduct.plagas_tomate}</div>` : ''}
        </div>
      `;
    }

    // Generar recomendaciones basadas en el producto seleccionado
    function generateRecommendations() {
      const container = document.getElementById('recommendations-container');
      
      if (!selectedProduct) {
        container.innerHTML = '<div class="recommendation-item">Seleccione un producto para obtener recomendaciones.</div>';
        return;
      }
      
      // Obtener grupo, familia y categoría del producto seleccionado
      const selectedGroup = selectedProduct.grupo_quimico;
      const selectedFamily = selectedProduct.familia_quimica;
      const selectedCategory = selectedProduct.categoria;
      const isSelectedNervousSystem = isNervousSystemProduct(selectedProduct);
      
      // Filtrar productos de la MISMA categoría pero con modo de acción DIFERENTE
      const recommendedProducts = allProducts.filter(product => {
        // Excluir producto seleccionado
        if (product.id === selectedProduct.id) return false;
        
        // Incluir solo productos de la MISMA categoría
        if (product.categoria !== selectedCategory) return false;
        
        // Si el producto seleccionado actúa en el sistema nervioso,
        // excluir todos los que también actúen en el sistema nervioso
        if (isSelectedNervousSystem && isNervousSystemProduct(product)) {
          return false;
        }
        
        // Incluir solo productos de grupos químicos DIFERENTES
        return product.grupo_quimico !== selectedGroup && 
               product.familia_quimica !== selectedFamily;
      });
      
      if (recommendedProducts.length === 0) {
        container.innerHTML = `
          <div class="recommendation-item">
            <div class="recommendation-header">No se encontraron productos de la misma categoría con modo de acción diferente</div>
            <p>Intente modificar los filtros de búsqueda.</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      recommendedProducts.forEach(product => {
        // Determinar color de banda
        let bandaColor = 'green';
        if (product.banda === 'red') bandaColor = 'red';
        else if (product.banda === 'yellow') bandaColor = 'yellow';
        else if (product.banda === 'blue') bandaColor = 'blue';
        
        const isNervousSystem = isNervousSystemProduct(product);
        const itemClass = isNervousSystem ? 'recommendation-item nervous-system' : 'recommendation-item';
        
        let modeBadge = '';
        if (isNervousSystem) {
          modeBadge = '<span class="mode-of-action nervous-system-mode">Sistema Nervioso</span>';
        }
        
        html += `
          <div class="${itemClass}">
            <div class="product-name">
              <span class="banda-indicator banda-${bandaColor}"></span>
              <strong>${product.nombre}</strong> ${modeBadge}
            </div>
            <div class="product-info">
              <div><strong>Ingredientes:</strong> ${product.ingredientes}</div>
              <div><strong>Grupo:</strong> ${product.grupo_quimico}</div>
              <div><strong>Familia:</strong> ${product.familia_quimica}</div>
              ${product.plagas_mini ? `<div><strong>Plagas (Mini):</strong> ${product.plagas_mini}</div>` : ''}
              ${product.plagas_tomate ? `<div><strong>Plagas (Tomate):</strong> ${product.plagas_tomate}</div>` : ''}
            </div>
            <button class="select-btn" onclick="selectProduct('${product.id}')">Seleccionar este</button>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      
      // Configurar event listeners para los filtros
      document.getElementById('filter-cultivo').addEventListener('change', renderProducts);
      document.getElementById('filter-categoria').addEventListener('change', renderProducts);
      document.getElementById('filter-plaga').addEventListener('input', renderProducts);
    });

    // Hacer funciones disponibles globalmente para los event handlers HTML
    window.selectProduct = selectProduct;
  </script>
</body>
</html>
