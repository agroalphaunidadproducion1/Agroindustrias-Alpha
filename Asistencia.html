<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro Asistencia</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f5f5f5;
      min-height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      padding: 20px;
      margin-bottom: 20px;
    }

    h1 {
      color: #2e7d32;
      text-align: center;
      margin: 15px 0;
      font-size: 1.5rem;
    }

    .btn {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: #388e3c;
    }

    .btn-secondary {
      background-color: #2196f3;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background-color: #1976d2;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-size: 0.9rem;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }

    .invernaderos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin: 15px 0;
    }

    .invernadero-btn {
      background: #e8f5e9;
      border: 2px solid #c8e6c9;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .invernadero-btn.selected {
      background: #a5d6a7;
      border-color: #81c784;
      font-weight: 500;
    }

    .info-text {
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
    }

    .footer {
      text-align: center;
      color: #666;
      font-size: 0.8rem;
      margin-top: 20px;
    }

    /* PC */
    @media (min-width: 768px) {
      .container {
        padding: 30px;
      }
      
      h1 {
        font-size: 1.8rem;
        margin: 20px 0;
      }
      
      .invernaderos-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro Diario de Asistencia</h1>
    
    <div class="input-group">
      <label for="fecha">Fecha</label>
      <input type="date" id="fecha">
    </div>
    
    <div class="input-group">
      <label for="modulo">Módulo</label>
      <select id="modulo">
        <option value="">Seleccione módulo</option>
        <option value="C">Módulo C</option>
        <option value="D">Módulo D</option>
        <option value="I">Módulo I</option>
        <option value="J">Módulo J</option>
      </select>
    </div>
    
    <div class="input-group">
      <label>Invernadero</label>
      <div class="invernaderos-grid" id="invernaderos-container">
        <!-- Botones se generan automáticamente -->
      </div>
    </div>
    
    <div class="input-group">
      <label for="total-personal">Total de Personal</label>
      <input type="number" id="total-personal" readonly>
      <p class="info-text">Configura el personal en la página de administración</p>
    </div>
    
    <div class="input-group">
      <label for="asistentes">Personas Presentes Hoy</label>
      <input type="number" id="asistentes" min="0" placeholder="Ingrese cantidad">
    </div>
    
    <button id="registrar-btn" class="btn">
      <i class="material-icons">save</i> Guardar Registro
    </button>
    <a href="admin.html" class="btn btn-secondary">
      <i class="material-icons">settings</i> Configurar Personal
    </a>
  </div>
  
  <div class="footer">
    Sistema Agroalpha © 2025 | Versión 3.0
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  
  <script>
    // Configuración Firebase
    const firebaseConfig = {
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com/"
    };
    
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Referencias a la base de datos
    const refAsistencia = database.ref('asistencia');
    const refConfig = database.ref('config');
    
    // Variables globales
    let configInvernaderos = {};
    
    // Elementos del DOM
    const fechaInput = document.getElementById('fecha');
    const moduloSelect = document.getElementById('modulo');
    const invernaderosContainer = document.getElementById('invernaderos-container');
    const totalPersonalInput = document.getElementById('total-personal');
    const asistentesInput = document.getElementById('asistentes');
    const registrarBtn = document.getElementById('registrar-btn');
    
    // Establecer fecha actual por defecto
    fechaInput.valueAsDate = new Date();
    
    // Cargar configuración de Firebase
    refConfig.on('value', (snapshot) => {
      configInvernaderos = snapshot.val() || {};
      console.log("Configuración cargada:", configInvernaderos);
    });
    
    // Cargar invernaderos cuando se selecciona un módulo
    moduloSelect.addEventListener('change', function() {
      const modulo = this.value;
      invernaderosContainer.innerHTML = '';
      
      if (!modulo) return;
      
      const invernaderosModulo = {
        'C': ['C9', 'C10', 'C11', 'C12'],
        'D': ['D13', 'D14', 'D15', 'D16'],
        'I': ['I33', 'I35'],
        'J': ['J37', 'J39']
      };
      
      invernaderosModulo[modulo].forEach(inv => {
        const btn = document.createElement('button');
        btn.className = 'invernadero-btn';
        btn.textContent = inv;
        btn.dataset.invernadero = inv;
        
        btn.addEventListener('click', function() {
          document.querySelectorAll('.invernadero-btn').forEach(b => {
            b.classList.remove('selected');
          });
          this.classList.add('selected');
          
          // Obtener total de personal configurado
          const total = configInvernaderos[inv]?.personal || 0;
          totalPersonalInput.value = total;
        });
        
        invernaderosContainer.appendChild(btn);
      });
    });
    
    // Guardar registro en Firebase
    registrarBtn.addEventListener('click', function() {
      const fecha = fechaInput.value;
      const modulo = moduloSelect.value;
      const invernaderoBtn = document.querySelector('.invernadero-btn.selected');
      const total = totalPersonalInput.value;
      const presentes = asistentesInput.value;
      
      if (!fecha || !modulo || !invernaderoBtn || !presentes) {
        alert('Por favor complete todos los campos');
        return;
      }
      
      const invernadero = invernaderoBtn.dataset.invernadero;
      const porcentaje = Math.round((presentes / total) * 100);
      
      const registro = {
        fecha,
        modulo,
        invernadero,
        total: parseInt(total),
        presentes: parseInt(presentes),
        porcentaje,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      
      // Guardar en Firebase
      refAsistencia.push(registro)
        .then(() => {
          alert(`Registro guardado para ${invernadero}\nAsistencia: ${presentes}/${total} (${porcentaje}%)`);
          asistentesInput.value = '';
          invernaderosContainer.querySelectorAll('.invernadero-btn').forEach(b => {
            b.classList.remove('selected');
          });
          totalPersonalInput.value = '';
        })
        .catch(error => {
          console.error("Error al guardar:", error);
          alert("Error al guardar el registro");
        });
    });
  </script>
</body>
</html>