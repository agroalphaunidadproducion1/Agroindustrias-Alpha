<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización de Cosecha Semanal</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
            --white: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-gray);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            align-self: flex-end;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .results {
            margin-top: 30px;
        }
        
        .week-summary {
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: var(--light-gray);
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #e8f5e9 !important;
        }
        
        .cultivo-total {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
        }
        
        .cultivo-card {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .cultivo-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .cultivo-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--dark-gray);
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            button {
                width: 100%;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .cultivo-card {
                min-width: 100%;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>Registros de Cosecha Semanal</h1>
        
        <div class="filters">
            <div class="filter-group">
                <label for="year">Año:</label>
                <select id="year">
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            <div class="filter-group">
                <label for="week">Semana:</label>
                <select id="week">
                    <option value="">Todas las semanas</option>
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            <div class="filter-group">
                <label for="invernadero">Invernadero:</label>
                <select id="invernadero">
                    <option value="">Todos</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="33">33</option>
                    <option value="35">35</option>
                    <option value="37">37</option>
                    <option value="39">39</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="cultivo">Cultivo:</label>
                <select id="cultivo">
                    <option value="">Todos</option>
                    <option value="Mini">Mini</option>
                    <option value="Tomate">Tomate</option>
                </select>
            </div>
            <button id="filterButton">Filtrar</button>
        </div>
        
        <div class="results">
            <div id="weekResults"></div>
            <div id="cultivoTotals" class="cultivo-total"></div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            databaseURL: "https://agro-productos-default-rtdb.firebaseio.com/"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        document.addEventListener('DOMContentLoaded', function() {
            // Referencia a la base de datos
            const registrosRef = database.ref('registro-de-cosecha-semanal');
            
            // Llenar años disponibles
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('year');
            for (let year = currentYear; year >= 2020; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Llenar semanas disponibles
            const weekSelect = document.getElementById('week');
            for (let week = 1; week <= 52; week++) {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Semana ${week}`;
                weekSelect.appendChild(option);
            }
            
            // Manejar el botón de filtrar
            document.getElementById('filterButton').addEventListener('click', function() {
                loadData();
            });
            
            // Cargar datos iniciales
            loadData();
            
            function loadData() {
                const year = document.getElementById('year').value;
                const week = document.getElementById('week').value;
                const invernadero = document.getElementById('invernadero').value;
                const cultivo = document.getElementById('cultivo').value;
                
                registrosRef.once('value', function(snapshot) {
                    const registros = [];
                    const cultivosTotales = { Mini: 0, Tomate: 0 };
                    const semanasUnicas = new Set();
                    
                    snapshot.forEach(function(childSnapshot) {
                        const registro = childSnapshot.val();
                        const registroKey = childSnapshot.key;
                        
                        // Filtrar por año si está seleccionado
                        if (year) {
                            const fechaRegistro = new Date(registro.fecha);
                            if (fechaRegistro.getFullYear() != year) return;
                        }
                        
                        // Filtrar por semana si está seleccionada
                        if (week && registro.semana != week) return;
                        
                        // Procesar cada registro de producción
                        registro.produccion.forEach(function(item) {
                            // Aplicar filtros adicionales
                            if (invernadero && item.invernadero != invernadero) return;
                            if (cultivo && item.cultivo != cultivo) return;
                            
                            // Agregar a registros para mostrar
                            registros.push({
                                semana: registro.semana,
                                fecha: registro.fecha,
                                dia: registro.dia,
                                invernadero: item.invernadero,
                                cultivo: item.cultivo,
                                cantidad: item.cantidad,
                                observaciones: item.observaciones
                            });
                            
                            // Sumar a totales por cultivo
                            if (item.cultivo === 'Mini' || item.cultivo === 'Tomate') {
                                cultivosTotales[item.cultivo] += parseFloat(item.cantidad) || 0;
                            }
                            
                            // Agregar semana al conjunto de semanas únicas
                            semanasUnicas.add(registro.semana);
                        });
                    });
                    
                    // Mostrar resultados
                    displayResults(registros, cultivosTotales);
                    
                    // Actualizar opciones de semanas disponibles para el año seleccionado
                    updateWeekOptions(Array.from(semanasUnicas).sort((a, b) => a - b));
                });
            }
            
            function updateWeekOptions(weeks) {
                const weekSelect = document.getElementById('week');
                const currentWeek = weekSelect.value;
                
                // Guardar todas las opciones
                const allOptions = Array.from(weekSelect.options);
                
                // Limpiar y agregar opción "Todas"
                weekSelect.innerHTML = '<option value="">Todas las semanas</option>';
                
                // Agregar semanas disponibles
                weeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week;
                    option.textContent = `Semana ${week}`;
                    weekSelect.appendChild(option);
                });
                
                // Restaurar selección si todavía está disponible
                if (allOptions.some(opt => opt.value === currentWeek)) {
                    weekSelect.value = currentWeek;
                }
            }
            
            function displayResults(registros, cultivosTotales) {
                const weekResults = document.getElementById('weekResults');
                const cultivoTotalsDiv = document.getElementById('cultivoTotals');
                
                // Limpiar resultados anteriores
                weekResults.innerHTML = '';
                cultivoTotalsDiv.innerHTML = '';
                
                if (registros.length === 0) {
                    weekResults.innerHTML = '<div class="no-results">No se encontraron registros con los filtros seleccionados</div>';
                    return;
                }
                
                // Agrupar registros por semana
                const registrosPorSemana = {};
                registros.forEach(registro => {
                    if (!registrosPorSemana[registro.semana]) {
                        registrosPorSemana[registro.semana] = [];
                    }
                    registrosPorSemana[registro.semana].push(registro);
                });
                
                // Mostrar registros por semana
                for (const semana in registrosPorSemana) {
                    const semanaDiv = document.createElement('div');
                    semanaDiv.className = 'week-summary';
                    
                    const semanaTitle = document.createElement('h2');
                    semanaTitle.textContent = `Semana ${semana}`;
                    semanaDiv.appendChild(semanaTitle);
                    
                    // Crear tabla para la semana
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');
                    
                    // Encabezados de tabla
                    thead.innerHTML = `
                        <tr>
                            <th>Fecha</th>
                            <th>Día</th>
                            <th>Invernadero</th>
                            <th>Cultivo</th>
                            <th>Cantidad (kg)</th>
                            <th>Observaciones</th>
                        </tr>
                    `;
                    
                    // Totales por cultivo en la semana
                    const totalSemana = { Mini: 0, Tomate: 0 };
                    
                    // Llenar tabla con registros
                    registrosPorSemana[semana].forEach(registro => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(registro.fecha)}</td>
                            <td>${registro.dia}</td>
                            <td>${registro.invernadero}</td>
                            <td>${registro.cultivo}</td>
                            <td>${registro.cantidad.toFixed(2)}</td>
                            <td>${registro.observaciones || ''}</td>
                        `;
                        tbody.appendChild(row);
                        
                        // Sumar a totales de la semana
                        if (registro.cultivo === 'Mini' || registro.cultivo === 'Tomate') {
                            totalSemana[registro.cultivo] += parseFloat(registro.cantidad) || 0;
                        }
                    });
                    
                    // Agregar fila de totales
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    totalRow.innerHTML = `
                        <td colspan="3">Total Semana ${semana}</td>
                        <td>Mini</td>
                        <td>${totalSemana.Mini.toFixed(2)}</td>
                        <td></td>
                    `;
                    tbody.appendChild(totalRow);
                    
                    const totalRow2 = document.createElement('tr');
                    totalRow2.className = 'total-row';
                    totalRow2.innerHTML = `
                        <td colspan="3"></td>
                        <td>Tomate</td>
                        <td>${totalSemana.Tomate.toFixed(2)}</td>
                        <td></td>
                    `;
                    tbody.appendChild(totalRow2);
                    
                    table.appendChild(thead);
                    table.appendChild(tbody);
                    semanaDiv.appendChild(table);
                    weekResults.appendChild(semanaDiv);
                }
                
                // Mostrar totales por cultivo
                const miniCard = document.createElement('div');
                miniCard.className = 'cultivo-card';
                miniCard.innerHTML = `
                    <h3>Total Mini</h3>
                    <p>${cultivosTotales.Mini.toFixed(2)} kg</p>
                `;
                
                const tomateCard = document.createElement('div');
                tomateCard.className = 'cultivo-card';
                tomateCard.innerHTML = `
                    <h3>Total Tomate</h3>
                    <p>${cultivosTotales.Tomate.toFixed(2)} kg</p>
                `;
                
                const totalCard = document.createElement('div');
                totalCard.className = 'cultivo-card';
                const totalGeneral = cultivosTotales.Mini + cultivosTotales.Tomate;
                totalCard.innerHTML = `
                    <h3>Total General</h3>
                    <p>${totalGeneral.toFixed(2)} kg</p>
                `;
                
                cultivoTotalsDiv.appendChild(miniCard);
                cultivoTotalsDiv.appendChild(tomateCard);
                cultivoTotalsDiv.appendChild(totalCard);
            }
            
            function formatDate(dateString) {
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                return new Date(dateString).toLocaleDateString('es-ES', options);
            }
        });
    </script>


<div class="footer">
        <p>Sistema Agroalpha © 2025 | Unidad produccion 1</p>
        <p>Versión 2.0 - Módulo completo</p>
    </div>
</body>
</html>