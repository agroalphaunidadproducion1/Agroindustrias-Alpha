<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Muestreo de Plagas - Agroalpha</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; background-color: #f0fff0; padding: 20px; }
    h2 { color: #2d6a4f; }
    label, select, input { display: block; margin-bottom: 10px; width: 100%; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
    th, td { border: 1px solid #aaa; padding: 4px; text-align: center; }
    th { background-color: #cce5cc; }
    .btn { background: #2d6a4f; color: white; padding: 10px; border: none; cursor: pointer; margin-top: 20px; }
    .btn:hover { background: #245a3a; }
    .totales, .resumen { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>

  <h2>Muestreo de Plagas - Agroalpha</h2>
  <form id="muestreoForm">
    <label>Fecha: <input type="date" name="fecha" required></label>
    <label>Módulo:
      <select id="modulo" name="modulo" required onchange="actualizarModulo()">
        <option value="">Seleccionar módulo</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="I">I</option>
        <option value="J">J</option>
      </select>
    </label>
    <label>Invernadero:
      <select id="invernadero" name="invernadero" required></select>
    </label>
    <label>Cultivo: <input type="text" id="cultivo" name="cultivo" readonly required /></label>

    <table id="tablaMuestras">
      <thead>
        <tr>
          <th>#</th><th>Capilla</th><th>Cama</th><th>Módulo</th>
          <th>Cucumeris adulto</th><th>Huevos cucumeris</th><th>Swirskii adulto</th><th>Huevos swirskii</th>
          <th>Crisopa adulta</th><th>Huevo crisopa</th><th>Orius adulto</th><th>Orius ninfa</th>
          <th>Mildu</th><th>Mancha blanca</th><th>Cercospora</th>
          <th>Trips</th><th>Mosca blanca</th><th>Picudo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totales">
      Total individuos: <span id="totalIndividuos">0</span><br>
      Total m²: <span id="totalM2">0</span>
    </div>

    <div class="resumen">
      <h3>Totales por tipo</h3>
      <table>
        <thead><tr><th>Tipo</th><th>Total</th><th>Total/m²</th></tr></thead>
        <tbody id="tablaResumen"></tbody>
      </table>
    </div>

    <button type="submit" class="btn">Guardar Muestreo</button>
  </form>

  <script>
    const firebaseConfig = {
      databaseURL: "https://agro-productos-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const moduloInvernaderos = {
      C: [9,10,11,12], D: [13,14,15,16], I: [33,35], J: [37,39]
    };

    const campos = [
      "cucumeris_adulto", "huevo_cucumeris", "swirskii_adulto", "huevo_swirskii",
      "crisopa_adulta", "huevo_crisopa", "orius_adulto", "orius_ninfa",
      "mildu", "mancha_blanca", "cercospora",
      "trips", "mosca_blanca", "picudo"
    ];

    const etiquetas = {
      cucumeris_adulto:"Cucumeris adulto", huevo_cucumeris:"Huevos cucumeris",
      swirskii_adulto:"Swirskii adulto", huevo_swirskii:"Huevos swirskii",
      crisopa_adulta:"Crisopa adulta", huevo_crisopa:"Huevo crisopa",
      orius_adulto:"Orius adulto", orius_ninfa:"Orius ninfa",
      mildu:"Mildu", mancha_blanca:"Mancha blanca", cercospora:"Cercospora",
      trips:"Trips", mosca_blanca:"Mosca blanca", picudo:"Picudo"
    };

    const invernaderoSelect = document.getElementById("invernadero");
    const cultivoInput = document.getElementById("cultivo");
    const tablaBody = document.querySelector("#tablaMuestras tbody");
    const totalIndividuosEl = document.getElementById("totalIndividuos");
    const totalM2El = document.getElementById("totalM2");
    const tablaResumenEl = document.getElementById("tablaResumen");

    function actualizarModulo() {
      const modulo = document.getElementById("modulo").value;
      invernaderoSelect.innerHTML = "";
      moduloInvernaderos[modulo].forEach(num => {
        const opt = document.createElement("option");
        opt.value = num; opt.textContent = num;
        invernaderoSelect.appendChild(opt);
      });
      cultivoInput.value = (modulo === "D") ? "Tomate" : "Mini";
    }

    function getRandomUniqueNumbers(count, min, max) {
      const set = new Set();
      while (set.size < count) set.add(Math.floor(Math.random()*(max-min+1))+min);
      return Array.from(set);
    }

    function generarCapillas() {
      const norte = getRandomUniqueNumbers(5,1,18).map(n=>`${n}N`);
      const sur = getRandomUniqueNumbers(5,1,18).map(n=>`${n}S`);
      return norte.concat(sur);
    }

    function generarMuestras() {
      const capillas = generarCapillas();
      capillas.forEach((capilla, i) => {
        const cama = Math.floor(Math.random()*8)+1;
        const moduloAleatorio = Math.floor(Math.random()*10)+1;
        const fila = document.createElement("tr");
        let celdas = `<td>${i+1}</td><td><input value="${capilla}" readonly></td>
                      <td><input value="${cama}" readonly></td><td><input value="${moduloAleatorio}" readonly></td>`;
        campos.forEach(campo => {
          celdas += `<td><input type="number" name="${campo}" value="0" min="0" oninput="calcularTotales()">`;
        });
        fila.innerHTML = celdas;
        tablaBody.appendChild(fila);
      });
      calcularTotales();
    }

    function calcularTotales() {
      let total = 0;
      const resumen = {};
      campos.forEach(c=>resumen[c]=0);
      tablaBody.querySelectorAll("tr").forEach(tr=>{
        tr.querySelectorAll("input[type='number']").forEach(input=>{
          const val = Number(input.value)||0;
          resumen[input.name] += val;
          total += val;
        });
      });
      totalIndividuosEl.textContent = total;
      totalM2El.textContent = (total / 15.15).toFixed(2);
      tablaResumenEl.innerHTML = "";
      campos.forEach(campo => {
        tablaResumenEl.innerHTML += `<tr><td>${etiquetas[campo]}</td>
        <td>${resumen[campo]}</td><td>${(resumen[campo]/15.15).toFixed(2)}</td></tr>`;
      });
    }

    generarMuestras();

    document.getElementById("muestreoForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const data = {
        fecha: this.fecha.value,
        modulo: this.modulo.value,
        invernadero: this.invernadero.value,
        cultivo: this.cultivo.value,
        total_individuos: Number(totalIndividuosEl.textContent),
        total_m2: Number(totalM2El.textContent),
        muestras: []
      };

      tablaBody.querySelectorAll("tr").forEach(tr => {
        const cells = tr.querySelectorAll("input");
        const muestra = {
          capilla: cells[0].value,
          cama: Number(cells[1].value),
          modulo_aleatorio: Number(cells[2].value)
        };
        campos.forEach((campo, i) => {
          muestra[campo] = Number(cells[3+i].value);
        });
        data.muestras.push(muestra);
      });

      await db.ref("muestreos").push(data);
      alert("Muestreo guardado exitosamente");
      location.reload();
    });
  </script>
  <div class="footer">
        <p>Sistema Agroalpha © 2025 | Unidad produccion 1</p>
        <p>Versión 2.0 - Módulo completo</p>
    </div>

</body>
</html>