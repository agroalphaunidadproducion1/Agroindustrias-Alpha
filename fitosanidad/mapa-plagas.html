<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Plagas - Invernaderos</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --admin-color: #2196F3;
            --grower-junior-color: #FF9800;
            --digitador-color: #9C27B0;
            --tecnico-color: #607D8B;
            --supervisor-color: #FF5722;
            --invitado-color: #9E9E9E;
            --gerente-general-color: #E91E63;
            --gerente-produccion-color: #3F51B5;
            --jefe-vivero-color: #009688;
            --error-color: #f44336;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --dark-gray: #000000;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --sidebar-active: #3498db;
            
            /* Colores para plagas */
            --mosca-blanca-color: #FFEB3B;
            --acaro-rojo-color: #f44336;
            --acaro-blanco-color: #9E9E9E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-space {
            height: 70px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            min-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }

        .container {
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .breadcrumb {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 14px;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            color: var(--dark-gray);
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .legend-mosca {
            background-color: var(--mosca-blanca-color);
        }

        .legend-acaro-rojo {
            background-color: var(--acaro-rojo-color);
        }

        .legend-acaro-blanco {
            background-color: var(--acaro-blanco-color);
        }

        .greenhouse-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex: 1;
            min-height: 400px;
            max-height: 70vh;
        }

        .capillas-izquierda {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .capillas-derecha {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .pasillo-central {
            width: 30px;
            background: #5d4037;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #d7ccc8;
            font-weight: bold;
            font-size: 0.9rem;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            border-left: 2px dashed #8d6e63;
            border-right: 2px dashed #8d6e63;
            margin: 0 5px;
        }

        /* Capillas m谩s angostas - REDUCIDAS EN UN 20% */
        .capilla {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            display: flex;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            flex: 1;
            min-height: 28px; /* Reducido de 35px a 28px (20%) */
            font-weight: bold;
            font-size: 10px; /* Reducido de 11px a 10px */
            color: #495057;
            text-align: center;
            overflow: hidden;
        }

        .capilla-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            z-index: 2;
            position: relative;
            padding: 1px; /* Reducido de 2px a 1px */
        }

        .capilla:hover {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .capilla:hover::after {
            content: attr(data-info);
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: pre-line;
            z-index: 1000;
            pointer-events: none;
            text-align: center;
            line-height: 1.4;
            min-width: 180px;
        }

        /* Para el lado derecho, el tooltip aparece a la izquierda */
        .capillas-derecha .capilla:hover::after {
            left: auto;
            right: 100%;
            margin-left: 0;
            margin-right: 10px;
        }

        /* Segmentos de plagas dentro de las capillas */
        .plaga-segment {
            position: absolute;
            top: 0;
            bottom: 0;
            transition: all 0.3s ease;
        }

        .plaga-segment.mosca-blanca {
            background-color: var(--mosca-blanca-color);
        }

        .plaga-segment.acaro-rojo {
            background-color: var(--acaro-rojo-color);
        }

        .plaga-segment.acaro-blanco {
            background-color: var(--acaro-blanco-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .footer-space {
            height: 70px;
        }

        /* Alertas */
        .alert-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: #ff0000;
            border-radius: 50%;
            animation: blink 1s infinite;
            z-index: 3;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .greenhouse-container {
                flex-direction: column;
                min-height: auto;
                max-height: none;
            }
            
            .pasillo-central {
                width: 100%;
                height: 30px;
                writing-mode: horizontal-tb;
                margin: 8px 0;
            }
            
            .capillas-izquierda,
            .capillas-derecha {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .capilla {
                min-width: 70px;
                min-height: 40px; /* Ajustado para m贸vil */
                flex: 0 1 calc(16.666% - 8px);
            }

            /* En m贸vil, tooltips arriba */
            .capilla:hover::after {
                top: -100px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                margin: 0;
            }
            
            .capillas-derecha .capilla:hover::after {
                top: -100px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                margin: 0;
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
            }
            
            .legend {
                flex-direction: column;
                align-items: center;
            }
            
            .capilla {
                flex: 0 1 calc(33.333% - 8px);
                min-height: 35px; /* Ajustado para m贸vil */
                font-size: 9px; /* Reducido para m贸vil */
            }
        }
    </style>
</head>
<body>
    <!-- Espacio reservado para el header -->
    <div class="header-space"></div>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container">
            <div class="breadcrumb">
                <a href="#">Inicio</a> > <a href="#">Monitoreo</a> > Mapa de Plagas
            </div>
            
            <h1>Mapa de Plagas por Invernadero</h1>
            
            <!-- Controles -->
            <div class="controls">
                <div class="form-group">
                    <label for="invernadero">Seleccionar Invernadero:</label>
                    <select id="invernadero">
                        <option value="9">Invernadero 9</option>
                        <option value="10">Invernadero 10</option>
                        <option value="11">Invernadero 11</option>
                        <option value="12">Invernadero 12</option>
                        <option value="13">Invernadero 13</option>
                        <option value="14">Invernadero 14</option>
                        <option value="15">Invernadero 15</option>
                        <option value="16">Invernadero 16</option>
                        <option value="33">Invernadero 33</option>
                        <option value="35">Invernadero 35</option>
                        <option value="37">Invernadero 37</option>
                        <option value="39">Invernadero 39</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="plaga">Filtrar por Plaga:</label>
                    <select id="plaga">
                        <option value="todas">Todas las Plagas</option>
                        <option value="mosca-blanca">Mosca Blanca</option>
                        <option value="acaro-rojo">caro Rojo</option>
                        <option value="acaro-blanco">caro Blanco</option>
                    </select>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-mosca"></div>
                    <span>Mosca Blanca</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-acaro-rojo"></div>
                    <span>caro Rojo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-acaro-blanco"></div>
                    <span>caro Blanco</span>
                </div>
                <div class="legend-item">
                    <div style="width: 8px; height: 8px; background: #ff0000; border-radius: 50%; animation: blink 1s infinite;"></div>
                    <span>Alerta (>3 puntos)</span>
                </div>
            </div>

            <!-- Mapa del invernadero -->
            <div id="invernaderoMap" class="invernadero-map">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando datos desde Firebase...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Espacio reservado para el footer -->
    <div class="footer-space"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            databaseURL: "https://agro-productos-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM elements
        const invernaderoSelect = document.getElementById('invernadero');
        const plagaSelect = document.getElementById('plaga');
        const invernaderoMap = document.getElementById('invernaderoMap');

        // Variables para control de alertas
        let alertasMostradas = new Set();
        let plagueData = {};

        // Funci贸n para obtener el estado (por defecto "activo" si no existe)
        function getEstado(point) {
            return point.estado || 'activo';
        }

        // Generar estructura del mapa del invernadero
        function generateInvernaderoMap() {
            const selectedInvernadero = invernaderoSelect.value;
            const selectedPlaga = plagaSelect.value;
            
            // Filtrar datos para el invernadero seleccionado - SOLO PUNTOS ACTIVOS
            const filteredData = (plagueData[selectedInvernadero] || []).filter(point => 
                getEstado(point) === 'activo'
            );
            
            let html = `
                <div class="greenhouse-container">
                    <div class="capillas-izquierda">
                        ${generateCapillas('norte', filteredData, selectedPlaga)}
                    </div>
                    
                    <div class="pasillo-central">PASILLO</div>
                    
                    <div class="capillas-derecha">
                        ${generateCapillas('sur', filteredData, selectedPlaga)}
                    </div>
                </div>
            `;
            
            invernaderoMap.innerHTML = html;
            
            // Verificar y mostrar alertas
            checkAndShowAlerts(filteredData);
        }

        // Generar todas las capillas de un lado
        function generateCapillas(lado, data, plagaFiltro) {
            let html = '';
            
            // 18 capillas por lado
            for (let capilla = 1; capilla <= 18; capilla++) {
                html += generateCapilla(lado, capilla, data, plagaFiltro);
            }
            
            return html;
        }

        // Generar una capilla individual
        function generateCapilla(lado, numero, data, plagaFiltro) {
            const nombreCapilla = lado === 'norte' ? `${numero} NORTE` : `${numero} SUR`;
            const ubicacion = `${lado}-${numero}`;
            
            // Verificar si hay plagas en esta capilla
            const capillaData = data.filter(point => 
                point.ubicacion === ubicacion
            );
            
            // Determinar si la capilla debe mostrarse
            let showCapilla = true;
            let capillaInfo = `Capilla ${nombreCapilla}`;
            let tieneAlerta = false;
            
            if (capillaData.length > 0) {
                // Si hay datos de plagas en esta capilla
                const plagasEnCapilla = getPlagasEnCapilla(capillaData);
                
                // Si hay un filtro espec铆fico, verificar si coincide
                if (plagaFiltro !== 'todas' && !plagasEnCapilla.includes(plagaFiltro)) {
                    showCapilla = false;
                } else {
                    // Construir informaci贸n detallada para el tooltip
                    capillaInfo = `Capilla ${nombreCapilla}\n\n`;
                    
                    // Agrupar por tipo de plaga
                    const plagasAgrupadas = groupByPlaga(capillaData);
                    let totalPuntos = 0;
                    
                    for (const [plaga, puntos] of Object.entries(plagasAgrupadas)) {
                        capillaInfo += `${getPlagaName(plaga)}: ${puntos.length} puntos\n`;
                        totalPuntos += puntos.length;
                        
                        // Verificar si hay alerta (m谩s de 3 puntos de una plaga)
                        if (puntos.length > 3) {
                            tieneAlerta = true;
                            const alertaKey = `${ubicacion}-${plaga}`;
                            if (!alertasMostradas.has(alertaKey)) {
                                alertasMostradas.add(alertaKey);
                            }
                        }
                    }
                    
                    capillaInfo += `\nTotal: ${totalPuntos} puntos`;
                    capillaInfo += `\nHaga clic para ver detalles`;
                }
            }
            
            if (!showCapilla) {
                return `<div class="capilla" style="opacity: 0.3; cursor: default;">
                    <div class="capilla-content">${nombreCapilla}</div>
                </div>`;
            }
            
            // Generar segmentos de plagas
            const segmentosHTML = generatePlagaSegments(capillaData);
            const alertaHTML = tieneAlerta ? '<div class="alert-indicator"></div>' : '';
            
            return `<div class="capilla" data-info="${capillaInfo}" onclick="showCapillaDetails('${lado}', ${numero})">
                ${segmentosHTML}
                <div class="capilla-content">${nombreCapilla}</div>
                ${alertaHTML}
            </div>`;
        }

        // Generar segmentos de plagas dentro de la capilla
        function generatePlagaSegments(capillaData) {
            if (capillaData.length === 0) return '';
            
            const totalPuntos = capillaData.length;
            const plagasAgrupadas = groupByPlaga(capillaData);
            let segmentosHTML = '';
            let leftPosition = 0;
            
            for (const [plaga, puntos] of Object.entries(plagasAgrupadas)) {
                const porcentaje = (puntos.length / totalPuntos) * 100;
                segmentosHTML += `<div class="plaga-segment ${plaga}" style="left: ${leftPosition}%; width: ${porcentaje}%;"></div>`;
                leftPosition += porcentaje;
            }
            
            return segmentosHTML;
        }

        // Verificar y mostrar alertas
        function checkAndShowAlerts(data) {
            const plagasAgrupadasPorCapilla = {};
            
            // Agrupar datos por capilla y por plaga
            data.forEach(point => {
                if (!plagasAgrupadasPorCapilla[point.ubicacion]) {
                    plagasAgrupadasPorCapilla[point.ubicacion] = {};
                }
                if (!plagasAgrupadasPorCapilla[point.ubicacion][point.plaga]) {
                    plagasAgrupadasPorCapilla[point.ubicacion][point.plaga] = 0;
                }
                plagasAgrupadasPorCapilla[point.ubicacion][point.plaga]++;
            });
            
            // Verificar alertas
            for (const [ubicacion, plagas] of Object.entries(plagasAgrupadasPorCapilla)) {
                for (const [plaga, cantidad] of Object.entries(plagas)) {
                    if (cantidad > 3) {
                        const alertaKey = `${ubicacion}-${plaga}`;
                        if (!alertasMostradas.has(alertaKey)) {
                            mostrarAlerta(ubicacion, plaga, cantidad);
                            alertasMostradas.add(alertaKey);
                        }
                    }
                }
            }
        }

        // Mostrar alerta
        function mostrarAlerta(ubicacion, plaga, cantidad) {
            const [lado, numero] = ubicacion.split('-');
            const nombreCapilla = lado === 'norte' ? `${numero} NORTE` : `${numero} SUR`;
            const nombrePlaga = getPlagaName(plaga);
            
            setTimeout(() => {
                alert(` ALERTA - Capilla ${nombreCapilla}\n\nSe detectaron ${cantidad} puntos de ${nombrePlaga}\n\nSe recomienda revisi贸n inmediata.`);
            }, 1000);
        }

        // Obtener las plagas presentes en una capilla
        function getPlagasEnCapilla(capillaData) {
            const plagas = new Set();
            capillaData.forEach(point => {
                plagas.add(point.plaga);
            });
            return Array.from(plagas);
        }

        // Agrupar datos por tipo de plaga
        function groupByPlaga(capillaData) {
            const grouped = {};
            capillaData.forEach(point => {
                if (!grouped[point.plaga]) {
                    grouped[point.plaga] = [];
                }
                grouped[point.plaga].push(point);
            });
            return grouped;
        }

        // Helper functions
        function getPlagaName(plaga) {
            const names = {
                'mosca-blanca': 'Mosca Blanca',
                'acaro-rojo': 'caro Rojo',
                'acaro-blanco': 'caro Blanco'
            };
            return names[plaga] || plaga;
        }

        // Funci贸n para mostrar detalles de una capilla
        function showCapillaDetails(lado, numero) {
            const ubicacion = `${lado}-${numero}`;
            const nombreCapilla = lado === 'norte' ? `${numero} NORTE` : `${numero} SUR`;
            const selectedInvernadero = invernaderoSelect.value;
            const capillaData = (plagueData[selectedInvernadero] || []).filter(point => 
                point.ubicacion === ubicacion && getEstado(point) === 'activo'
            );
            
            if (capillaData.length === 0) {
                alert(`Capilla ${nombreCapilla}\n\nNo hay plagas registradas en esta capilla.`);
                return;
            }
            
            let detalles = `Detalles de la Capilla ${nombreCapilla}\n\n`;
            const plagasAgrupadas = groupByPlaga(capillaData);
            
            for (const [plaga, puntos] of Object.entries(plagasAgrupadas)) {
                detalles += `${getPlagaName(plaga)}: ${puntos.length} puntos\n`;
            }
            
            detalles += `\nTotal: ${capillaData.length} puntos`;
            
            // Verificar si hay alertas para esta capilla
            let tieneAlerta = false;
            for (const [plaga, puntos] of Object.entries(plagasAgrupadas)) {
                if (puntos.length > 3) {
                    tieneAlerta = true;
                    break;
                }
            }
            
            if (tieneAlerta) {
                detalles += `\n\n锔  ESTA CAPILLA TIENE ALERTAS ACTIVAS`;
            }
            
            alert(detalles);
        }

        // Cargar datos desde Firebase
        function loadDataFromFirebase() {
            const plaguePointsRef = database.ref('plague-points');
            
            plaguePointsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const organizedData = {};

                if (data) {
                    console.log("Datos recibidos de Firebase:", data);
                    
                    // Organizar datos por invernadero
                    Object.keys(data).forEach(key => {
                        const point = data[key];
                        if (point && point.invernadero) {
                            const invernadero = point.invernadero.toString();
                            if (!organizedData[invernadero]) {
                                organizedData[invernadero] = [];
                            }
                            organizedData[invernadero].push(point);
                        }
                    });

                    plagueData = organizedData;
                    console.log("Datos organizados:", plagueData);
                    generateInvernaderoMap();
                } else {
                    console.log("No hay datos en Firebase");
                    invernaderoMap.innerHTML = `
                        <div class="no-data">
                            <h3>No hay datos disponibles</h3>
                            <p>No se encontraron registros de plagas en la base de datos</p>
                        </div>
                    `;
                }
            }, (error) => {
                console.error('Error loading data:', error);
                invernaderoMap.innerHTML = `
                    <div class="no-data">
                        <h3>Error al cargar datos</h3>
                        <p>No se pudieron cargar los datos desde Firebase</p>
                    </div>
                `;
            });
        }

        // Inicializar
        function init() {
            // Event listeners
            invernaderoSelect.addEventListener('change', function() {
                alertasMostradas.clear();
                generateInvernaderoMap();
            });
            
            plagaSelect.addEventListener('change', generateInvernaderoMap);
            
            // Cargar datos iniciales desde Firebase
            loadDataFromFirebase();
        }

        // Iniciar la aplicaci贸n
        init();
    </script>
</body>
</html>
