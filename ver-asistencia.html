<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Asistencia Semanal - Agro Alpha</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="components.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --admin-color: #2196F3;
            --grower-junior-color: #FF9800;
            --digitador-color: #9C27B0;
            --tecnico-color: #607D8B;
            --supervisor-color: #FF5722;
            --invitado-color: #9E9E9E;
            --gerente-general-color: #E91E63;
            --gerente-produccion-color: #3F51B5;
            --jefe-vivero-color: #009688;
            --error-color: #f44336;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --dark-gray: #000000;
            
            /* Colores para cultivos */
            --chile-color: #2e7d32;
            --tomate-color: #c62828;
            --otras-areas-color: #6f42c1;
            --light-bg: #f1f8e9;
            
            /* Colores para niveles de asistencia */
            --alto-color: #4CAF50;
            --medio-color: #FF9800;
            --bajo-color: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--dark-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        .container {
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .breadcrumb {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        .card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            border: none;
        }
        
        .card-header {
            border-radius: 8px 8px 0 0 !important;
            font-weight: 600;
            color: white;
            padding: 15px 20px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 4px;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-view-mode {
            background-color: var(--light-gray);
            border: 1px solid #dee2e6;
            color: var(--dark-gray);
            padding: 6px 12px;
            margin-right: 5px;
        }

        .btn-view-mode.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .table th {
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            font-size: 0.9rem;
            text-align: center;
            vertical-align: middle;
        }

        .table td {
            padding: 8px;
            font-size: 0.85rem;
            text-align: center;
            vertical-align: middle;
        }

        .percentage-cell {
            font-weight: bold;
            cursor: pointer;
        }

        .count-cell {
            font-weight: normal;
            cursor: pointer;
        }

        .high-percentage {
            color: var(--alto-color);
        }

        .medium-percentage {
            color: var(--medio-color);
        }

        .low-percentage {
            color: var(--bajo-color);
        }

        .date-filter {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .view-mode-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .cultivo-card {
            transition: all 0.3s ease;
        }

        .cultivo-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .day-column {
            font-weight: bold;
            min-width: 60px;
        }

        .week-total {
            background-color: #e8f5e9;
            font-weight: bold;
        }

        .inv-header {
            min-width: 70px;
            font-weight: bold;
        }

        .no-data {
            color: #6c757d;
            font-style: italic;
        }

        .no-attendance {
            color: #ccc;
            font-style: italic;
        }

        .total-row {
            background-color: var(--light-gray);
            font-weight: bold;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-right: 10px;
        }

        /* Tooltip para mostrar detalles */
        .count-tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        /* Estilo para celdas combinadas de promedio */
        .combined-average {
            background-color: #e3f2fd !important;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Estilo para la columna de promedio al final */
        .average-column {
            background-color: #e8f5e9 !important;
            font-weight: bold;
            border-left: 3px solid var(--primary-color) !important;
        }

        /* Estilos para promedios diarios */
        .daily-average-row {
            background-color: #f0f8ff !important;
            font-weight: bold;
        }

        .daily-average-cell {
            background-color: #f0f8ff !important;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Estilo para la celda de promedio semanal combinada */
        .weekly-average-combined {
            background-color: white !important;
            font-weight: bold;
            font-size: 1.8rem;
            text-align: center;
            vertical-align: middle;
            color: var(--dark-gray);
            border: 2px solid var(--primary-color);
            height: 80px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }

            .table-responsive {
                font-size: 0.8rem;
            }

            .day-column {
                min-width: 50px;
                font-size: 0.75rem;
                padding: 5px 3px;
            }

            .inv-header {
                min-width: 60px;
                font-size: 0.75rem;
            }

            .table th, .table td {
                padding: 6px 4px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .card-header h5 {
                font-size: 0.95rem;
            }

            .view-mode-container {
                justify-content: flex-start;
                margin-top: 10px;
            }

            .average-column {
                font-size: 0.9rem;
            }

            .weekly-average-combined {
                font-size: 1.4rem;
                height: 60px;
            }
        }

        @media (max-width: 576px) {
            .header {
                padding: 15px 0;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .table-responsive {
                overflow-x: auto;
                font-size: 0.7rem;
            }

            .day-column {
                min-width: 45px;
                font-size: 0.7rem;
                padding: 4px 2px;
            }

            .inv-header {
                min-width: 50px;
                font-size: 0.7rem;
            }

            .table th, .table td {
                padding: 4px 2px;
            }

            .percentage-cell, .count-cell {
                font-size: 0.75rem;
            }

            .date-filter {
                padding: 10px;
            }

            .btn-view-mode {
                padding: 4px 8px;
                font-size: 0.8rem;
            }

            .combined-average {
                font-size: 0.9rem;
            }

            .average-column {
                font-size: 0.8rem;
            }

            .weekly-average-combined {
                font-size: 1.2rem;
                height: 50px;
            }
        }
    </style>
</head>
<body>

 <!-- Componentes -->
    <header-component></header-component>
    <sidebar-component></sidebar-component>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container">
            <div class="breadcrumb">
                <a href="dashboard.html">Inicio</a> > <a href="reportes.html">Reportes</a> > Asistencia Semanal
            </div>
            
            <div class="header text-center">
                <h1><i class="fas fa-chart-bar me-2"></i>Reportes de Asistencia Semanal</h1>
            </div>

            <!-- Selector de semana -->
            <div class="date-filter">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="semana-select" class="form-label"><strong>Seleccione la semana del año:</strong></label>
                        <select class="form-select" id="semana-select">
                            <option value="">Cargando semanas...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><strong>Rango de fechas:</strong></label>
                        <div id="rango-fechas" class="form-control" style="background-color: white; height: 38px; display: flex; align-items: center;">
                            Cargando...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenedor para botones de modo de visualización -->
            <div class="view-mode-container">
                <div class="btn-group" role="group" aria-label="Modo de visualización">
                    <button type="button" id="btn-porcentajes" class="btn btn-view-mode active">
                        <i class="fas fa-percentage me-1"></i> Porcentajes
                    </button>
                    <button type="button" id="btn-numeros" class="btn btn-view-mode">
                        <i class="fas fa-users me-1"></i> Números
                    </button>
                </div>
            </div>

            <!-- Reporte Detallado Chile -->
            <div class="card">
                <div class="card-header" style="background-color: var(--chile-color);">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Reporte Detallado - Chile</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th class="inv-header">Inv</th>
                                    <!-- Los encabezados de días se generarán dinámicamente -->
                                </tr>
                            </thead>
                            <tbody id="chile-table-body">
                                <tr>
                                    <td colspan="8" class="text-center loading">
                                        <div class="spinner-border" style="color: var(--chile-color);" role="status"></div>
                                        Cargando datos de asistencia...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reporte Detallado Tomate -->
            <div class="card mt-4">
                <div class="card-header" style="background-color: var(--tomate-color);">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Reporte Detallado - Tomate</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th class="inv-header">Inv</th>
                                    <!-- Los encabezados de días se generarán dinámicamente -->
                                </tr>
                            </thead>
                            <tbody id="tomate-table-body">
                                <tr>
                                    <td colspan="8" class="text-center loading">
                                        <div class="spinner-border" style="color: var(--tomate-color);" role="status"></div>
                                        Cargando datos de asistencia...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reporte Detallado Otras Áreas -->
            <div class="card mt-4">
                <div class="card-header" style="background-color: var(--otras-areas-color);">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Reporte Detallado - Otras Áreas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th class="inv-header">Área</th>
                                    <!-- Los encabezados de días se generarán dinámicamente -->
                                </tr>
                            </thead>
                            <tbody id="otras-areas-table-body">
                                <tr>
                                    <td colspan="8" class="text-center loading">
                                        <div class="spinner-border" style="color: var(--otras-areas-color);" role="status"></div>
                                        Cargando datos de asistencia...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            databaseURL: "https://agro-productos-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        console.log('Firebase inicializado correctamente');

        // Referencias a las tablas
        const personalRef = database.ref('personal');
        const attendanceRef = database.ref('asistencia');

        // Definir invernaderos por cultivo
        const chileInvernaderos = ['9', '10', '11', '12', '33', '35', '37', '39'];
        const tomateInvernaderos = ['13', '14', '15', '16', 'Viv'];
        const otrasAreas = ['Mantenimiento', 'Fitosanidad', 'Riego', 'Vivero'];

        // Días de la semana (abreviados)
        const diasSemana = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

        // Variables globales
        let allEmployees = [];
        let weekData = {};
        let currentWeekDates = [];
        let availableWeekDates = [];
        let viewMode = 'percentage';
        let currentWeekNumber = 0;

        // Mapeo de nombres abreviados a nombres completos
        const areaNameMapping = {
            'Viv': 'Vivero',
            'MT': 'Mantenimiento',
            'AV': 'Áreas Verdes',
            'Fito': 'Fitosanidad',
            'Riego': 'Riego'
        };

        // Mapeo inverso de nombres completos a abreviados
        const areaAbbreviationMapping = {
            'Vivero': 'Viv',
            'Mantenimiento': 'MT',
            'Áreas Verdes': 'AV',
            'Fitosanidad': 'Fito',
            'Riego': 'Riego'
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando aplicación...');
            setupEventListeners();
            loadEmployees();
            loadWeeksSelector().then(() => {
                const today = new Date();
                currentWeekNumber = getWeekNumber(today);
                console.log('Semana actual:', currentWeekNumber);
                document.getElementById('semana-select').value = currentWeekNumber;
                updateWeekDates(currentWeekNumber);
                loadAttendanceData();
            });
        });

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('btn-porcentajes').addEventListener('click', () => setViewMode('percentage'));
            document.getElementById('btn-numeros').addEventListener('click', () => setViewMode('count'));
            
            document.getElementById('semana-select').addEventListener('change', function() {
                console.log('Cambiando a semana:', this.value);
                updateWeekDates(this.value);
                loadAttendanceData();
            });
        }

        // Establecer modo de visualización
        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('btn-porcentajes').classList.toggle('active', mode === 'percentage');
            document.getElementById('btn-numeros').classList.toggle('active', mode === 'count');
            
            if (Object.keys(weekData).length > 0) {
                console.log('Cambiando modo de visualización a:', mode);
                processReportData();
            }
        }

        // Cargar selector de semanas
        function loadWeeksSelector() {
            return new Promise((resolve) => {
                const selector = document.getElementById('semana-select');
                selector.innerHTML = '';
                
                const currentYear = new Date().getFullYear();
                
                for (let week = 1; week <= 52; week++) {
                    const option = document.createElement('option');
                    option.value = week;
                    option.textContent = `Semana ${week} - ${currentYear}`;
                    selector.appendChild(option);
                }
                
                console.log('Selector de semanas cargado');
                resolve();
            });
        }

        // Actualizar rango de fechas al cambiar la semana
        function updateWeekDates(weekNumber) {
            if (!weekNumber) return;
            
            const year = new Date().getFullYear();
            const firstDay = getFirstDayOfWeek(weekNumber, year);
            
            currentWeekDates = [];
            for (let i = 0; i < 6; i++) {
                const date = new Date(firstDay);
                date.setDate(firstDay.getDate() + i);
                currentWeekDates.push(formatDate(date));
            }
            
            const lastDay = new Date(firstDay);
            lastDay.setDate(firstDay.getDate() + 5);
            
            const options = { day: '2-digit', month: '2-digit' };
            const startFormatted = firstDay.toLocaleDateString('es-ES', options);
            const endFormatted = lastDay.toLocaleDateString('es-ES', options);
            
            document.getElementById('rango-fechas').textContent = 
                `${startFormatted} al ${endFormatted} de ${year}`;
            
            console.log('Fechas de la semana:', currentWeekDates);
        }

        // Obtener el número de semana de una fecha
        function getWeekNumber(date) {
            date = new Date(date);
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        // Obtener el primer día (lunes) de una semana específica
        function getFirstDayOfWeek(week, year) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dayOfWeek = simple.getDay();
            const ISOweekStart = simple;
            
            if (dayOfWeek <= 4) {
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            } else {
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            }
            
            return ISOweekStart;
        }

        // Formatear fecha como YYYY-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            
            return [year, month, day].join('-');
        }

        // Cargar empleados desde Firebase
        function loadEmployees() {
            console.log('Cargando empleados...');
            personalRef.once('value').then((snapshot) => {
                allEmployees = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const employee = childSnapshot.val();
                        employee.id = childSnapshot.key;
                        allEmployees.push(employee);
                    });
                    console.log('Empleados cargados:', allEmployees.length);
                } else {
                    console.log('No hay empleados en la base de datos');
                }
            }).catch((error) => {
                console.error('Error al cargar empleados:', error);
                showError('Error al cargar los datos de empleados');
            });
        }

        // Cargar datos de asistencia
        function loadAttendanceData() {
            console.log('Cargando datos de asistencia...');
            weekData = {};
            availableWeekDates = [];
            
            showLoadingState();
            
            const checkPromises = currentWeekDates.map(date => {
                return attendanceRef.child(date).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        console.log('Datos encontrados para:', date);
                        return date;
                    } else {
                        console.log('No hay datos para:', date);
                        return null;
                    }
                });
            });
            
            Promise.all(checkPromises).then(existingDates => {
                availableWeekDates = existingDates.filter(date => date !== null);
                console.log('Fechas con datos:', availableWeekDates);
                
                if (availableWeekDates.length === 0) {
                    showError('No hay datos de asistencia para esta semana');
                    return;
                }
                
                const loadPromises = availableWeekDates.map(date => {
                    return attendanceRef.child(date).once('value').then(snapshot => {
                        if (snapshot.exists()) {
                            weekData[date] = snapshot.val();
                            console.log(`Datos cargados para ${date}:`, Object.keys(weekData[date]).length, 'áreas');
                        }
                    });
                });
                
                Promise.all(loadPromises).then(() => {
                    console.log('Todos los datos cargados, procesando...');
                    processReportData();
                }).catch(error => {
                    console.error('Error al cargar datos de asistencia:', error);
                    showError('Error al cargar los datos de asistencia');
                });
            }).catch(error => {
                console.error('Error al verificar fechas existentes:', error);
                showError('Error al verificar datos disponibles');
            });
        }

        // Mostrar estado de carga
        function showLoadingState() {
            const loadingHTML = '<tr><td colspan="8" class="text-center loading"><div class="spinner-border" role="status"></div>Cargando datos...</td></tr>';
            document.getElementById('chile-table-body').innerHTML = loadingHTML;
            document.getElementById('tomate-table-body').innerHTML = loadingHTML;
            document.getElementById('otras-areas-table-body').innerHTML = loadingHTML;
        }

        // Procesar datos para el reporte
        function processReportData() {
            console.log('Procesando datos del reporte...');
            const reportData = initializeReportData();
            populateReportData(reportData);
            generateReport(reportData);
            console.log('Reporte generado correctamente');
        }

        // Inicializar estructura de datos para el reporte
        function initializeReportData() {
            const reportData = {};
            const allAreas = [...chileInvernaderos, ...tomateInvernaderos, ...otrasAreas];
            
            allAreas.forEach(area => {
                reportData[area] = {
                    dailyAttendance: {},
                    dailyTotals: {},
                    weekTotal: 0,
                    weekMax: 0,
                    daysWithData: 0
                };
                
                currentWeekDates.forEach(date => {
                    reportData[area].dailyAttendance[date] = 0;
                    reportData[area].dailyTotals[date] = 0;
                });
            });
            
            return reportData;
        }

        // Poblar datos del reporte
        function populateReportData(reportData) {
            availableWeekDates.forEach(date => {
                if (weekData[date]) {
                    Object.keys(weekData[date]).forEach(area => {
                        let targetArea = mapAreaName(area);
                        
                        if (reportData[targetArea]) {
                            reportData[targetArea].daysWithData++;
                            const areaData = weekData[date][area];
                            reportData[targetArea].dailyTotals[date] = Object.keys(areaData).length;
                            
                            let presentCount = 0;
                            Object.keys(areaData).forEach(employeeId => {
                                if (areaData[employeeId] === true) {
                                    presentCount++;
                                }
                            });
                            
                            reportData[targetArea].dailyAttendance[date] = presentCount;
                            reportData[targetArea].weekTotal += presentCount;
                            reportData[targetArea].weekMax += Object.keys(areaData).length;
                        }
                    });
                }
            });
        }

        // Mapear nombres de áreas
        function mapAreaName(area) {
            const mapping = {
                'Vivero': 'Viv',
                'Mantenimiento': 'MT',
                'Áreas Verdes': 'AV',
                'Fitosanidad': 'Fito'
            };
            return mapping[area] || area;
        }

        // Generar el reporte visual
        function generateReport(reportData) {
            generateTableHeaders();
            generateChileTable(reportData);
            generateTomateTable(reportData);
            generateOtrasAreasTable(reportData);
            addCellClickListeners();
        }

        // Generar encabezados de tabla dinámicamente
        function generateTableHeaders() {
            const tables = [
                document.querySelector('#chile-table-body').closest('.table').querySelector('thead tr'),
                document.querySelector('#tomate-table-body').closest('.table').querySelector('thead tr'),
                document.querySelector('#otras-areas-table-body').closest('.table').querySelector('thead tr')
            ];
            
            tables.forEach(header => {
                while (header.children.length > 1) header.removeChild(header.lastChild);
                
                // Agregar encabezados para todos los días de la semana
                currentWeekDates.forEach((date, index) => {
                    const th = document.createElement('th');
                    th.className = 'day-column';
                    th.textContent = diasSemana[index];
                    th.title = date;
                    header.appendChild(th);
                });
                
                // NO agregamos la columna de promedio semanal aquí
            });
        }

        // Generar tabla de chile
        function generateChileTable(reportData) {
            generateCultivoTable('chile-table-body', chileInvernaderos, reportData, 'Chile');
        }

        // Generar tabla de tomate
        function generateTomateTable(reportData) {
            generateCultivoTable('tomate-table-body', tomateInvernaderos, reportData, 'Tomate');
        }

        // Generar tabla de otras áreas
        function generateOtrasAreasTable(reportData) {
            generateCultivoTable('otras-areas-table-body', otrasAreas, reportData, 'Otras Áreas', true);
        }

        // Generar tabla de cultivo genérica
        function generateCultivoTable(tableBodyId, areas, reportData, cultivoName, useAbbreviations = false) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';
            
            const cultivoData = areas.map(area => ({
                area: useAbbreviations ? (areaAbbreviationMapping[area] || area) : area,
                data: reportData[area] || createEmptyAreaData()
            }));
            
            if (cultivoData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center">No hay datos disponibles para ${cultivoName.toLowerCase()}</td></tr>`;
                return;
            }
            
            // Calcular el promedio semanal general para toda la tabla
            let totalWeekPresent = 0;
            let totalWeekMax = 0;
            
            cultivoData.forEach(({data}) => {
                totalWeekPresent += data.weekTotal;
                totalWeekMax += data.weekMax;
            });
            
            const weeklyAveragePercentage = totalWeekMax > 0 ? Math.round((totalWeekPresent / totalWeekMax) * 100) : 0;
            const weeklyAverageCount = totalWeekMax > 0 ? Math.round(totalWeekPresent / (currentWeekDates.length * cultivoData.length)) : 0;
            
            // Generar filas para cada área
            cultivoData.forEach(({area, data}) => {
                const row = createAreaRow(area, data);
                tableBody.appendChild(row);
            });
            
            // Generar fila de promedios diarios
            const dailyAverageRow = createDailyAverageRow(cultivoData);
            tableBody.appendChild(dailyAverageRow);
            
            // Generar fila de promedio semanal combinado (ocupa toda la tabla)
            const weeklyAverageRow = createWeeklyAverageRow(cultivoData, weeklyAveragePercentage, weeklyAverageCount);
            tableBody.appendChild(weeklyAverageRow);
        }

        // Crear datos vacíos para área
        function createEmptyAreaData() {
            return {
                dailyAttendance: {},
                dailyTotals: {},
                weekTotal: 0,
                weekMax: 0,
                daysWithData: 0
            };
        }

        // Crear fila de área
        function createAreaRow(area, data) {
            const row = document.createElement('tr');
            let rowContent = `<td class="inv-header"><strong>${area}</strong></td>`;
            
            // Celdas para cada día de la semana
            currentWeekDates.forEach(date => {
                const presentCount = data.dailyAttendance[date] || 0;
                const totalEmployees = data.dailyTotals[date] || 0;
                
                if (totalEmployees > 0) {
                    const percentage = Math.round((presentCount / totalEmployees) * 100);
                    
                    if (viewMode === 'percentage') {
                        const percentageClass = getPercentageClass(percentage);
                        rowContent += `<td class="percentage-cell ${percentageClass}" data-present="${presentCount}" data-total="${totalEmployees}">${percentage}%</td>`;
                    } else {
                        rowContent += `<td class="count-cell" data-present="${presentCount}" data-total="${totalEmployees}">${presentCount}</td>`;
                    }
                } else {
                    rowContent += `<td class="${viewMode === 'percentage' ? 'percentage-cell' : 'count-cell'} no-attendance">-</td>`;
                }
            });
            
            row.innerHTML = rowContent;
            return row;
        }

        // Crear fila de promedios diarios
        function createDailyAverageRow(cultivoData) {
            const row = document.createElement('tr');
            row.className = 'daily-average-row';
            
            let rowContent = `<td class="inv-header"><strong>Prom. Diario</strong></td>`;
            
            // Calcular promedios diarios para cada día
            currentWeekDates.forEach(date => {
                let totalPresent = 0;
                let totalEmployees = 0;
                
                cultivoData.forEach(({data}) => {
                    totalPresent += data.dailyAttendance[date] || 0;
                    totalEmployees += data.dailyTotals[date] || 0;
                });
                
                if (totalEmployees > 0) {
                    const averagePercentage = Math.round((totalPresent / totalEmployees) * 100);
                    const averageCount = Math.round(totalPresent / cultivoData.length);
                    
                    if (viewMode === 'percentage') {
                        const percentageClass = getPercentageClass(averagePercentage);
                        rowContent += `<td class="daily-average-cell ${percentageClass}" data-present="${totalPresent}" data-total="${totalEmployees}">${averagePercentage}%</td>`;
                    } else {
                        rowContent += `<td class="daily-average-cell" data-present="${totalPresent}" data-total="${totalEmployees}">${averageCount}</td>`;
                    }
                } else {
                    rowContent += `<td class="daily-average-cell no-attendance">-</td>`;
                }
            });
            
            row.innerHTML = rowContent;
            return row;
        }

        // Crear fila de promedio semanal combinado
        function createWeeklyAverageRow(cultivoData, weeklyAveragePercentage, weeklyAverageCount) {
            const row = document.createElement('tr');
            row.className = 'total-row';
            
            let rowContent = '';
            
            if (weeklyAveragePercentage > 0) {
                const percentageClass = getPercentageClass(weeklyAveragePercentage);
                if (viewMode === 'percentage') {
                    rowContent = `<td class="weekly-average-combined ${percentageClass}" colspan="${currentWeekDates.length + 1}" data-present="${weeklyAverageCount * currentWeekDates.length * cultivoData.length}" data-total="${cultivoData.length * currentWeekDates.length}">Promedio Semanal: ${weeklyAveragePercentage}%</td>`;
                } else {
                    rowContent = `<td class="weekly-average-combined" colspan="${currentWeekDates.length + 1}" data-present="${weeklyAverageCount * currentWeekDates.length * cultivoData.length}" data-total="${cultivoData.length * currentWeekDates.length}">Promedio Semanal: ${weeklyAverageCount}</td>`;
                }
            } else {
                rowContent = `<td class="weekly-average-combined no-attendance" colspan="${currentWeekDates.length + 1}">Promedio Semanal: -</td>`;
            }
            
            row.innerHTML = rowContent;
            return row;
        }

        // Obtener clase CSS según el porcentaje
        function getPercentageClass(percentage) {
            if (percentage >= 80) return 'high-percentage';
            if (percentage >= 70) return 'medium-percentage';
            return 'low-percentage';
        }

        // Agregar event listeners para mostrar detalles al hacer clic
        function addCellClickListeners() {
            const cells = document.querySelectorAll('.percentage-cell, .count-cell, .daily-average-cell, .weekly-average-combined');
            cells.forEach(cell => {
                if (!cell.classList.contains('no-attendance')) {
                    cell.addEventListener('click', function() {
                        const present = this.getAttribute('data-present');
                        const total = this.getAttribute('data-total');
                        
                        if (present && total) {
                            showTooltip(this, `${present}/${total}`);
                        }
                    });
                }
            });
        }

        // Mostrar tooltip
        function showTooltip(element, text) {
            let tooltip = document.querySelector('.count-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'count-tooltip';
                document.body.appendChild(tooltip);
            }
            
            const rect = element.getBoundingClientRect();
            tooltip.textContent = text;
            tooltip.style.left = `${rect.left + window.scrollX}px`;
            tooltip.style.top = `${rect.top + window.scrollY - 30}px`;
            tooltip.style.display = 'block';
            
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 2000);
        }

        // Mostrar mensaje de error
        function showError(message) {
            const errorHTML = `<tr><td colspan="8" class="text-center text-danger">${message}</td></tr>`;
            document.getElementById('chile-table-body').innerHTML = errorHTML;
            document.getElementById('tomate-table-body').innerHTML = errorHTML;
            document.getElementById('otras-areas-table-body').innerHTML = errorHTML;
        }
    </script>
    <script src="header-component.js"></script>
    <script src="sidebar-component.js"></script>
    <script src="footer.js"></script>
</body>
</html>
