<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - Agro Productos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #1b5e20;
            --accent-color: #7cb342;
            --light-bg: #f1f8e9;
        }
        
        body {
            background-color: var(--light-bg);
            padding-top: 20px;
            padding-bottom: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 0;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 12px;
            border: none;
        }
        
        .card-header {
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-filter {
            background-color: #e8f5e9;
            color: var(--secondary-color);
            border: 1px solid #c8e6c9;
        }
        
        .btn-filter:hover, .btn-filter.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .attendance-table th, .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .attendance-table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .attendance-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .present {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .absent {
            color: #dc3545;
        }
        
        .attendance-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-present {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-absent {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .section-title {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .current-date {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .filter-section {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .filter-tag {
            background-color: var(--accent-color);
            color: white;
            border-radius: 15px;
            padding: 3px 10px;
            font-size: 0.85rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-clipboard-check me-2"></i>Sistema de Asistencia</h1>
            <p class="lead">Agro Productos - Control de Asistencia del Personal</p>
            <div class="current-date" id="current-date"></div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Registro de Asistencia Diaria</h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="filter-section mb-4">
                            <h5 class="section-title"><i class="fas fa-filter me-2"></i>Filtros</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Módulo:</strong></label>
                                    <div class="btn-group btn-group-sm flex-wrap" role="group">
                                        <button type="button" class="btn btn-filter" data-modulo="all">Todos</button>
                                        <button type="button" class="btn btn-filter" data-modulo="C">Módulo C</button>
                                        <button type="button" class="btn btn-filter" data-modulo="D">Módulo D</button>
                                        <button type="button" class="btn btn-filter" data-modulo="I">Módulo I</button>
                                        <button type="button" class="btn btn-filter" data-modulo="J">Módulo J</button>
                                        <button type="button" class="btn btn-filter" data-modulo="invernadero">Invernadero</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><strong>Invernadero:</strong></label>
                                    <div class="btn-group btn-group-sm flex-wrap" id="invernadero-filters" role="group">
                                        <button type="button" class="btn btn-filter" data-invernadero="all">Todos</button>
                                        <!-- Los filtros de invernadero se cargarán dinámicamente -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label"><strong>Filtros aplicados:</strong></label>
                                    <div id="active-filters">
                                        <span class="filter-tag">Todos los empleados</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="search-employee" class="form-control" placeholder="Buscar por nombre o código...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success me-2" id="mark-all-present">
                                    <i class="fas fa-check-circle me-2"></i>Marcar Todos Presentes
                                </button>
                                <button class="btn btn-primary" id="save-attendance">
                                    <i class="fas fa-save me-2"></i>Guardar Asistencia
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="attendance-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Código</th>
                                        <th>Puesto</th>
                                        <th>Módulo</th>
                                        <th>Invernaderos</th>
                                        <th class="text-center">Asistencia</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-list">
                                    <tr>
                                        <td colspan="6" class="text-center">Cargando empleados...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Resumen de Asistencia</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Total Empleados</h6>
                                        <h3 id="total-employees">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Presentes</h6>
                                        <h3 id="present-count">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Ausentes</h6>
                                        <h3 id="absent-count">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instrucciones</h5>
                    </div>
                    <div class="card-body">
                        <ol>
                            <li>Use los filtros para mostrar empleados específicos por módulo o invernadero</li>
                            <li>Seleccione "Presente" o "Ausente" para cada empleado</li>
                            <li>Utilice el botón "Marcar Todos Presentes" para marcar a todos rápidamente</li>
                            <li>Haga clic en "Guardar Asistencia" para guardar los registros en el sistema</li>
                            <li>Los datos se guardarán en la tabla "asistencia" de Firebase</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Configuración de Firebase con tu URL
        const firebaseConfig = {
            databaseURL: "https://agro-productos-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Referencias a las tablas
        const personalRef = database.ref('personal');
        const attendanceRef = database.ref('asistencia');

        // Mostrar fecha actual
        const today = new Date();
        const formattedDate = today.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        document.getElementById('current-date').textContent = formattedDate;

        // Formatear fecha como YYYY-MM-DD para usar como ID
        const dateId = today.toISOString().split('T')[0];

        // Variables globales
        let allEmployees = [];
        let filteredEmployees = [];
        let currentFilters = {
            modulo: 'all',
            invernadero: 'all',
            search: ''
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadEmployees();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Filtros de módulo
            document.querySelectorAll('[data-modulo]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modulo = this.dataset.modulo;
                    currentFilters.modulo = modulo;
                    updateFiltersUI();
                    applyFilters();
                });
            });

            // Filtros de invernadero (se configurarán después de cargar los empleados)
            
            // Búsqueda
            document.getElementById('search-employee').addEventListener('input', function() {
                currentFilters.search = this.value.toLowerCase();
                applyFilters();
            });

            // Botones de acción
            document.getElementById('mark-all-present').addEventListener('click', markAllPresent);
            document.getElementById('save-attendance').addEventListener('click', saveAttendance);
        }

        // Cargar empleados desde Firebase
        function loadEmployees() {
            personalRef.once('value').then((snapshot) => {
                allEmployees = [];
                snapshot.forEach((childSnapshot) => {
                    const employee = childSnapshot.val();
                    employee.id = childSnapshot.key;
                    allEmployees.push(employee);
                });
                
                // Inicializar empleados filtrados con todos los empleados
                filteredEmployees = [...allEmployees];
                
                // Cargar filtros de invernadero
                loadInvernaderoFilters();
                
                // Cargar asistencia
                loadAttendance();
            }).catch((error) => {
                console.error('Error al cargar empleados:', error);
                document.getElementById('attendance-list').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error al cargar los empleados</td></tr>';
            });
        }

        // Cargar filtros de invernadero
        function loadInvernaderoFilters() {
            const invernaderoFiltersContainer = document.getElementById('invernadero-filters');
            
            // Obtener todos los invernaderos únicos
            const allInvernaderos = new Set();
            allEmployees.forEach(employee => {
                if (employee.invernaderos && Array.isArray(employee.invernaderos)) {
                    employee.invernaderos.forEach(inv => allInvernaderos.add(inv));
                }
            });
            
            // Crear botones de filtro para cada invernadero
            const invernaderosArray = Array.from(allInvernaderos).sort();
            invernaderosArray.forEach(invernadero => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-filter';
                button.dataset.invernadero = invernadero;
                button.textContent = `Invernadero ${invernadero}`;
                
                button.addEventListener('click', function() {
                    currentFilters.invernadero = this.dataset.invernadero;
                    updateFiltersUI();
                    applyFilters();
                });
                
                invernaderoFiltersContainer.appendChild(button);
            });
        }

        // Aplicar filtros
        function applyFilters() {
            filteredEmployees = allEmployees.filter(employee => {
                // Filtrar por módulo
                if (currentFilters.modulo !== 'all' && employee.modulo !== currentFilters.modulo) {
                    return false;
                }
                
                // Filtrar por invernadero
                if (currentFilters.invernadero !== 'all') {
                    if (!employee.invernaderos || !employee.invernaderos.includes(currentFilters.invernadero)) {
                        return false;
                    }
                }
                
                // Filtrar por búsqueda
                if (currentFilters.search) {
                    const searchTerm = currentFilters.search.toLowerCase();
                    const nombreMatch = employee.nombre && employee.nombre.toLowerCase().includes(searchTerm);
                    const codigoMatch = employee.codigo && employee.codigo.toLowerCase().includes(searchTerm);
                    
                    if (!nombreMatch && !codigoMatch) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Actualizar la lista de asistencia
            renderAttendanceList();
            updateCounters();
        }

        // Actualizar la UI de filtros
        function updateFiltersUI() {
            // Actualizar botones de módulo
            document.querySelectorAll('[data-modulo]').forEach(btn => {
                if (btn.dataset.modulo === currentFilters.modulo) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Actualizar botones de invernadero
            document.querySelectorAll('[data-invernadero]').forEach(btn => {
                if (btn.dataset.invernadero === currentFilters.invernadero) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Actualizar etiquetas de filtros activos
            updateActiveFiltersDisplay();
        }

        // Actualizar display de filtros activos
        function updateActiveFiltersDisplay() {
            const activeFiltersContainer = document.getElementById('active-filters');
            activeFiltersContainer.innerHTML = '';
            
            if (currentFilters.modulo === 'all' && currentFilters.invernadero === 'all' && !currentFilters.search) {
                activeFiltersContainer.innerHTML = '<span class="filter-tag">Todos los empleados</span>';
                return;
            }
            
            if (currentFilters.modulo !== 'all') {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = `Módulo: ${currentFilters.modulo}`;
                activeFiltersContainer.appendChild(tag);
            }
            
            if (currentFilters.invernadero !== 'all') {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = `Invernadero: ${currentFilters.invernadero}`;
                activeFiltersContainer.appendChild(tag);
            }
            
            if (currentFilters.search) {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = `Búsqueda: "${currentFilters.search}"`;
                activeFiltersContainer.appendChild(tag);
            }
        }

        // Cargar lista de asistencia
        function loadAttendance() {
            attendanceRef.child(dateId).once('value').then((snapshot) => {
                const savedAttendance = snapshot.val() || {};
                renderAttendanceList(savedAttendance);
            });
        }

        // Renderizar lista de asistencia
        function renderAttendanceList(savedAttendance = {}) {
            const attendanceList = document.getElementById('attendance-list');
            
            if (filteredEmployees.length === 0) {
                attendanceList.innerHTML = '<tr><td colspan="6" class="text-center">No hay empleados que coincidan con los filtros</td></tr>';
                return;
            }
            
            attendanceList.innerHTML = '';
            
            filteredEmployees.forEach(employee => {
                const isPresent = savedAttendance[employee.id] === true;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${employee.nombre || '-'}</td>
                    <td>${employee.codigo || '-'}</td>
                    <td>${employee.puesto || '-'}</td>
                    <td>${employee.modulo || '-'}</td>
                    <td>${employee.invernaderos ? employee.invernaderos.join(', ') : '-'}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm ${isPresent ? 'btn-success' : 'btn-outline-success'} attendance-btn present-btn" data-employee-id="${employee.id}" data-status="true">
                                <i class="fas fa-check"></i> Presente
                            </button>
                            <button type="button" class="btn btn-sm ${!isPresent ? 'btn-danger' : 'btn-outline-danger'} attendance-btn absent-btn" data-employee-id="${employee.id}" data-status="false">
                                <i class="fas fa-times"></i> Ausente
                            </button>
                        </div>
                    </td>
                `;
                
                attendanceList.appendChild(row);
            });
            
            // Añadir event listeners a los botones de asistencia
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.dataset.employeeId;
                    const status = this.dataset.status === 'true';
                    
                    // Actualizar interfaz
                    updateAttendanceUI(employeeId, status);
                    
                    // Actualizar contadores
                    updateCounters();
                });
            });
            
            // Actualizar contadores
            updateCounters();
        }

        // Actualizar la interfaz de asistencia
        function updateAttendanceUI(employeeId, status) {
            // Encontrar los botones para este empleado
            const presentBtn = document.querySelector(`.present-btn[data-employee-id="${employeeId}"]`);
            const absentBtn = document.querySelector(`.absent-btn[data-employee-id="${employeeId}"]`);
            
            // Actualizar clases de los botones
            if (status) {
                presentBtn.classList.remove('btn-outline-success');
                presentBtn.classList.add('btn-success');
                absentBtn.classList.remove('btn-danger');
                absentBtn.classList.add('btn-outline-danger');
            } else {
                presentBtn.classList.remove('btn-success');
                presentBtn.classList.add('btn-outline-success');
                absentBtn.classList.remove('btn-outline-danger');
                absentBtn.classList.add('btn-danger');
            }
        }

        // Marcar todos como presentes
        function markAllPresent() {
            document.querySelectorAll('.present-btn').forEach(btn => {
                const employeeId = btn.dataset.employeeId;
                updateAttendanceUI(employeeId, true);
            });
            updateCounters();
        }

        // Actualizar contadores
        function updateCounters() {
            const total = document.querySelectorAll('.attendance-btn').length / 2; // Cada empleado tiene 2 botones
            const present = document.querySelectorAll('.btn-success').length;
            const absent = total - present;
            
            document.getElementById('total-employees').textContent = total;
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
        }

        // Guardar asistencia en Firebase
        function saveAttendance() {
            const attendanceData = {};
            
            // Recopilar datos de asistencia
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                if (btn.classList.contains('btn-success')) {
                    const employeeId = btn.dataset.employeeId;
                    const status = btn.dataset.status === 'true';
                    attendanceData[employeeId] = status;
                }
            });
            
            // Guardar en Firebase
            attendanceRef.child(dateId).set(attendanceData)
                .then(() => {
                    alert('Asistencia guardada correctamente en Firebase');
                })
                .catch((error) => {
                    console.error('Error al guardar la asistencia:', error);
                    alert('Error al guardar la asistencia. Por favor, intente nuevamente.');
                });
        }
    </script>
</body>
</html>